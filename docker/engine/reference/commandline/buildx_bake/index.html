<h1>docker buildx bake</h1>
   <p><br></p> <p>Build from a file</p> <h2 id="usage">Usage</h2> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake [OPTIONS] [TARGET...]
</pre></div> <p>Refer to the <a href="#options">options section</a> for an overview of available <a href="#options"><code class="language-plaintext highlighter-rouge">OPTIONS</code></a> for this command.</p> <h2 id="description">Description</h2> <p name="extended-description">Bake is a high-level build command. Each specified target will run in parallel as part of the build.</p> <p>Read <a href="https://github.com/docker/buildx#high-level-build-options">High-level build options</a> for introduction.</p> <p>Please note that <code class="language-plaintext highlighter-rouge">buildx bake</code> command may receive backwards incompatible features in the future if needed. We are looking for feedback on improving the command and extending the functionality further.</p> <p>For example uses of this command, refer to the <a href="#examples">examples section</a> below.</p> <h2 id="options">Options</h2> <table> <thead> <tr> <td>Name, shorthand</td> <td>Default</td> <td>Description</td> </tr> </thead> <tbody> <tr> <td>
<a href="#file"><code class="language-plaintext highlighter-rouge">--file</code></a> , <a href="#file"><code class="language-plaintext highlighter-rouge">-f</code></a>
</td> <td></td> <td>Build definition file</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--load</code></td> <td></td> <td>Shorthand for <code class="language-plaintext highlighter-rouge">--set=*.output=type=docker</code>
</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--metadata-file</code></td> <td></td> <td>Write build result metadata to the file</td> </tr> <tr> <td><a href="#no-cache"><code class="language-plaintext highlighter-rouge">--no-cache</code></a></td> <td></td> <td>Do not use cache when building the image</td> </tr> <tr> <td><a href="#print"><code class="language-plaintext highlighter-rouge">--print</code></a></td> <td></td> <td>Print the options without building</td> </tr> <tr> <td><a href="#progress"><code class="language-plaintext highlighter-rouge">--progress</code></a></td> <td><code class="language-plaintext highlighter-rouge">auto</code></td> <td>Set type of progress output (<code class="language-plaintext highlighter-rouge">auto</code>, <code class="language-plaintext highlighter-rouge">plain</code>, <code class="language-plaintext highlighter-rouge">tty</code>). Use plain to show container output</td> </tr> <tr> <td><a href="#pull"><code class="language-plaintext highlighter-rouge">--pull</code></a></td> <td></td> <td>Always attempt to pull all referenced images</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">--push</code></td> <td></td> <td>Shorthand for <code class="language-plaintext highlighter-rouge">--set=*.output=type=registry</code>
</td> </tr> <tr> <td><a href="#set"><code class="language-plaintext highlighter-rouge">--set</code></a></td> <td></td> <td>Override target value (e.g., <code class="language-plaintext highlighter-rouge">targetpattern.key=value</code>)</td> </tr> <tr> <td><a href="#builder"><code class="language-plaintext highlighter-rouge">--builder</code></a></td> <td></td> <td>Override the configured builder instance</td> </tr>  </tbody> </table>  <h2 id="examples">Examples</h2> <h3 id="builder">Override the configured builder instance (--builder)</h3> <p>Same as <a href="../buildx/index#builder"><code class="language-plaintext highlighter-rouge">buildx --builder</code></a>.</p> <h3 id="file">Specify a build definition file (-f, --file)</h3> <p>By default, <code class="language-plaintext highlighter-rouge">buildx bake</code> looks for build definition files in the current directory, the following are parsed:</p> <ul> <li><code class="language-plaintext highlighter-rouge">docker-compose.yml</code></li> <li><code class="language-plaintext highlighter-rouge">docker-compose.yaml</code></li> <li><code class="language-plaintext highlighter-rouge">docker-bake.json</code></li> <li><code class="language-plaintext highlighter-rouge">docker-bake.override.json</code></li> <li><code class="language-plaintext highlighter-rouge">docker-bake.hcl</code></li> <li><code class="language-plaintext highlighter-rouge">docker-bake.override.hcl</code></li> </ul> <p>Use the <code class="language-plaintext highlighter-rouge">-f</code> / <code class="language-plaintext highlighter-rouge">--file</code> option to specify the build definition file to use. The file can be a Docker Compose, JSON or HCL file. If multiple files are specified they are all read and configurations are combined.</p> <p>The following example uses a Docker Compose file named <code class="language-plaintext highlighter-rouge">docker-compose.dev.yaml</code> as build definition file, and builds all targets in the file:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake -f docker-compose.dev.yaml

[+] Building 66.3s (30/30) FINISHED
 =&gt; [frontend internal] load build definition from Dockerfile  0.1s
 =&gt; =&gt; transferring dockerfile: 36B                            0.0s
 =&gt; [backend internal] load build definition from Dockerfile   0.2s
 =&gt; =&gt; transferring dockerfile: 3.73kB                         0.0s
 =&gt; [database internal] load build definition from Dockerfile  0.1s
 =&gt; =&gt; transferring dockerfile: 5.77kB                         0.0s
 ...
</pre></div> <p>Pass the names of the targets to build, to build only specific target(s). The following example builds the <code class="language-plaintext highlighter-rouge">backend</code> and <code class="language-plaintext highlighter-rouge">database</code> targets that are defined in the <code class="language-plaintext highlighter-rouge">docker-compose.dev.yaml</code> file, skipping the build for the <code class="language-plaintext highlighter-rouge">frontend</code> target:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake -f docker-compose.dev.yaml backend database

[+] Building 2.4s (13/13) FINISHED
 =&gt; [backend internal] load build definition from Dockerfile  0.1s
 =&gt; =&gt; transferring dockerfile: 81B                           0.0s
 =&gt; [database internal] load build definition from Dockerfile 0.2s
 =&gt; =&gt; transferring dockerfile: 36B                           0.0s
 =&gt; [backend internal] load .dockerignore                     0.3s
 ...
</pre></div> <p>You can also use a remote <code class="language-plaintext highlighter-rouge">git</code> bake definition:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake "https://github.com/docker/cli.git#v20.10.11" --print
#1 [internal] load git source https://github.com/docker/cli.git#v20.10.11
#1 0.745 e8f1871b077b64bcb4a13334b7146492773769f7       refs/tags/v20.10.11
#1 2.022 From https://github.com/docker/cli
#1 2.022  * [new tag]         v20.10.11  -&gt; v20.10.11
#1 DONE 2.9s
{
  "group": {
    "default": {
      "targets": [
        "binary"
      ]
    }
  },
  "target": {
    "binary": {
      "context": "https://github.com/docker/cli.git#v20.10.11",
      "dockerfile": "Dockerfile",
      "args": {
        "BASE_VARIANT": "alpine",
        "GO_STRIP": "",
        "VERSION": ""
      },
      "target": "binary",
      "platforms": [
        "local"
      ],
      "output": [
        "build"
      ]
    }
  }
}
</pre></div> <p>As you can see the context is fixed to <code class="language-plaintext highlighter-rouge">https://github.com/docker/cli.git</code> even if <a href="https://github.com/docker/cli/blob/2776a6d694f988c0c1df61cad4bfac0f54e481c8/docker-bake.hcl#L17-L26">no context is actually defined</a> in the definition.</p> <p>If you want to access the main context for bake command from a bake file that has been imported remotely, you can use the <code class="language-plaintext highlighter-rouge">BAKE_CMD_CONTEXT</code> builtin var:</p> <div class="highlight"><pre class="highlight" data-language="">$ cat https://raw.githubusercontent.com/tonistiigi/buildx/remote-test/docker-bake.hcl
target "default" {
  context = BAKE_CMD_CONTEXT
  dockerfile-inline = &lt;&lt;EOT
FROM alpine
WORKDIR /src
COPY . .
RUN ls -l &amp;&amp; stop
EOT
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake "https://github.com/tonistiigi/buildx.git#remote-test" --print
{
  "target": {
    "default": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "dockerfile-inline": "FROM alpine\nWORKDIR /src\nCOPY . .\nRUN ls -l \u0026\u0026 stop\n"
    }
  }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ touch foo bar
$ docker buildx bake "https://github.com/tonistiigi/buildx.git#remote-test"
...
 &gt; [4/4] RUN ls -l &amp;&amp; stop:
#8 0.101 total 0
#8 0.102 -rw-r--r--    1 root     root             0 Jul 27 18:47 bar
#8 0.102 -rw-r--r--    1 root     root             0 Jul 27 18:47 foo
#8 0.102 /bin/sh: stop: not found
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake "https://github.com/tonistiigi/buildx.git#remote-test" "https://github.com/docker/cli.git#v20.10.11" --print
#1 [internal] load git source https://github.com/tonistiigi/buildx.git#remote-test
#1 0.429 577303add004dd7efeb13434d69ea030d35f7888       refs/heads/remote-test
#1 CACHED
{
  "target": {
    "default": {
      "context": "https://github.com/docker/cli.git#v20.10.11",
      "dockerfile": "Dockerfile",
      "dockerfile-inline": "FROM alpine\nWORKDIR /src\nCOPY . .\nRUN ls -l \u0026\u0026 stop\n"
    }
  }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake "https://github.com/tonistiigi/buildx.git#remote-test" "https://github.com/docker/cli.git#v20.10.11"
...
 &gt; [4/4] RUN ls -l &amp;&amp; stop:
#8 0.136 drwxrwxrwx    5 root     root          4096 Jul 27 18:31 kubernetes
#8 0.136 drwxrwxrwx    3 root     root          4096 Jul 27 18:31 man
#8 0.136 drwxrwxrwx    2 root     root          4096 Jul 27 18:31 opts
#8 0.136 -rw-rw-rw-    1 root     root          1893 Jul 27 18:31 poule.yml
#8 0.136 drwxrwxrwx    7 root     root          4096 Jul 27 18:31 scripts
#8 0.136 drwxrwxrwx    3 root     root          4096 Jul 27 18:31 service
#8 0.136 drwxrwxrwx    2 root     root          4096 Jul 27 18:31 templates
#8 0.136 drwxrwxrwx   10 root     root          4096 Jul 27 18:31 vendor
#8 0.136 -rwxrwxrwx    1 root     root          9620 Jul 27 18:31 vendor.conf
#8 0.136 /bin/sh: stop: not found
</pre></div> <h3 id="no-cache">Do not use cache when building the image (--no-cache)</h3> <p>Same as <code class="language-plaintext highlighter-rouge">build --no-cache</code>. Do not use cache when building the image.</p> <h3 id="print">Print the options without building (--print)</h3> <p>Prints the resulting options of the targets desired to be built, in a JSON format, without starting a build.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake -f docker-bake.hcl --print db
{
  "group": {
    "default": {
      "targets": [
        "db"
      ]
    }
  },
  "target": {
    "db": {
      "context": "./",
      "dockerfile": "Dockerfile",
      "tags": [
        "docker.io/tiborvass/db"
      ]
    }
  }
}
</pre></div> <h3 id="progress">Set type of progress output (--progress)</h3> <p>Same as <a href="../buildx_build/index#progress"><code class="language-plaintext highlighter-rouge">build --progress</code></a>. Set type of progress output (auto, plain, tty). Use plain to show container output (default “auto”).</p> <blockquote> <p>You can also use the <code class="language-plaintext highlighter-rouge">BUILDKIT_PROGRESS</code> environment variable to set its value.</p> </blockquote> <p>The following example uses <code class="language-plaintext highlighter-rouge">plain</code> output during the build:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --progress=plain

#2 [backend internal] load build definition from Dockerfile.test
#2 sha256:de70cb0bb6ed8044f7b9b1b53b67f624e2ccfb93d96bb48b70c1fba562489618
#2 ...

#1 [database internal] load build definition from Dockerfile.test
#1 sha256:453cb50abd941762900a1212657a35fc4aad107f5d180b0ee9d93d6b74481bce
#1 transferring dockerfile: 36B done
#1 DONE 0.1s
...
</pre></div> <h3 id="pull">Always attempt to pull a newer version of the image (--pull)</h3> <p>Same as <code class="language-plaintext highlighter-rouge">build --pull</code>.</p> <h3 id="set">Override target configurations from command line (--set)</h3> <div class="highlight"><pre class="highlight" data-language="">--set targetpattern.key[.subkey]=value
</pre></div> <p>Override target configurations from command line. The pattern matching syntax is defined in https://golang.org/pkg/path/#Match.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --set target.args.mybuildarg=value
$ docker buildx bake --set target.platform=linux/arm64
$ docker buildx bake --set foo*.args.mybuildarg=value # overrides build arg for all targets starting with 'foo'
$ docker buildx bake --set *.platform=linux/arm64     # overrides platform for all targets
$ docker buildx bake --set foo*.no-cache              # bypass caching only for targets starting with 'foo'
</pre></div> <p>Complete list of overridable fields: <code class="language-plaintext highlighter-rouge">args</code>, <code class="language-plaintext highlighter-rouge">cache-from</code>, <code class="language-plaintext highlighter-rouge">cache-to</code>, <code class="language-plaintext highlighter-rouge">context</code>, <code class="language-plaintext highlighter-rouge">dockerfile</code>, <code class="language-plaintext highlighter-rouge">labels</code>, <code class="language-plaintext highlighter-rouge">no-cache</code>, <code class="language-plaintext highlighter-rouge">output</code>, <code class="language-plaintext highlighter-rouge">platform</code>, <code class="language-plaintext highlighter-rouge">pull</code>, <code class="language-plaintext highlighter-rouge">secrets</code>, <code class="language-plaintext highlighter-rouge">ssh</code>, <code class="language-plaintext highlighter-rouge">tags</code>, <code class="language-plaintext highlighter-rouge">target</code></p> <h3 id="file-definition">File definition</h3> <p>In addition to compose files, bake supports a JSON and an equivalent HCL file format for defining build groups and targets.</p> <p>A target reflects a single docker build invocation with the same options that you would specify for <code class="language-plaintext highlighter-rouge">docker build</code>. A group is a grouping of targets.</p> <p>Multiple files can include the same target and final build options will be determined by merging them together.</p> <p>In the case of compose files, each service corresponds to a target.</p> <p>A group can specify its list of targets with the <code class="language-plaintext highlighter-rouge">targets</code> option. A target can inherit build options by setting the <code class="language-plaintext highlighter-rouge">inherits</code> option to the list of targets or groups to inherit from.</p> <p>Note: Design of bake command is work in progress, the user experience may change based on feedback.</p> <p>HCL definition example:</p> <div class="highlight"><pre class="highlight" data-language="">group "default" {
    targets = ["db", "webapp-dev"]
}

target "webapp-dev" {
    dockerfile = "Dockerfile.webapp"
    tags = ["docker.io/username/webapp"]
}

target "webapp-release" {
    inherits = ["webapp-dev"]
    platforms = ["linux/amd64", "linux/arm64"]
}

target "db" {
    dockerfile = "Dockerfile.db"
    tags = ["docker.io/username/db"]
}
</pre></div> <p>Complete list of valid target fields:</p> <p><code class="language-plaintext highlighter-rouge">args</code>, <code class="language-plaintext highlighter-rouge">cache-from</code>, <code class="language-plaintext highlighter-rouge">cache-to</code>, <code class="language-plaintext highlighter-rouge">context</code>, <code class="language-plaintext highlighter-rouge">contexts</code>, <code class="language-plaintext highlighter-rouge">dockerfile</code>, <code class="language-plaintext highlighter-rouge">inherits</code>, <code class="language-plaintext highlighter-rouge">labels</code>, <code class="language-plaintext highlighter-rouge">no-cache</code>, <code class="language-plaintext highlighter-rouge">no-cache-filter</code>, <code class="language-plaintext highlighter-rouge">output</code>, <code class="language-plaintext highlighter-rouge">platform</code>, <code class="language-plaintext highlighter-rouge">pull</code>, <code class="language-plaintext highlighter-rouge">secrets</code>, <code class="language-plaintext highlighter-rouge">ssh</code>, <code class="language-plaintext highlighter-rouge">tags</code>, <code class="language-plaintext highlighter-rouge">target</code></p> <h3 id="global-scope-attributes">Global scope attributes</h3> <p>You can define global scope attributes in HCL/JSON and use them for code reuse and setting values for variables. This means you can do a “data-only” HCL file with the values you want to set/override and use it in the list of regular output files.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "FOO" {
    default = "abc"
}

target "app" {
    args = {
        v1 = "pre-${FOO}"
    }
}
</pre></div> <p>You can use this file directly:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print app
{
  "group": {
    "default": {
      "targets": [
        "app"
      ]
    }
  },
  "target": {
    "app": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "v1": "pre-abc"
      }
    }
  }
}
</pre></div> <p>Or create an override configuration file:</p> <div class="highlight"><pre class="highlight" data-language=""># env.hcl
WHOAMI="myuser"
FOO="def-${WHOAMI}"
</pre></div> <p>And invoke bake together with both of the files:</p> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake -f docker-bake.hcl -f env.hcl --print app
{
  "group": {
    "default": {
      "targets": [
        "app"
      ]
    }
  },
  "target": {
    "app": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "v1": "pre-def-myuser"
      }
    }
  }
}
</pre></div> <h3 id="hcl-variables-and-functions">HCL variables and functions</h3> <p>Similar to how Terraform provides a way to <a href="https://www.terraform.io/docs/configuration/variables.html#declaring-an-input-variable">define variables</a>, the HCL file format also supports variable block definitions. These can be used to define variables with values provided by the current environment, or a default value when unset.</p> <p>A <a href="https://github.com/docker/buildx/blob/master/bake/hclparser/stdlib.go">set of generally useful functions</a> provided by <a href="https://github.com/zclconf/go-cty/tree/main/cty/function/stdlib">go-cty</a> are available for use in HCL files. In addition, <a href="https://github.com/hashicorp/hcl/tree/main/ext/userfunc">user defined functions</a> are also supported.</p> <h4 id="using-interpolation-to-tag-an-image-with-the-git-sha">Using interpolation to tag an image with the git sha</h4> <p>Bake supports variable blocks which are assigned to matching environment variables or default values.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "TAG" {
    default = "latest"
}

group "default" {
    targets = ["webapp"]
}

target "webapp" {
    tags = ["docker.io/username/webapp:${TAG}"]
}
</pre></div> <p>alternatively, in json format:</p> <div class="highlight"><pre class="highlight" data-language="">{
  "variable": {
    "TAG": {
      "default": "latest"
    }
  }
  "group": {
    "default": {
      "targets": ["webapp"]
    }
  },
  "target": {
    "webapp": {
      "tags": ["docker.io/username/webapp:${TAG}"]
    }
  }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "tags": [
        "docker.io/username/webapp:latest"
      ]
    }
  }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ TAG=$(git rev-parse --short HEAD) docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "tags": [
        "docker.io/username/webapp:985e9e9"
      ]
    }
  }
}
</pre></div> <h4 id="using-the-add-function">Using the <code class="language-plaintext highlighter-rouge">add</code> function</h4> <p>You can use <a href="https://github.com/zclconf/go-cty/tree/main/cty/function/stdlib"><code class="language-plaintext highlighter-rouge">go-cty</code> stdlib functions</a>. Here we are using the <code class="language-plaintext highlighter-rouge">add</code> function.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "TAG" {
    default = "latest"
}

group "default" {
    targets = ["webapp"]
}

target "webapp" {
    args = {
        buildno = "${add(123, 1)}"
    }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "buildno": "124"
      }
    }
  }
}
</pre></div> <h4 id="defining-an-increment-function">Defining an <code class="language-plaintext highlighter-rouge">increment</code> function</h4> <p>It also supports <a href="https://github.com/hashicorp/hcl/tree/main/ext/userfunc">user defined functions</a>. The following example defines a simple an <code class="language-plaintext highlighter-rouge">increment</code> function.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
function "increment" {
    params = [number]
    result = number + 1
}

group "default" {
    targets = ["webapp"]
}

target "webapp" {
    args = {
        buildno = "${increment(123)}"
    }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "buildno": "124"
      }
    }
  }
}
</pre></div> <h4 id="only-adding-tags-if-a-variable-is-not-empty-using-an-notequal">Only adding tags if a variable is not empty using an <code class="language-plaintext highlighter-rouge">notequal</code>
</h4> <p>Here we are using the conditional <code class="language-plaintext highlighter-rouge">notequal</code> function which is just for symmetry with the <code class="language-plaintext highlighter-rouge">equal</code> one.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "TAG" {default="" }

group "default" {
    targets = [
        "webapp",
    ]
}

target "webapp" {
    context="."
    dockerfile="Dockerfile"
    tags = [
        "my-image:latest",
        notequal("",TAG) ? "my-image:${TAG}": "",
    ]
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "tags": [
        "my-image:latest"
      ]
    }
  }
}
</pre></div> <h4 id="using-variables-in-functions">Using variables in functions</h4> <p>You can refer variables to other variables like the target blocks can. Stdlib functions can also be called but user functions can’t at the moment.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "REPO" {
    default = "user/repo"
}

function "tag" {
    params = [tag]
    result = ["${REPO}:${tag}"]
}

target "webapp" {
    tags = tag("v1")
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print webapp
{
  "group": {
    "default": {
      "targets": [
        "webapp"
      ]
    }
  },
  "target": {
    "webapp": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "tags": [
        "user/repo:v1"
      ]
    }
  }
}
</pre></div> <h4 id="using-variables-in-variables-across-files">Using variables in variables across files</h4> <p>When multiple files are specified, one file can use variables defined in another file.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake1.hcl
variable "FOO" {
    default = upper("${BASE}def")
}

variable "BAR" {
    default = "-${FOO}-"
}

target "app" {
    args = {
        v1 = "pre-${BAR}"
    }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language=""># docker-bake2.hcl
variable "BASE" {
    default = "abc"
}

target "app" {
    args = {
        v2 = "${FOO}-post"
    }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake -f docker-bake1.hcl -f docker-bake2.hcl --print app
{
  "group": {
    "default": {
      "targets": [
        "app"
      ]
    }
  },
  "target": {
    "app": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "v1": "pre--ABCDEF-",
        "v2": "ABCDEF-post"
      }
    }
  }
}
</pre></div> <h4 id="using-typed-variables">Using typed variables</h4> <p>Non-string variables are also accepted. The value passed with env is parsed into suitable type first.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
variable "FOO" {
    default = 3
}

variable "IS_FOO" {
    default = true
}

target "app" {
    args = {
        v1 = FOO &gt; 5 ? "higher" : "lower"
        v2 = IS_FOO ? "yes" : "no"
    }
}
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print app
{
  "group": {
    "default": {
      "targets": [
        "app"
      ]
    }
  },
  "target": {
    "app": {
      "context": ".",
      "dockerfile": "Dockerfile",
      "args": {
        "v1": "lower",
        "v2": "yes"
      }
    }
  }
}
</pre></div> <h3 id="defining-additional-build-contexts-and-linking-targets">Defining additional build contexts and linking targets</h3> <p>In addition to the main <code class="language-plaintext highlighter-rouge">context</code> key that defines the build context each target can also define additional named contexts with a map defined with key <code class="language-plaintext highlighter-rouge">contexts</code>. These values map to the <code class="language-plaintext highlighter-rouge">--build-context</code> flag in the <a href="../buildx_build/index#build-context">build command</a>.</p> <p>Inside the Dockerfile these contexts can be used with the <code class="language-plaintext highlighter-rouge">FROM</code> instruction or <code class="language-plaintext highlighter-rouge">--from</code> flag.</p> <p>The value can be a local source directory, container image (with docker-image:// prefix), Git URL, HTTP URL or a name of another target in the Bake file (with target: prefix).</p> <h4 id="pinning-alpine-image">Pinning alpine image</h4> <div class="highlight"><pre class="highlight" data-language=""># Dockerfile
FROM alpine
RUN echo "Hello world"
</pre></div> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
target "app" {
    contexts = {
        alpine = "docker-image://alpine:3.13"
    }
}
</pre></div> <h4 id="using-a-secondary-source-directory">Using a secondary source directory</h4> <div class="highlight"><pre class="highlight" data-language=""># Dockerfile

FROM scratch AS src

FROM golang
COPY --from=src . .
</pre></div> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl
target "app" {
    contexts = {
        src = "../path/to/source"
    }
}
</pre></div> <h4 id="using-a-result-of-one-target-as-a-base-image-in-another-target">Using a result of one target as a base image in another target</h4> <p>To use a result of one target as a build context of another, specity the target name with <code class="language-plaintext highlighter-rouge">target:</code> prefix.</p> <div class="highlight"><pre class="highlight" data-language=""># Dockerfile
FROM baseapp
RUN echo "Hello world"
</pre></div> <div class="highlight"><pre class="highlight" data-language=""># docker-bake.hcl

target "base" {
    dockerfile = "baseapp.Dockerfile"
}

target "app" {
    contexts = {
        baseapp = "target:base"
    }
}
</pre></div> <p>Please note that in most cases you should just use a single multi-stage Dockerfile with multiple targets for similar behavior. This case is recommended when you have multiple Dockerfiles that can’t be easily merged into one.</p> <h3 id="extension-field-with-compose">Extension field with Compose</h3> <p><a href="https://github.com/compose-spec/compose-spec/blob/master/spec/#extension">Special extension</a> field <code class="language-plaintext highlighter-rouge">x-bake</code> can be used in your compose file to evaluate fields that are not (yet) available in the <a href="https://github.com/compose-spec/compose-spec/blob/master/build/#build-definition">build definition</a>.</p> <div class="highlight"><pre class="highlight" data-language=""># docker-compose.yml
services:
  addon:
    image: ct-addon:bar
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        CT_ECR: foo
        CT_TAG: bar
      x-bake:
        tags:
          - ct-addon:foo
          - ct-addon:alp
        platforms:
          - linux/amd64
          - linux/arm64
        cache-from:
          - user/app:cache
          - type=local,src=path/to/cache
        cache-to: type=local,dest=path/to/cache
        pull: true

  aws:
    image: ct-fake-aws:bar
    build:
      dockerfile: ./aws.Dockerfile
      args:
        CT_ECR: foo
        CT_TAG: bar
      x-bake:
        secret:
          - id=mysecret,src=./secret
          - id=mysecret2,src=./secret2
        platforms: linux/arm64
        output: type=docker
        no-cache: true
</pre></div> <div class="highlight"><pre class="highlight" data-language="">$ docker buildx bake --print
{
  "group": {
    "default": {
      "targets": [
        "aws",
        "addon"
      ]
    }
  },
  "target": {
    "addon": {
      "context": ".",
      "dockerfile": "./Dockerfile",
      "args": {
        "CT_ECR": "foo",
        "CT_TAG": "bar"
      },
      "tags": [
        "ct-addon:foo",
        "ct-addon:alp"
      ],
      "cache-from": [
        "user/app:cache",
        "type=local,src=path/to/cache"
      ],
      "cache-to": [
        "type=local,dest=path/to/cache"
      ],
      "platforms": [
        "linux/amd64",
        "linux/arm64"
      ],
      "pull": true
    },
    "aws": {
      "context": ".",
      "dockerfile": "./aws.Dockerfile",
      "args": {
        "CT_ECR": "foo",
        "CT_TAG": "bar"
      },
      "tags": [
        "ct-fake-aws:bar"
      ],
      "secret": [
        "id=mysecret,src=./secret",
        "id=mysecret2,src=./secret2"
      ],
      "platforms": [
        "linux/arm64"
      ],
      "output": [
        "type=docker"
      ],
      "no-cache": true
    }
  }
}
</pre></div> <p>Complete list of valid fields for <code class="language-plaintext highlighter-rouge">x-bake</code>:</p> <p><code class="language-plaintext highlighter-rouge">tags</code>, <code class="language-plaintext highlighter-rouge">cache-from</code>, <code class="language-plaintext highlighter-rouge">cache-to</code>, <code class="language-plaintext highlighter-rouge">secret</code>, <code class="language-plaintext highlighter-rouge">ssh</code>, <code class="language-plaintext highlighter-rouge">platforms</code>, <code class="language-plaintext highlighter-rouge">output</code>, <code class="language-plaintext highlighter-rouge">pull</code>, <code class="language-plaintext highlighter-rouge">no-cache</code>, <code class="language-plaintext highlighter-rouge">no-cache-filter</code></p> <h3 id="built-in-variables">Built-in variables</h3> <ul> <li>
<code class="language-plaintext highlighter-rouge">BAKE_CMD_CONTEXT</code> can be used to access the main <code class="language-plaintext highlighter-rouge">context</code> for bake command from a bake file that has been <a href="#file">imported remotely</a>.</li> <li>
<code class="language-plaintext highlighter-rouge">BAKE_LOCAL_PLATFORM</code> returns the current platform’s default platform specification (e.g. <code class="language-plaintext highlighter-rouge">linux/amd64</code>).</li> </ul> <h2 id="parent-command">Parent command</h2> <table> <thead> <tr> <th style="text-align: left">Command</th> <th style="text-align: left">Description</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><a href="../buildx/index">docker buildx</a></td> <td style="text-align: left">Docker Buildx</td> </tr> </tbody> </table> <h2 id="related-commands">Related commands</h2> <table> <thead> <tr> <td>Command</td> <td>Description</td> </tr> </thead> <tbody> <tr> <td><a href="index">docker buildx bake</a></td> <td>Build from a file</td> </tr> <tr> <td><a href="../buildx_build/index">docker buildx build</a></td> <td>Start a build</td> </tr> <tr> <td><a href="../buildx_create/index">docker buildx create</a></td> <td>Create a new builder instance</td> </tr> <tr> <td><a href="../buildx_du/index">docker buildx du</a></td> <td>Disk usage</td> </tr> <tr> <td><a href="../buildx_imagetools/index">docker buildx imagetools</a></td> <td>Commands to work on images in registry</td> </tr> <tr> <td><a href="../buildx_inspect/index">docker buildx inspect</a></td> <td>Inspect current builder instance</td> </tr> <tr> <td><a href="../buildx_ls/index">docker buildx ls</a></td> <td>List builder instances</td> </tr> <tr> <td><a href="../buildx_prune/index">docker buildx prune</a></td> <td>Remove build cache</td> </tr> <tr> <td><a href="../buildx_rm/index">docker buildx rm</a></td> <td>Remove a builder instance</td> </tr> <tr> <td><a href="../buildx_stop/index">docker buildx stop</a></td> <td>Stop builder instance</td> </tr> <tr> <td><a href="../buildx_use/index">docker buildx use</a></td> <td>Set the current builder instance</td> </tr> <tr> <td><a href="../buildx_version/index">docker buildx version</a></td> <td>Show buildx version information</td> </tr> </tbody> </table> <div class="_attribution">
  <p class="_attribution-p">
    <a href="https://docs.docker.com/engine/reference/commandline/buildx_bake/" class="_attribution-link" target="_blank">https://docs.docker.com/engine/reference/commandline/buildx_bake/</a>
  </p>
</div>
