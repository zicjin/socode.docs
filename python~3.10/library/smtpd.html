<h1 id="smtpd-smtp-server">smtpd — SMTP Server</h1> <p id="module-smtpd"><strong>Source code:</strong> <a class="reference external" href="https://github.com/python/cpython/tree/3.10/Lib/smtpd.py">Lib/smtpd.py</a></p>  <p>This module offers several classes to implement SMTP (email) servers.</p> <div class="deprecated"> <p><span class="versionmodified deprecated">Deprecated since version 3.6: </span>The <a class="reference external" href="https://aiosmtpd.readthedocs.io/">aiosmtpd</a> package is a recommended replacement for this module. It is based on <a class="reference internal" href="asyncio#module-asyncio" title="asyncio: Asynchronous I/O."><code>asyncio</code></a> and provides a more straightforward API.</p> </div> <p>Several server implementations are present; one is a generic do-nothing implementation, which can be overridden, while the other two offer specific mail-sending strategies.</p> <p>Additionally the SMTPChannel may be extended to implement very specific interaction behaviour with SMTP clients.</p> <p>The code supports <a class="rfc reference external" href="https://tools.ietf.org/html/rfc5321.html" id="index-0"><strong>RFC 5321</strong></a>, plus the <a class="rfc reference external" href="https://tools.ietf.org/html/rfc1870.html" id="index-1"><strong>RFC 1870</strong></a> SIZE and <a class="rfc reference external" href="https://tools.ietf.org/html/rfc6531.html" id="index-2"><strong>RFC 6531</strong></a> SMTPUTF8 extensions.</p>  <h2 id="smtpserver-objects">SMTPServer Objects</h2> <dl class="py class"> <dt id="smtpd.SMTPServer">
<code>class smtpd.SMTPServer(localaddr, remoteaddr, data_size_limit=33554432, map=None, enable_SMTPUTF8=False, decode_data=False)</code> </dt> <dd>
<p>Create a new <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a> object, which binds to local address <em>localaddr</em>. It will treat <em>remoteaddr</em> as an upstream SMTP relayer. Both <em>localaddr</em> and <em>remoteaddr</em> should be a <a class="reference internal" href="socket#host-port"><span class="std std-ref">(host, port)</span></a> tuple. The object inherits from <a class="reference internal" href="asyncore#asyncore.dispatcher" title="asyncore.dispatcher"><code>asyncore.dispatcher</code></a>, and so will insert itself into <a class="reference internal" href="asyncore#module-asyncore" title="asyncore: A base class for developing asynchronous socket handling services."><code>asyncore</code></a>’s event loop on instantiation.</p> <p><em>data_size_limit</em> specifies the maximum number of bytes that will be accepted in a <code>DATA</code> command. A value of <code>None</code> or <code>0</code> means no limit.</p> <p><em>map</em> is the socket map to use for connections (an initially empty dictionary is a suitable value). If not specified the <a class="reference internal" href="asyncore#module-asyncore" title="asyncore: A base class for developing asynchronous socket handling services."><code>asyncore</code></a> global socket map is used.</p> <p><em>enable_SMTPUTF8</em> determines whether the <code>SMTPUTF8</code> extension (as defined in <a class="rfc reference external" href="https://tools.ietf.org/html/rfc6531.html" id="index-3"><strong>RFC 6531</strong></a>) should be enabled. The default is <code>False</code>. When <code>True</code>, <code>SMTPUTF8</code> is accepted as a parameter to the <code>MAIL</code> command and when present is passed to <a class="reference internal" href="#smtpd.SMTPServer.process_message" title="smtpd.SMTPServer.process_message"><code>process_message()</code></a> in the <code>kwargs['mail_options']</code> list. <em>decode_data</em> and <em>enable_SMTPUTF8</em> cannot be set to <code>True</code> at the same time.</p> <p><em>decode_data</em> specifies whether the data portion of the SMTP transaction should be decoded using UTF-8. When <em>decode_data</em> is <code>False</code> (the default), the server advertises the <code>8BITMIME</code> extension (<a class="rfc reference external" href="https://tools.ietf.org/html/rfc6152.html" id="index-4"><strong>RFC 6152</strong></a>), accepts the <code>BODY=8BITMIME</code> parameter to the <code>MAIL</code> command, and when present passes it to <a class="reference internal" href="#smtpd.SMTPServer.process_message" title="smtpd.SMTPServer.process_message"><code>process_message()</code></a> in the <code>kwargs['mail_options']</code> list. <em>decode_data</em> and <em>enable_SMTPUTF8</em> cannot be set to <code>True</code> at the same time.</p> <dl class="py method"> <dt id="smtpd.SMTPServer.process_message">
<code>process_message(peer, mailfrom, rcpttos, data, **kwargs)</code> </dt> <dd>
<p>Raise a <a class="reference internal" href="exceptions#NotImplementedError" title="NotImplementedError"><code>NotImplementedError</code></a> exception. Override this in subclasses to do something useful with this message. Whatever was passed in the constructor as <em>remoteaddr</em> will be available as the <code>_remoteaddr</code> attribute. <em>peer</em> is the remote host’s address, <em>mailfrom</em> is the envelope originator, <em>rcpttos</em> are the envelope recipients and <em>data</em> is a string containing the contents of the e-mail (which should be in <a class="rfc reference external" href="https://tools.ietf.org/html/rfc5321.html" id="index-5"><strong>RFC 5321</strong></a> format).</p> <p>If the <em>decode_data</em> constructor keyword is set to <code>True</code>, the <em>data</em> argument will be a unicode string. If it is set to <code>False</code>, it will be a bytes object.</p> <p><em>kwargs</em> is a dictionary containing additional information. It is empty if <code>decode_data=True</code> was given as an init argument, otherwise it contains the following keys:</p>  <dl class="simple"> <dt>
<em>mail_options</em>:</dt>
<dd>
<p>a list of all received parameters to the <code>MAIL</code> command (the elements are uppercase strings; example: <code>['BODY=8BITMIME', 'SMTPUTF8']</code>).</p> </dd> <dt>
<em>rcpt_options</em>:</dt>
<dd>
<p>same as <em>mail_options</em> but for the <code>RCPT</code> command. Currently no <code>RCPT TO</code> options are supported, so for now this will always be an empty list.</p> </dd> </dl>  <p>Implementations of <code>process_message</code> should use the <code>**kwargs</code> signature to accept arbitrary keyword arguments, since future feature enhancements may add keys to the kwargs dictionary.</p> <p>Return <code>None</code> to request a normal <code>250 Ok</code> response; otherwise return the desired response string in <a class="rfc reference external" href="https://tools.ietf.org/html/rfc5321.html" id="index-6"><strong>RFC 5321</strong></a> format.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPServer.channel_class">
<code>channel_class</code> </dt> <dd>
<p>Override this in subclasses to use a custom <a class="reference internal" href="#smtpd.SMTPChannel" title="smtpd.SMTPChannel"><code>SMTPChannel</code></a> for managing SMTP clients.</p> </dd>
</dl> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.4: </span>The <em>map</em> constructor argument.</p> </div> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 3.5: </span><em>localaddr</em> and <em>remoteaddr</em> may now contain IPv6 addresses.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.5: </span>The <em>decode_data</em> and <em>enable_SMTPUTF8</em> constructor parameters, and the <em>kwargs</em> parameter to <a class="reference internal" href="#smtpd.SMTPServer.process_message" title="smtpd.SMTPServer.process_message"><code>process_message()</code></a> when <em>decode_data</em> is <code>False</code>.</p> </div> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 3.6: </span><em>decode_data</em> is now <code>False</code> by default.</p> </div> </dd>
</dl>   <h2 id="debuggingserver-objects">DebuggingServer Objects</h2> <dl class="py class"> <dt id="smtpd.DebuggingServer">
<code>class smtpd.DebuggingServer(localaddr, remoteaddr)</code> </dt> <dd>
<p>Create a new debugging server. Arguments are as per <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a>. Messages will be discarded, and printed on stdout.</p> </dd>
</dl>   <h2 id="pureproxy-objects">PureProxy Objects</h2> <dl class="py class"> <dt id="smtpd.PureProxy">
<code>class smtpd.PureProxy(localaddr, remoteaddr)</code> </dt> <dd>
<p>Create a new pure proxy server. Arguments are as per <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a>. Everything will be relayed to <em>remoteaddr</em>. Note that running this has a good chance to make you into an open relay, so please be careful.</p> </dd>
</dl>   <h2 id="mailmanproxy-objects">MailmanProxy Objects</h2> <dl class="py class"> <dt id="smtpd.MailmanProxy">
<code>class smtpd.MailmanProxy(localaddr, remoteaddr)</code> </dt> <dd>
<div class="deprecated-removed"> <p><span class="versionmodified">Deprecated since version 3.9, will be removed in version 3.11: </span><a class="reference internal" href="#smtpd.MailmanProxy" title="smtpd.MailmanProxy"><code>MailmanProxy</code></a> is deprecated, it depends on a <code>Mailman</code> module which no longer exists and therefore is already broken.</p> </div> <p>Create a new pure proxy server. Arguments are as per <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a>. Everything will be relayed to <em>remoteaddr</em>, unless local mailman configurations knows about an address, in which case it will be handled via mailman. Note that running this has a good chance to make you into an open relay, so please be careful.</p> </dd>
</dl>   <h2 id="smtpchannel-objects">SMTPChannel Objects</h2> <dl class="py class"> <dt id="smtpd.SMTPChannel">
<code>class smtpd.SMTPChannel(server, conn, addr, data_size_limit=33554432, map=None, enable_SMTPUTF8=False, decode_data=False)</code> </dt> <dd>
<p>Create a new <a class="reference internal" href="#smtpd.SMTPChannel" title="smtpd.SMTPChannel"><code>SMTPChannel</code></a> object which manages the communication between the server and a single SMTP client.</p> <p><em>conn</em> and <em>addr</em> are as per the instance variables described below.</p> <p><em>data_size_limit</em> specifies the maximum number of bytes that will be accepted in a <code>DATA</code> command. A value of <code>None</code> or <code>0</code> means no limit.</p> <p><em>enable_SMTPUTF8</em> determines whether the <code>SMTPUTF8</code> extension (as defined in <a class="rfc reference external" href="https://tools.ietf.org/html/rfc6531.html" id="index-7"><strong>RFC 6531</strong></a>) should be enabled. The default is <code>False</code>. <em>decode_data</em> and <em>enable_SMTPUTF8</em> cannot be set to <code>True</code> at the same time.</p> <p>A dictionary can be specified in <em>map</em> to avoid using a global socket map.</p> <p><em>decode_data</em> specifies whether the data portion of the SMTP transaction should be decoded using UTF-8. The default is <code>False</code>. <em>decode_data</em> and <em>enable_SMTPUTF8</em> cannot be set to <code>True</code> at the same time.</p> <p>To use a custom SMTPChannel implementation you need to override the <a class="reference internal" href="#smtpd.SMTPServer.channel_class" title="smtpd.SMTPServer.channel_class"><code>SMTPServer.channel_class</code></a> of your <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a>.</p> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 3.5: </span>The <em>decode_data</em> and <em>enable_SMTPUTF8</em> parameters were added.</p> </div> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 3.6: </span><em>decode_data</em> is now <code>False</code> by default.</p> </div> <p>The <a class="reference internal" href="#smtpd.SMTPChannel" title="smtpd.SMTPChannel"><code>SMTPChannel</code></a> has the following instance variables:</p> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.smtp_server">
<code>smtp_server</code> </dt> <dd>
<p>Holds the <a class="reference internal" href="#smtpd.SMTPServer" title="smtpd.SMTPServer"><code>SMTPServer</code></a> that spawned this channel.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.conn">
<code>conn</code> </dt> <dd>
<p>Holds the socket object connecting to the client.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.addr">
<code>addr</code> </dt> <dd>
<p>Holds the address of the client, the second value returned by <a class="reference internal" href="socket#socket.socket.accept" title="socket.socket.accept"><code>socket.accept</code></a></p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.received_lines">
<code>received_lines</code> </dt> <dd>
<p>Holds a list of the line strings (decoded using UTF-8) received from the client. The lines have their <code>"\r\n"</code> line ending translated to <code>"\n"</code>.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.smtp_state">
<code>smtp_state</code> </dt> <dd>
<p>Holds the current state of the channel. This will be either <code>COMMAND</code> initially and then <code>DATA</code> after the client sends a “DATA” line.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.seen_greeting">
<code>seen_greeting</code> </dt> <dd>
<p>Holds a string containing the greeting sent by the client in its “HELO”.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.mailfrom">
<code>mailfrom</code> </dt> <dd>
<p>Holds a string containing the address identified in the “MAIL FROM:” line from the client.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.rcpttos">
<code>rcpttos</code> </dt> <dd>
<p>Holds a list of strings containing the addresses identified in the “RCPT TO:” lines from the client.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.received_data">
<code>received_data</code> </dt> <dd>
<p>Holds a string containing all of the data sent by the client during the DATA state, up to but not including the terminating <code>"\r\n.\r\n"</code>.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.fqdn">
<code>fqdn</code> </dt> <dd>
<p>Holds the fully-qualified domain name of the server as returned by <a class="reference internal" href="socket#socket.getfqdn" title="socket.getfqdn"><code>socket.getfqdn()</code></a>.</p> </dd>
</dl> <dl class="py attribute"> <dt id="smtpd.SMTPChannel.peer">
<code>peer</code> </dt> <dd>
<p>Holds the name of the client peer as returned by <code>conn.getpeername()</code> where <code>conn</code> is <a class="reference internal" href="#smtpd.SMTPChannel.conn" title="smtpd.SMTPChannel.conn"><code>conn</code></a>.</p> </dd>
</dl> <p>The <a class="reference internal" href="#smtpd.SMTPChannel" title="smtpd.SMTPChannel"><code>SMTPChannel</code></a> operates by invoking methods named <code>smtp_&lt;command&gt;</code> upon reception of a command line from the client. Built into the base <a class="reference internal" href="#smtpd.SMTPChannel" title="smtpd.SMTPChannel"><code>SMTPChannel</code></a> class are methods for handling the following commands (and responding to them appropriately):</p> <table class="docutils align-default">  <thead> <tr>
<th class="head"><p>Command</p></th> <th class="head"><p>Action taken</p></th> </tr> </thead>  <tr>
<td><p>HELO</p></td> <td><p>Accepts the greeting from the client and stores it in <a class="reference internal" href="#smtpd.SMTPChannel.seen_greeting" title="smtpd.SMTPChannel.seen_greeting"><code>seen_greeting</code></a>. Sets server to base command mode.</p></td> </tr> <tr>
<td><p>EHLO</p></td> <td><p>Accepts the greeting from the client and stores it in <a class="reference internal" href="#smtpd.SMTPChannel.seen_greeting" title="smtpd.SMTPChannel.seen_greeting"><code>seen_greeting</code></a>. Sets server to extended command mode.</p></td> </tr> <tr>
<td><p>NOOP</p></td> <td><p>Takes no action.</p></td> </tr> <tr>
<td><p>QUIT</p></td> <td><p>Closes the connection cleanly.</p></td> </tr> <tr>
<td><p>MAIL</p></td> <td><p>Accepts the “MAIL FROM:” syntax and stores the supplied address as <a class="reference internal" href="#smtpd.SMTPChannel.mailfrom" title="smtpd.SMTPChannel.mailfrom"><code>mailfrom</code></a>. In extended command mode, accepts the <a class="rfc reference external" href="https://tools.ietf.org/html/rfc1870.html" id="index-8"><strong>RFC 1870</strong></a> SIZE attribute and responds appropriately based on the value of <em>data_size_limit</em>.</p></td> </tr> <tr>
<td><p>RCPT</p></td> <td><p>Accepts the “RCPT TO:” syntax and stores the supplied addresses in the <a class="reference internal" href="#smtpd.SMTPChannel.rcpttos" title="smtpd.SMTPChannel.rcpttos"><code>rcpttos</code></a> list.</p></td> </tr> <tr>
<td><p>RSET</p></td> <td><p>Resets the <a class="reference internal" href="#smtpd.SMTPChannel.mailfrom" title="smtpd.SMTPChannel.mailfrom"><code>mailfrom</code></a>, <a class="reference internal" href="#smtpd.SMTPChannel.rcpttos" title="smtpd.SMTPChannel.rcpttos"><code>rcpttos</code></a>, and <a class="reference internal" href="#smtpd.SMTPChannel.received_data" title="smtpd.SMTPChannel.received_data"><code>received_data</code></a>, but not the greeting.</p></td> </tr> <tr>
<td><p>DATA</p></td> <td><p>Sets the internal state to <code>DATA</code> and stores remaining lines from the client in <a class="reference internal" href="#smtpd.SMTPChannel.received_data" title="smtpd.SMTPChannel.received_data"><code>received_data</code></a> until the terminator <code>"\r\n.\r\n"</code> is received.</p></td> </tr> <tr>
<td><p>HELP</p></td> <td><p>Returns minimal information on command syntax</p></td> </tr> <tr>
<td><p>VRFY</p></td> <td><p>Returns code 252 (the server doesn’t know if the address is valid)</p></td> </tr> <tr>
<td><p>EXPN</p></td> <td><p>Reports that the command is not implemented.</p></td> </tr>  </table> </dd>
</dl>   <div class="_attribution">
  <p class="_attribution-p">
    &copy; 2001&ndash;2021 Python Software Foundation<br>Licensed under the PSF License.<br>
    <a href="https://docs.python.org/3.10/library/smtpd.html" class="_attribution-link">https://docs.python.org/3.10/library/smtpd.html</a>
  </p>
</div>
