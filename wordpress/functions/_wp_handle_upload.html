<h1>_wp_handle_upload( array $file, array|false $overrides, string $time, string $action )</h1> <div class="callout callout-alert">
<p> This functionâ€™s access is marked private. This means it is not intended for use by plugin or theme developers, only in other core functions. It is listed here for completeness. Use <a href="wp_handle_upload_error">wp_handle_upload_error</a> instead.</p> </div>  <section> <p>Handles PHP uploads in WordPress.</p> </section> <div class="content-toc">  <section> <h2 id="description">Description</h2> <p>Sanitizes file names, checks extensions for mime type, and moves the file to the appropriate directory within the uploads directory.</p> <h3 id="see-also">See also</h3> <ul> <li><a href="wp_handle_upload_error">wp_handle_upload_error</a></li> </ul> </section>  <section> <h2 id="parameters">Parameters</h2> <dl> <dt>$file</dt> <dd> <p class="desc"> <span class="type">(<span class="array">array</span>)</span> <span class="required">(Required)</span> <span class="description">Reference to a single element from <code>$_FILES</code>. Call the function once for each uploaded file. <ul class="param-hash">
<li>
<b>'name'</b><br><i><span class="type">(string)</span></i> The original name of the file on the client machine.</li> <li>
<b>'type'</b><br><i><span class="type">(string)</span></i> The mime type of the file, if the browser provided this information.</li> <li>
<b>'tmp_name'</b><br><i><span class="type">(string)</span></i> The temporary filename of the file in which the uploaded file was stored on the server.</li> <li>
<b>'size'</b><br><i><span class="type">(int)</span></i> The size, in bytes, of the uploaded file.</li> <li>
<b>'error'</b><br><i><span class="type">(int)</span></i> The error code associated with this file upload.</li> </ul> </span> </p> </dd> <dt>$overrides</dt> <dd> <p class="desc"> <span class="type">(<span class="array">array</span>|<span class="false">false</span>)</span> <span class="required">(Required)</span> <span class="description">An array of override parameters for this file, or boolean false if none are provided. <ul class="param-hash">
<li>
<b>'upload_error_handler'</b><br><i><span class="type">(callable)</span></i> Function to call when there is an error during the upload process. @see <a href="wp_handle_upload_error">wp_handle_upload_error()</a>.</li> <li>
<b>'unique_filename_callback'</b><br><i><span class="type">(callable)</span></i> Function to call when determining a unique file name for the file. @see <a href="wp_unique_filename">wp_unique_filename()</a>.</li> <li>
<b>'upload_error_strings'</b><br><i><span class="type">(string[])</span></i> The strings that describe the error indicated in <code>$_FILES[{form field}]['error']</code>.</li> <li>
<b>'test_form'</b><br><i><span class="type">(bool)</span></i> Whether to test that the <code>$_POST['action']</code> parameter is as expected.</li> <li>
<b>'test_size'</b><br><i><span class="type">(bool)</span></i> Whether to test that the file size is greater than zero bytes.</li> <li>
<b>'test_type'</b><br><i><span class="type">(bool)</span></i> Whether to test that the mime type of the file is as expected.</li> <li>
<b>'mimes'</b><br><i><span class="type">(string[])</span></i> Array of allowed mime types keyed by their file extension regex.</li> </ul> </span> </p> </dd> <dt>$time</dt> <dd> <p class="desc"> <span class="type">(<span class="string">string</span>)</span> <span class="required">(Required)</span> <span class="description">Time formatted in 'yyyy/mm'.</span> </p> </dd> <dt>$action</dt> <dd> <p class="desc"> <span class="type">(<span class="string">string</span>)</span> <span class="required">(Required)</span> <span class="description">Expected value for <code>$_POST['action']</code>.</span> </p> </dd> </dl> </section>  <section> <h2 id="return">Return</h2> <p><span class="return-type">(array)</span> On success, returns an associative array of file attributes. On failure, returns <code>$overrides['upload_error_handler']( &amp;$file, $message )</code> or <code>array( 'error' =&gt; $message )</code>. </p>
<ul class="param-hash">
<li>
<b>'file'</b><br><i><span class="type">(string)</span></i> Filename of the newly-uploaded file.</li> <li>
<b>'url'</b><br><i><span class="type">(string)</span></i> URL of the newly-uploaded file.</li> <li>
<b>'type'</b><br><i><span class="type">(string)</span></i> Mime type of the newly-uploaded file.</li> </ul> </section>  <section> <h2 id="source">Source</h2> <p> File: <a href="https://developer.wordpress.org/reference/files/wp-admin/includes/file.php/">wp-admin/includes/file.php</a> </p> <pre data-language="php">function _wp_handle_upload( &amp;$file, $overrides, $time, $action ) {
	// The default error handler.
	if ( ! function_exists( 'wp_handle_upload_error' ) ) {
		function wp_handle_upload_error( &amp;$file, $message ) {
			return array( 'error' =&gt; $message );
		}
	}

	/**
	 * Filters the data for a file before it is uploaded to WordPress.
	 *
	 * The dynamic portion of the hook name, `$action`, refers to the post action.
	 *
	 * Possible hook names include:
	 *
	 *  - `wp_handle_sideload_prefilter`
	 *  - `wp_handle_upload_prefilter`
	 *
	 * @since 2.9.0 as 'wp_handle_upload_prefilter'.
	 * @since 4.0.0 Converted to a dynamic hook with `$action`.
	 *
	 * @param array $file {
	 *     Reference to a single element from `$_FILES`.
	 *
	 *     @type string $name     The original name of the file on the client machine.
	 *     @type string $type     The mime type of the file, if the browser provided this information.
	 *     @type string $tmp_name The temporary filename of the file in which the uploaded file was stored on the server.
	 *     @type int    $size     The size, in bytes, of the uploaded file.
	 *     @type int    $error    The error code associated with this file upload.
	 * }
	 */
	$file = apply_filters( "{$action}_prefilter", $file );

	/**
	 * Filters the override parameters for a file before it is uploaded to WordPress.
	 *
	 * The dynamic portion of the hook name, `$action`, refers to the post action.
	 *
	 * Possible hook names include:
	 *
	 *  - `wp_handle_sideload_overrides`
	 *  - `wp_handle_upload_overrides`
	 *
	 * @since 5.7.0
	 *
	 * @param array|false $overrides An array of override parameters for this file. Boolean false if none are
	 *                               provided. @see _wp_handle_upload().
	 * @param array       $file      {
	 *     Reference to a single element from `$_FILES`.
	 *
	 *     @type string $name     The original name of the file on the client machine.
	 *     @type string $type     The mime type of the file, if the browser provided this information.
	 *     @type string $tmp_name The temporary filename of the file in which the uploaded file was stored on the server.
	 *     @type int    $size     The size, in bytes, of the uploaded file.
	 *     @type int    $error    The error code associated with this file upload.
	 * }
	 */
	$overrides = apply_filters( "{$action}_overrides", $overrides, $file );

	// You may define your own function and pass the name in $overrides['upload_error_handler'].
	$upload_error_handler = 'wp_handle_upload_error';
	if ( isset( $overrides['upload_error_handler'] ) ) {
		$upload_error_handler = $overrides['upload_error_handler'];
	}

	// You may have had one or more 'wp_handle_upload_prefilter' functions error out the file. Handle that gracefully.
	if ( isset( $file['error'] ) &amp;&amp; ! is_numeric( $file['error'] ) &amp;&amp; $file['error'] ) {
		return call_user_func_array( $upload_error_handler, array( &amp;$file, $file['error'] ) );
	}

	// Install user overrides. Did we mention that this voids your warranty?

	// You may define your own function and pass the name in $overrides['unique_filename_callback'].
	$unique_filename_callback = null;
	if ( isset( $overrides['unique_filename_callback'] ) ) {
		$unique_filename_callback = $overrides['unique_filename_callback'];
	}

	/*
	 * This may not have originally been intended to be overridable,
	 * but historically has been.
	 */
	if ( isset( $overrides['upload_error_strings'] ) ) {
		$upload_error_strings = $overrides['upload_error_strings'];
	} else {
		// Courtesy of php.net, the strings that describe the error indicated in $_FILES[{form field}]['error'].
		$upload_error_strings = array(
			false,
			sprintf(
				/* translators: 1: upload_max_filesize, 2: php.ini */
				__( 'The uploaded file exceeds the %1$s directive in %2$s.' ),
				'upload_max_filesize',
				'php.ini'
			),
			sprintf(
				/* translators: %s: MAX_FILE_SIZE */
				__( 'The uploaded file exceeds the %s directive that was specified in the HTML form.' ),
				'MAX_FILE_SIZE'
			),
			__( 'The uploaded file was only partially uploaded.' ),
			__( 'No file was uploaded.' ),
			'',
			__( 'Missing a temporary folder.' ),
			__( 'Failed to write file to disk.' ),
			__( 'File upload stopped by extension.' ),
		);
	}

	// All tests are on by default. Most can be turned off by $overrides[{test_name}] = false;
	$test_form = isset( $overrides['test_form'] ) ? $overrides['test_form'] : true;
	$test_size = isset( $overrides['test_size'] ) ? $overrides['test_size'] : true;

	// If you override this, you must provide $ext and $type!!
	$test_type = isset( $overrides['test_type'] ) ? $overrides['test_type'] : true;
	$mimes     = isset( $overrides['mimes'] ) ? $overrides['mimes'] : false;

	// A correct form post will pass this test.
	if ( $test_form &amp;&amp; ( ! isset( $_POST['action'] ) || $_POST['action'] !== $action ) ) {
		return call_user_func_array( $upload_error_handler, array( &amp;$file, __( 'Invalid form submission.' ) ) );
	}

	// A successful upload will pass this test. It makes no sense to override this one.
	if ( isset( $file['error'] ) &amp;&amp; $file['error'] &gt; 0 ) {
		return call_user_func_array( $upload_error_handler, array( &amp;$file, $upload_error_strings[ $file['error'] ] ) );
	}

	// A properly uploaded file will pass this test. There should be no reason to override this one.
	$test_uploaded_file = 'wp_handle_upload' === $action ? is_uploaded_file( $file['tmp_name'] ) : @is_readable( $file['tmp_name'] );
	if ( ! $test_uploaded_file ) {
		return call_user_func_array( $upload_error_handler, array( &amp;$file, __( 'Specified file failed upload test.' ) ) );
	}

	$test_file_size = 'wp_handle_upload' === $action ? $file['size'] : filesize( $file['tmp_name'] );
	// A non-empty file will pass this test.
	if ( $test_size &amp;&amp; ! ( $test_file_size &gt; 0 ) ) {
		if ( is_multisite() ) {
			$error_msg = __( 'File is empty. Please upload something more substantial.' );
		} else {
			$error_msg = sprintf(
				/* translators: 1: php.ini, 2: post_max_size, 3: upload_max_filesize */
				__( 'File is empty. Please upload something more substantial. This error could also be caused by uploads being disabled in your %1$s file or by %2$s being defined as smaller than %3$s in %1$s.' ),
				'php.ini',
				'post_max_size',
				'upload_max_filesize'
			);
		}

		return call_user_func_array( $upload_error_handler, array( &amp;$file, $error_msg ) );
	}

	// A correct MIME type will pass this test. Override $mimes or use the upload_mimes filter.
	if ( $test_type ) {
		$wp_filetype     = wp_check_filetype_and_ext( $file['tmp_name'], $file['name'], $mimes );
		$ext             = empty( $wp_filetype['ext'] ) ? '' : $wp_filetype['ext'];
		$type            = empty( $wp_filetype['type'] ) ? '' : $wp_filetype['type'];
		$proper_filename = empty( $wp_filetype['proper_filename'] ) ? '' : $wp_filetype['proper_filename'];

		// Check to see if wp_check_filetype_and_ext() determined the filename was incorrect.
		if ( $proper_filename ) {
			$file['name'] = $proper_filename;
		}

		if ( ( ! $type || ! $ext ) &amp;&amp; ! current_user_can( 'unfiltered_upload' ) ) {
			return call_user_func_array( $upload_error_handler, array( &amp;$file, __( 'Sorry, you are not allowed to upload this file type.' ) ) );
		}

		if ( ! $type ) {
			$type = $file['type'];
		}
	} else {
		$type = '';
	}

	/*
	 * A writable uploads dir will pass this test. Again, there's no point
	 * overriding this one.
	 */
	$uploads = wp_upload_dir( $time );
	if ( ! ( $uploads &amp;&amp; false === $uploads['error'] ) ) {
		return call_user_func_array( $upload_error_handler, array( &amp;$file, $uploads['error'] ) );
	}

	$filename = wp_unique_filename( $uploads['path'], $file['name'], $unique_filename_callback );

	// Move the file to the uploads dir.
	$new_file = $uploads['path'] . "/$filename";

	/**
	 * Filters whether to short-circuit moving the uploaded file after passing all checks.
	 *
	 * If a non-null value is returned from the filter, moving the file and any related
	 * error reporting will be completely skipped.
	 *
	 * @since 4.9.0
	 *
	 * @param mixed    $move_new_file If null (default) move the file after the upload.
	 * @param array    $file          {
	 *     Reference to a single element from `$_FILES`.
	 *
	 *     @type string $name     The original name of the file on the client machine.
	 *     @type string $type     The mime type of the file, if the browser provided this information.
	 *     @type string $tmp_name The temporary filename of the file in which the uploaded file was stored on the server.
	 *     @type int    $size     The size, in bytes, of the uploaded file.
	 *     @type int    $error    The error code associated with this file upload.
	 * }
	 * @param string   $new_file      Filename of the newly-uploaded file.
	 * @param string   $type          Mime type of the newly-uploaded file.
	 */
	$move_new_file = apply_filters( 'pre_move_uploaded_file', null, $file, $new_file, $type );

	if ( null === $move_new_file ) {
		if ( 'wp_handle_upload' === $action ) {
			$move_new_file = @move_uploaded_file( $file['tmp_name'], $new_file );
		} else {
			// Use copy and unlink because rename breaks streams.
			// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
			$move_new_file = @copy( $file['tmp_name'], $new_file );
			unlink( $file['tmp_name'] );
		}

		if ( false === $move_new_file ) {
			if ( 0 === strpos( $uploads['basedir'], ABSPATH ) ) {
				$error_path = str_replace( ABSPATH, '', $uploads['basedir'] ) . $uploads['subdir'];
			} else {
				$error_path = basename( $uploads['basedir'] ) . $uploads['subdir'];
			}

			return $upload_error_handler(
				$file,
				sprintf(
					/* translators: %s: Destination file path. */
					__( 'The uploaded file could not be moved to %s.' ),
					$error_path
				)
			);
		}
	}

	// Set correct file permissions.
	$stat  = stat( dirname( $new_file ) );
	$perms = $stat['mode'] &amp; 0000666;
	chmod( $new_file, $perms );

	// Compute the URL.
	$url = $uploads['url'] . "/$filename";

	if ( is_multisite() ) {
		clean_dirsize_cache( $new_file );
	}

	/**
	 * Filters the data array for the uploaded file.
	 *
	 * @since 2.1.0
	 *
	 * @param array  $upload {
	 *     Array of upload data.
	 *
	 *     @type string $file Filename of the newly-uploaded file.
	 *     @type string $url  URL of the newly-uploaded file.
	 *     @type string $type Mime type of the newly-uploaded file.
	 * }
	 * @param string $context The type of upload action. Values include 'upload' or 'sideload'.
	 */
	return apply_filters(
		'wp_handle_upload',
		array(
			'file' =&gt; $new_file,
			'url'  =&gt; $url,
			'type' =&gt; $type,
		),
		'wp_handle_sideload' === $action ? 'sideload' : 'upload'
	);
}</pre>  </section>  <section> <h2 id="related">Related</h2> <article class="uses"> <h3 id="uses">Uses</h3> <table id="uses-table">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="../hooks/action_overrides">{$action}_overrides</a> </td> <td class="related-desc"> <p>Filters the override parameters for a file before it is uploaded to WordPress.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="clean_dirsize_cache">clean_dirsize_cache()</a> </td> <td class="related-desc"> <p>Cleans directory size cache used by <a href="recurse_dirsize">recurse_dirsize()</a>.</p> </td> </tr> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="../hooks/pre_move_uploaded_file">pre_move_uploaded_file</a> </td> <td class="related-desc"> <p>Filters whether to short-circuit moving the uploaded file after passing all checks.</p> </td> </tr> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="../hooks/action_prefilter">{$action}_prefilter</a> </td> <td class="related-desc"> <p>Filters the data for a file before it is uploaded to WordPress.</p> </td> </tr> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="../hooks/wp_handle_upload">wp_handle_upload</a> </td> <td class="related-desc"> <p>Filters the data array for the uploaded file.</p> </td> </tr> <tr> <td> <span>wp-includes/capabilities.php:</span> <a href="current_user_can">current_user_can()</a> </td> <td class="related-desc"> <p>Returns whether the current user has the specified capability.</p> </td> </tr> <tr> <td> <span>wp-includes/l10n.php:</span> <a href="__">__()</a> </td> <td class="related-desc"> <p>Retrieve the translation of $text.</p> </td> </tr> <tr> <td> <span>wp-includes/load.php:</span> <a href="is_multisite">is_multisite()</a> </td> <td class="related-desc"> <p>If Multisite is enabled.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="wp_check_filetype_and_ext">wp_check_filetype_and_ext()</a> </td> <td class="related-desc"> <p>Attempt to determine the real file type of a file.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="wp_upload_dir">wp_upload_dir()</a> </td> <td class="related-desc"> <p>Returns an array containing the current upload directoryâ€™s path and URL.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="wp_unique_filename">wp_unique_filename()</a> </td> <td class="related-desc"> <p>Get a filename that is sanitized and unique for the given directory.</p> </td> </tr> <tr> <td> <span>wp-includes/plugin.php:</span> <a href="apply_filters">apply_filters()</a> </td> <td class="related-desc"> <p>Calls the callback functions that have been added to a filter hook.</p> </td> </tr> </tbody>

</table>   </article>  <article class="used-by"> <h3 id="used-by">Used By</h3> <table id="used-by-table">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="wp_handle_upload">wp_handle_upload()</a> </td> <td class="related-desc"> <p>Wrapper for <a href="_wp_handle_upload">_wp_handle_upload()</a>.</p> </td> </tr> <tr> <td> <span>wp-admin/includes/file.php:</span> <a href="wp_handle_sideload">wp_handle_sideload()</a> </td> <td class="related-desc"> <p>Wrapper for <a href="_wp_handle_upload">_wp_handle_upload()</a>.</p> </td> </tr> </tbody>

</table> </article> </section>  <section> <h2 id="changelog">Changelog</h2> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.0.0/" alt="WordPress 4.0.0">4.0.0</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section>    </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://developer.wordpress.org/reference/functions/_wp_handle_upload" class="_attribution-link" target="_blank">https://developer.wordpress.org/reference/functions/_wp_handle_upload</a>
  </p>
</div>
