<h1>Requests::compatible_gzinflate( string $gz_data )</h1>  <section> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </section> <div class="content-toc">  <section> <h2 id="description">Description</h2> <p>Certain Servers will return deflated data with headers which PHP’s gzinflate() function cannot handle out of the box. The following function has been created from various snippets on the gzinflate() PHP documentation.</p> <p>Warning: Magic numbers within. Due to the potential different formats that the compressed data may be returned in, some "magic offsets" are needed to ensure proper decompression takes place. For a simple progmatic way to determine the magic offset in use, see: <a href="https://core.trac.wordpress.org/ticket/18273">https://core.trac.wordpress.org/ticket/18273</a></p> </section>  <section> <h2 id="parameters">Parameters</h2> <dl> <dt>$gz_data</dt> <dd> <p class="desc"> <span class="type">(<span class="string">string</span>)</span> <span class="required">(Required)</span> <span class="description">String to decompress.</span> </p> </dd> </dl> </section>  <section> <h2 id="return">Return</h2> <p><span class="return-type">(string|bool)</span> False on failure.</p> </section>  <section> <h2 id="source">Source</h2> <p> File: <a href="https://developer.wordpress.org/reference/files/wp-includes/class-requests.php/">wp-includes/class-requests.php</a> </p> <pre data-language="php">public static function compatible_gzinflate($gz_data) {
		// Compressed data might contain a full zlib header, if so strip it for
		// gzinflate()
		if (substr($gz_data, 0, 3) === "\x1f\x8b\x08") {
			$i   = 10;
			$flg = ord(substr($gz_data, 3, 1));
			if ($flg &gt; 0) {
				if ($flg &amp; 4) {
					list($xlen) = unpack('v', substr($gz_data, $i, 2));
					$i         += 2 + $xlen;
				}
				if ($flg &amp; 8) {
					$i = strpos($gz_data, "\0", $i) + 1;
				}
				if ($flg &amp; 16) {
					$i = strpos($gz_data, "\0", $i) + 1;
				}
				if ($flg &amp; 2) {
					$i += 2;
				}
			}
			$decompressed = self::compatible_gzinflate(substr($gz_data, $i));
			if ($decompressed !== false) {
				return $decompressed;
			}
		}

		// If the data is Huffman Encoded, we must first strip the leading 2
		// byte Huffman marker for gzinflate()
		// The response is Huffman coded by many compressors such as
		// java.util.zip.Deflater, Ruby’s Zlib::Deflate, and .NET's
		// System.IO.Compression.DeflateStream.
		//
		// See https://decompres.blogspot.com/ for a quick explanation of this
		// data type
		$huffman_encoded = false;

		// low nibble of first byte should be 0x08
		list(, $first_nibble) = unpack('h', $gz_data);

		// First 2 bytes should be divisible by 0x1F
		list(, $first_two_bytes) = unpack('n', $gz_data);

		if ($first_nibble === 0x08 &amp;&amp; ($first_two_bytes % 0x1F) === 0) {
			$huffman_encoded = true;
		}

		if ($huffman_encoded) {
			$decompressed = @gzinflate(substr($gz_data, 2));
			if ($decompressed !== false) {
				return $decompressed;
			}
		}

		if (substr($gz_data, 0, 4) === "\x50\x4b\x03\x04") {
			// ZIP file format header
			// Offset 6: 2 bytes, General-purpose field
			// Offset 26: 2 bytes, filename length
			// Offset 28: 2 bytes, optional field length
			// Offset 30: Filename field, followed by optional field, followed
			// immediately by data
			list(, $general_purpose_flag) = unpack('v', substr($gz_data, 6, 2));

			// If the file has been compressed on the fly, 0x08 bit is set of
			// the general purpose field. We can use this to differentiate
			// between a compressed document, and a ZIP file
			$zip_compressed_on_the_fly = ((0x08 &amp; $general_purpose_flag) === 0x08);

			if (!$zip_compressed_on_the_fly) {
				// Don't attempt to decode a compressed zip file
				return $gz_data;
			}

			// Determine the first byte of data, based on the above ZIP header
			// offsets:
			$first_file_start = array_sum(unpack('v2', substr($gz_data, 26, 4)));
			$decompressed     = @gzinflate(substr($gz_data, 30 + $first_file_start));
			if ($decompressed !== false) {
				return $decompressed;
			}
			return false;
		}

		// Finally fall back to straight gzinflate
		$decompressed = @gzinflate($gz_data);
		if ($decompressed !== false) {
			return $decompressed;
		}

		// Fallback for all above failing, not expected, but included for
		// debugging and preventing regressions and to track stats
		$decompressed = @gzinflate(substr($gz_data, 2));
		if ($decompressed !== false) {
			return $decompressed;
		}

		return false;
	}</pre>  </section>  <section> <h2 id="related">Related</h2> <article class="uses"> <h3 id="uses">Uses</h3> <table id="uses-table">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-includes/class-requests.php:</span> <a href="compatible_gzinflate">Requests::compatible_gzinflate()</a> </td> <td class="related-desc"> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </td> </tr> </tbody>

</table> </article> <article class="used-by"> <h3 id="used-by">Used By</h3> <table id="used-by-table">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-includes/class-requests.php:</span> <a href="compatible_gzinflate">Requests::compatible_gzinflate()</a> </td> <td class="related-desc"> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </td> </tr> <tr> <td> <span>wp-includes/class-requests.php:</span> <a href="decompress">Requests::decompress()</a> </td> <td class="related-desc"> <p>Decompress an encoded body</p> </td> </tr> </tbody>

</table> </article> </section>  <section> <h2 id="changelog">Changelog</h2> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/2.8.1/" alt="WordPress 2.8.1">2.8.1</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section>    </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://developer.wordpress.org/reference/classes/requests/compatible_gzinflate" class="_attribution-link" target="_blank">https://developer.wordpress.org/reference/classes/requests/compatible_gzinflate</a>
  </p>
</div>
