<h1>WP_User_Query::prepare_query( string|array $query = array() )</h1>  <section> <p>Prepares the query variables.</p> </section> <div class="content-toc">  <section> <h2 id="parameters">Parameters</h2> <dl> <dt>$query</dt> <dd> <p class="desc"> <span class="type">(<span class="string">string</span>|<span class="array">array</span>)</span> <span class="required">(Optional)</span> <span class="description">Array or string of Query parameters. <ul class="param-hash">
<li>
<b>'blog_id'</b><br><i><span class="type">(int)</span></i> The site ID. Default is the current site.</li> <li>
<b>'role'</b><br><i><span class="type">(string|string[])</span></i> An array or a comma-separated list of role names that users must match to be included in results. Note that this is an inclusive list: users must match *each* role. </li> <li>
<b>'role__in'</b><br><i><span class="type">(string[])</span></i> An array of role names. Matched users must have at least one of these roles. </li> <li>
<b>'role__not_in'</b><br><i><span class="type">(string[])</span></i> An array of role names to exclude. Users matching one or more of these roles will not be included in results. </li> <li>
<b>'meta_key'</b><br><i><span class="type">(string|string[])</span></i> Meta key or keys to filter by.</li> <li>
<b>'meta_value'</b><br><i><span class="type">(string|string[])</span></i> Meta value or values to filter by.</li> <li>
<b>'meta_compare'</b><br><i><span class="type">(string)</span></i> MySQL operator used for comparing the meta value. See WP_Meta_Query::__construct for accepted values and default value.</li> <li>
<b>'meta_compare_key'</b><br><i><span class="type">(string)</span></i> MySQL operator used for comparing the meta key. See WP_Meta_Query::__construct for accepted values and default value.</li> <li>
<b>'meta_type'</b><br><i><span class="type">(string)</span></i> MySQL data type that the meta_value column will be CAST to for comparisons. See WP_Meta_Query::__construct for accepted values and default value.</li> <li>
<b>'meta_type_key'</b><br><i><span class="type">(string)</span></i> MySQL data type that the meta_key column will be CAST to for comparisons. See WP_Meta_Query::__construct for accepted values and default value.</li> <li>
<b>'meta_query'</b><br><i><span class="type">(array)</span></i> An associative array of <a href="../wp_meta_query">WP_Meta_Query</a> arguments. See WP_Meta_Query::__construct for accepted values.</li> <li>
<b>'capability'</b><br><i><span class="type">(string|string[])</span></i> An array or a comma-separated list of capability names that users must match to be included in results. Note that this is an inclusive list: users must match *each* capability. Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap">'map_meta_cap'</a>. </li> <li>
<b>'capability__in'</b><br><i><span class="type">(string[])</span></i> An array of capability names. Matched users must have at least one of these capabilities. Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap">'map_meta_cap'</a>. </li> <li>
<b>'capability__not_in'</b><br><i><span class="type">(string[])</span></i> An array of capability names to exclude. Users matching one or more of these capabilities will not be included in results. Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap">'map_meta_cap'</a>. </li> <li>
<b>'include'</b><br><i><span class="type">(int[])</span></i> An array of user IDs to include. </li> <li>
<b>'exclude'</b><br><i><span class="type">(int[])</span></i> An array of user IDs to exclude. </li> <li>
<b>'search'</b><br><i><span class="type">(string)</span></i> Search keyword. Searches for possible string matches on columns. When <code>$search_columns</code> is left empty, it tries to determine which column to search in based on search string. </li> <li>
<b>'search_columns'</b><br><i><span class="type">(string[])</span></i> Array of column names to be searched. Accepts 'ID', 'user_login', 'user_email', 'user_url', 'user_nicename', 'display_name'. </li> <li>
<b>'orderby'</b><br><i><span class="type">(string|array)</span></i> Field(s) to sort the retrieved users by. May be a single value, an array of values, or a multi-dimensional array with fields as keys and orders ('ASC' or 'DESC') as values. Accepted values are: <ul>
<li>'ID'</li> <li>'display_name' (or 'name')</li> <li>'include'</li> <li>'user_login' (or 'login')</li> <li>'login__in'</li> <li>'user_nicename' (or 'nicename'),</li> <li>'nicename__in'</li> <li>'user_email (or 'email')</li> <li>'user_url' (or 'url'),</li> <li>'user_registered' (or 'registered')</li> <li>'post_count'</li> <li>'meta_value',</li> <li>'meta_value_num'</li> <li>The value of <code>$meta_key</code>
</li> <li>An array key of <code>$meta_query</code> To use 'meta_value' or 'meta_value_num', <code>$meta_key</code> must be also be defined. Default 'user_login'.</li>
</ul>
</li> <li>
<b>'order'</b><br><i><span class="type">(string)</span></i> Designates ascending or descending order of users. Order values passed as part of an <code>$orderby</code> array take precedence over this parameter. Accepts 'ASC', 'DESC'. Default 'ASC'.</li> <li>
<b>'offset'</b><br><i><span class="type">(int)</span></i> Number of users to offset in retrieved results. Can be used in conjunction with pagination. Default 0.</li> <li>
<b>'number'</b><br><i><span class="type">(int)</span></i> Number of users to limit the query for. Can be used in conjunction with pagination. Value -1 (all) is supported, but should be used with caution on larger sites. Default -1 (all users).</li> <li>
<b>'paged'</b><br><i><span class="type">(int)</span></i> When used with number, defines the page of results to return. Default 1.</li> <li>
<b>'count_total'</b><br><i><span class="type">(bool)</span></i> Whether to count the total number of users found. If pagination is not needed, setting this to false can improve performance. Default true.</li> <li>
<b>'fields'</b><br><i><span class="type">(string|string[])</span></i> Which fields to return. Single or all fields (string), or array of fields. Accepts: </li>
<li>'ID'</li> <li>'display_name'</li> <li>'user_login'</li> <li>'user_nicename'</li> <li>'user_email'</li> <li>'user_url'</li> <li>'user_registered'</li> <li>'user_pass'</li> <li>'user_activation_key'</li> <li>'user_status'</li> <li>'spam' (only available on multisite installs)</li> <li>'deleted' (only available on multisite installs)</li> <li>'all' for all fields</li> <li>'all_with_meta' to include meta fields. Default 'all'.</li>
</ul> <li>
<b>'who'</b><br><i><span class="type">(string)</span></i> Type of users to query. Accepts 'authors'. Default empty (all users).</li> <li>
<b>'has_published_posts'</b><br><i><span class="type">(bool|string[])</span></i> Pass an array of post types to filter results to users who have published posts in those post types. <code>true</code> is an alias for all public post types.</li> <li>
<b>'nicename'</b><br><i><span class="type">(string)</span></i> The user nicename. </li> <li>
<b>'nicename__in'</b><br><i><span class="type">(string[])</span></i> An array of nicenames to include. Users matching one of these nicenames will be included in results. </li> <li>
<b>'nicename__not_in'</b><br><i><span class="type">(string[])</span></i> An array of nicenames to exclude. Users matching one of these nicenames will not be included in results. </li> <li>
<b>'login'</b><br><i><span class="type">(string)</span></i> The user login. </li> <li>
<b>'login__in'</b><br><i><span class="type">(string[])</span></i> An array of logins to include. Users matching one of these logins will be included in results. </li> <li>
<b>'login__not_in'</b><br><i><span class="type">(string[])</span></i> An array of logins to exclude. Users matching one of these logins will not be included in results. </li> </span> </p> <p class="default">Default value: array()</p> </dd> </dl> </section>  <section> <h2 id="source">Source</h2> <p> File: <a href="https://developer.wordpress.org/reference/files/wp-includes/class-wp-user-query.php/">wp-includes/class-wp-user-query.php</a> </p> <pre data-language="php">public function prepare_query( $query = array() ) {
		global $wpdb;

		if ( empty( $this-&gt;query_vars ) || ! empty( $query ) ) {
			$this-&gt;query_limit = null;
			$this-&gt;query_vars  = $this-&gt;fill_query_vars( $query );
		}

		/**
		 * Fires before the WP_User_Query has been parsed.
		 *
		 * The passed WP_User_Query object contains the query variables,
		 * not yet passed into SQL.
		 *
		 * @since 4.0.0
		 *
		 * @param WP_User_Query $query Current instance of WP_User_Query (passed by reference).
		 */
		do_action_ref_array( 'pre_get_users', array( &amp;$this ) );

		// Ensure that query vars are filled after 'pre_get_users'.
		$qv =&amp; $this-&gt;query_vars;
		$qv = $this-&gt;fill_query_vars( $qv );

		$allowed_fields = array(
			'id',
			'user_login',
			'user_pass',
			'user_nicename',
			'user_email',
			'user_url',
			'user_registered',
			'user_activation_key',
			'user_status',
			'display_name',
		);
		if ( is_multisite() ) {
			$allowed_fields[] = 'spam';
			$allowed_fields[] = 'deleted';
		}

		if ( is_array( $qv['fields'] ) ) {
			$qv['fields'] = array_map( 'strtolower', $qv['fields'] );
			$qv['fields'] = array_intersect( array_unique( $qv['fields'] ), $allowed_fields );

			if ( empty( $qv['fields'] ) ) {
				$qv['fields'] = array( 'id' );
			}

			$this-&gt;query_fields = array();
			foreach ( $qv['fields'] as $field ) {
				$field                = 'id' === $field ? 'ID' : sanitize_key( $field );
				$this-&gt;query_fields[] = "$wpdb-&gt;users.$field";
			}
			$this-&gt;query_fields = implode( ',', $this-&gt;query_fields );
		} elseif ( 'all' === $qv['fields'] ) {
			$this-&gt;query_fields = "$wpdb-&gt;users.*";
		} elseif ( ! in_array( $qv['fields'], $allowed_fields, true ) ) {
			$this-&gt;query_fields = "$wpdb-&gt;users.ID";
		} else {
			$field              = 'id' === strtolower( $qv['fields'] ) ? 'ID' : sanitize_key( $qv['fields'] );
			$this-&gt;query_fields = "$wpdb-&gt;users.$field";
		}

		if ( isset( $qv['count_total'] ) &amp;&amp; $qv['count_total'] ) {
			$this-&gt;query_fields = 'SQL_CALC_FOUND_ROWS ' . $this-&gt;query_fields;
		}

		$this-&gt;query_from  = "FROM $wpdb-&gt;users";
		$this-&gt;query_where = 'WHERE 1=1';

		// Parse and sanitize 'include', for use by 'orderby' as well as 'include' below.
		if ( ! empty( $qv['include'] ) ) {
			$include = wp_parse_id_list( $qv['include'] );
		} else {
			$include = false;
		}

		$blog_id = 0;
		if ( isset( $qv['blog_id'] ) ) {
			$blog_id = absint( $qv['blog_id'] );
		}

		if ( $qv['has_published_posts'] &amp;&amp; $blog_id ) {
			if ( true === $qv['has_published_posts'] ) {
				$post_types = get_post_types( array( 'public' =&gt; true ) );
			} else {
				$post_types = (array) $qv['has_published_posts'];
			}

			foreach ( $post_types as &amp;$post_type ) {
				$post_type = $wpdb-&gt;prepare( '%s', $post_type );
			}

			$posts_table        = $wpdb-&gt;get_blog_prefix( $blog_id ) . 'posts';
			$this-&gt;query_where .= " AND $wpdb-&gt;users.ID IN ( SELECT DISTINCT $posts_table.post_author FROM $posts_table WHERE $posts_table.post_status = 'publish' AND $posts_table.post_type IN ( " . implode( ', ', $post_types ) . ' ) )';
		}

		// nicename
		if ( '' !== $qv['nicename'] ) {
			$this-&gt;query_where .= $wpdb-&gt;prepare( ' AND user_nicename = %s', $qv['nicename'] );
		}

		if ( ! empty( $qv['nicename__in'] ) ) {
			$sanitized_nicename__in = array_map( 'esc_sql', $qv['nicename__in'] );
			$nicename__in           = implode( "','", $sanitized_nicename__in );
			$this-&gt;query_where     .= " AND user_nicename IN ( '$nicename__in' )";
		}

		if ( ! empty( $qv['nicename__not_in'] ) ) {
			$sanitized_nicename__not_in = array_map( 'esc_sql', $qv['nicename__not_in'] );
			$nicename__not_in           = implode( "','", $sanitized_nicename__not_in );
			$this-&gt;query_where         .= " AND user_nicename NOT IN ( '$nicename__not_in' )";
		}

		// login
		if ( '' !== $qv['login'] ) {
			$this-&gt;query_where .= $wpdb-&gt;prepare( ' AND user_login = %s', $qv['login'] );
		}

		if ( ! empty( $qv['login__in'] ) ) {
			$sanitized_login__in = array_map( 'esc_sql', $qv['login__in'] );
			$login__in           = implode( "','", $sanitized_login__in );
			$this-&gt;query_where  .= " AND user_login IN ( '$login__in' )";
		}

		if ( ! empty( $qv['login__not_in'] ) ) {
			$sanitized_login__not_in = array_map( 'esc_sql', $qv['login__not_in'] );
			$login__not_in           = implode( "','", $sanitized_login__not_in );
			$this-&gt;query_where      .= " AND user_login NOT IN ( '$login__not_in' )";
		}

		// Meta query.
		$this-&gt;meta_query = new WP_Meta_Query();
		$this-&gt;meta_query-&gt;parse_query_vars( $qv );

		if ( isset( $qv['who'] ) &amp;&amp; 'authors' === $qv['who'] &amp;&amp; $blog_id ) {
			_deprecated_argument(
				'WP_User_Query',
				'5.9.0',
				sprintf(
					/* translators: 1: who, 2: capability */
					__( '%1$s is deprecated. Use %2$s instead.' ),
					'&lt;code&gt;who&lt;/code&gt;',
					'&lt;code&gt;capability&lt;/code&gt;'
				)
			);

			$who_query = array(
				'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'user_level',
				'value'   =&gt; 0,
				'compare' =&gt; '!=',
			);

			// Prevent extra meta query.
			$qv['blog_id'] = 0;
			$blog_id       = 0;

			if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
				$this-&gt;meta_query-&gt;queries = array( $who_query );
			} else {
				// Append the cap query to the original queries and reparse the query.
				$this-&gt;meta_query-&gt;queries = array(
					'relation' =&gt; 'AND',
					array( $this-&gt;meta_query-&gt;queries, $who_query ),
				);
			}

			$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
		}

		// Roles.
		$roles = array();
		if ( isset( $qv['role'] ) ) {
			if ( is_array( $qv['role'] ) ) {
				$roles = $qv['role'];
			} elseif ( is_string( $qv['role'] ) &amp;&amp; ! empty( $qv['role'] ) ) {
				$roles = array_map( 'trim', explode( ',', $qv['role'] ) );
			}
		}

		$role__in = array();
		if ( isset( $qv['role__in'] ) ) {
			$role__in = (array) $qv['role__in'];
		}

		$role__not_in = array();
		if ( isset( $qv['role__not_in'] ) ) {
			$role__not_in = (array) $qv['role__not_in'];
		}

		// Capabilities.
		$available_roles = array();

		if ( ! empty( $qv['capability'] ) || ! empty( $qv['capability__in'] ) || ! empty( $qv['capability__not_in'] ) ) {
			global $wp_roles;

			$wp_roles-&gt;for_site( $blog_id );
			$available_roles = $wp_roles-&gt;roles;
		}

		$capabilities = array();
		if ( ! empty( $qv['capability'] ) ) {
			if ( is_array( $qv['capability'] ) ) {
				$capabilities = $qv['capability'];
			} elseif ( is_string( $qv['capability'] ) ) {
				$capabilities = array_map( 'trim', explode( ',', $qv['capability'] ) );
			}
		}

		$capability__in = array();
		if ( ! empty( $qv['capability__in'] ) ) {
			$capability__in = (array) $qv['capability__in'];
		}

		$capability__not_in = array();
		if ( ! empty( $qv['capability__not_in'] ) ) {
			$capability__not_in = (array) $qv['capability__not_in'];
		}

		// Keep track of all capabilities and the roles they're added on.
		$caps_with_roles = array();

		foreach ( $available_roles as $role =&gt; $role_data ) {
			$role_caps = array_keys( array_filter( $role_data['capabilities'] ) );

			foreach ( $capabilities as $cap ) {
				if ( in_array( $cap, $role_caps, true ) ) {
					$caps_with_roles[ $cap ][] = $role;
					break;
				}
			}

			foreach ( $capability__in as $cap ) {
				if ( in_array( $cap, $role_caps, true ) ) {
					$role__in[] = $role;
					break;
				}
			}

			foreach ( $capability__not_in as $cap ) {
				if ( in_array( $cap, $role_caps, true ) ) {
					$role__not_in[] = $role;
					break;
				}
			}
		}

		$role__in     = array_merge( $role__in, $capability__in );
		$role__not_in = array_merge( $role__not_in, $capability__not_in );

		$roles        = array_unique( $roles );
		$role__in     = array_unique( $role__in );
		$role__not_in = array_unique( $role__not_in );

		// Support querying by capabilities added directly to users.
		if ( $blog_id &amp;&amp; ! empty( $capabilities ) ) {
			$capabilities_clauses = array( 'relation' =&gt; 'AND' );

			foreach ( $capabilities as $cap ) {
				$clause = array( 'relation' =&gt; 'OR' );

				$clause[] = array(
					'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
					'value'   =&gt; '"' . $cap . '"',
					'compare' =&gt; 'LIKE',
				);

				if ( ! empty( $caps_with_roles[ $cap ] ) ) {
					foreach ( $caps_with_roles[ $cap ] as $role ) {
						$clause[] = array(
							'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
							'value'   =&gt; '"' . $role . '"',
							'compare' =&gt; 'LIKE',
						);
					}
				}

				$capabilities_clauses[] = $clause;
			}

			$role_queries[] = $capabilities_clauses;

			if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
				$this-&gt;meta_query-&gt;queries[] = $capabilities_clauses;
			} else {
				// Append the cap query to the original queries and reparse the query.
				$this-&gt;meta_query-&gt;queries = array(
					'relation' =&gt; 'AND',
					array( $this-&gt;meta_query-&gt;queries, array( $capabilities_clauses ) ),
				);
			}

			$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
		}

		if ( $blog_id &amp;&amp; ( ! empty( $roles ) || ! empty( $role__in ) || ! empty( $role__not_in ) || is_multisite() ) ) {
			$role_queries = array();

			$roles_clauses = array( 'relation' =&gt; 'AND' );
			if ( ! empty( $roles ) ) {
				foreach ( $roles as $role ) {
					$roles_clauses[] = array(
						'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
						'value'   =&gt; '"' . $role . '"',
						'compare' =&gt; 'LIKE',
					);
				}

				$role_queries[] = $roles_clauses;
			}

			$role__in_clauses = array( 'relation' =&gt; 'OR' );
			if ( ! empty( $role__in ) ) {
				foreach ( $role__in as $role ) {
					$role__in_clauses[] = array(
						'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
						'value'   =&gt; '"' . $role . '"',
						'compare' =&gt; 'LIKE',
					);
				}

				$role_queries[] = $role__in_clauses;
			}

			$role__not_in_clauses = array( 'relation' =&gt; 'AND' );
			if ( ! empty( $role__not_in ) ) {
				foreach ( $role__not_in as $role ) {
					$role__not_in_clauses[] = array(
						'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
						'value'   =&gt; '"' . $role . '"',
						'compare' =&gt; 'NOT LIKE',
					);
				}

				$role_queries[] = $role__not_in_clauses;
			}

			// If there are no specific roles named, make sure the user is a member of the site.
			if ( empty( $role_queries ) ) {
				$role_queries[] = array(
					'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
					'compare' =&gt; 'EXISTS',
				);
			}

			// Specify that role queries should be joined with AND.
			$role_queries['relation'] = 'AND';

			if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
				$this-&gt;meta_query-&gt;queries = $role_queries;
			} else {
				// Append the cap query to the original queries and reparse the query.
				$this-&gt;meta_query-&gt;queries = array(
					'relation' =&gt; 'AND',
					array( $this-&gt;meta_query-&gt;queries, $role_queries ),
				);
			}

			$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
		}

		if ( ! empty( $this-&gt;meta_query-&gt;queries ) ) {
			$clauses            = $this-&gt;meta_query-&gt;get_sql( 'user', $wpdb-&gt;users, 'ID', $this );
			$this-&gt;query_from  .= $clauses['join'];
			$this-&gt;query_where .= $clauses['where'];

			if ( $this-&gt;meta_query-&gt;has_or_relation() ) {
				$this-&gt;query_fields = 'DISTINCT ' . $this-&gt;query_fields;
			}
		}

		// Sorting.
		$qv['order'] = isset( $qv['order'] ) ? strtoupper( $qv['order'] ) : '';
		$order       = $this-&gt;parse_order( $qv['order'] );

		if ( empty( $qv['orderby'] ) ) {
			// Default order is by 'user_login'.
			$ordersby = array( 'user_login' =&gt; $order );
		} elseif ( is_array( $qv['orderby'] ) ) {
			$ordersby = $qv['orderby'];
		} else {
			// 'orderby' values may be a comma- or space-separated list.
			$ordersby = preg_split( '/[,\s]+/', $qv['orderby'] );
		}

		$orderby_array = array();
		foreach ( $ordersby as $_key =&gt; $_value ) {
			if ( ! $_value ) {
				continue;
			}

			if ( is_int( $_key ) ) {
				// Integer key means this is a flat array of 'orderby' fields.
				$_orderby = $_value;
				$_order   = $order;
			} else {
				// Non-integer key means this the key is the field and the value is ASC/DESC.
				$_orderby = $_key;
				$_order   = $_value;
			}

			$parsed = $this-&gt;parse_orderby( $_orderby );

			if ( ! $parsed ) {
				continue;
			}

			if ( 'nicename__in' === $_orderby || 'login__in' === $_orderby ) {
				$orderby_array[] = $parsed;
			} else {
				$orderby_array[] = $parsed . ' ' . $this-&gt;parse_order( $_order );
			}
		}

		// If no valid clauses were found, order by user_login.
		if ( empty( $orderby_array ) ) {
			$orderby_array[] = "user_login $order";
		}

		$this-&gt;query_orderby = 'ORDER BY ' . implode( ', ', $orderby_array );

		// Limit.
		if ( isset( $qv['number'] ) &amp;&amp; $qv['number'] &gt; 0 ) {
			if ( $qv['offset'] ) {
				$this-&gt;query_limit = $wpdb-&gt;prepare( 'LIMIT %d, %d', $qv['offset'], $qv['number'] );
			} else {
				$this-&gt;query_limit = $wpdb-&gt;prepare( 'LIMIT %d, %d', $qv['number'] * ( $qv['paged'] - 1 ), $qv['number'] );
			}
		}

		$search = '';
		if ( isset( $qv['search'] ) ) {
			$search = trim( $qv['search'] );
		}

		if ( $search ) {
			$leading_wild  = ( ltrim( $search, '*' ) != $search );
			$trailing_wild = ( rtrim( $search, '*' ) != $search );
			if ( $leading_wild &amp;&amp; $trailing_wild ) {
				$wild = 'both';
			} elseif ( $leading_wild ) {
				$wild = 'leading';
			} elseif ( $trailing_wild ) {
				$wild = 'trailing';
			} else {
				$wild = false;
			}
			if ( $wild ) {
				$search = trim( $search, '*' );
			}

			$search_columns = array();
			if ( $qv['search_columns'] ) {
				$search_columns = array_intersect( $qv['search_columns'], array( 'ID', 'user_login', 'user_email', 'user_url', 'user_nicename', 'display_name' ) );
			}
			if ( ! $search_columns ) {
				if ( false !== strpos( $search, '@' ) ) {
					$search_columns = array( 'user_email' );
				} elseif ( is_numeric( $search ) ) {
					$search_columns = array( 'user_login', 'ID' );
				} elseif ( preg_match( '|^https?://|', $search ) &amp;&amp; ! ( is_multisite() &amp;&amp; wp_is_large_network( 'users' ) ) ) {
					$search_columns = array( 'user_url' );
				} else {
					$search_columns = array( 'user_login', 'user_url', 'user_email', 'user_nicename', 'display_name' );
				}
			}

			/**
			 * Filters the columns to search in a WP_User_Query search.
			 *
			 * The default columns depend on the search term, and include 'ID', 'user_login',
			 * 'user_email', 'user_url', 'user_nicename', and 'display_name'.
			 *
			 * @since 3.6.0
			 *
			 * @param string[]      $search_columns Array of column names to be searched.
			 * @param string        $search         Text being searched.
			 * @param WP_User_Query $query          The current WP_User_Query instance.
			 */
			$search_columns = apply_filters( 'user_search_columns', $search_columns, $search, $this );

			$this-&gt;query_where .= $this-&gt;get_search_sql( $search, $search_columns, $wild );
		}

		if ( ! empty( $include ) ) {
			// Sanitized earlier.
			$ids                = implode( ',', $include );
			$this-&gt;query_where .= " AND $wpdb-&gt;users.ID IN ($ids)";
		} elseif ( ! empty( $qv['exclude'] ) ) {
			$ids                = implode( ',', wp_parse_id_list( $qv['exclude'] ) );
			$this-&gt;query_where .= " AND $wpdb-&gt;users.ID NOT IN ($ids)";
		}

		// Date queries are allowed for the user_registered field.
		if ( ! empty( $qv['date_query'] ) &amp;&amp; is_array( $qv['date_query'] ) ) {
			$date_query         = new WP_Date_Query( $qv['date_query'], 'user_registered' );
			$this-&gt;query_where .= $date_query-&gt;get_sql();
		}

		/**
		 * Fires after the WP_User_Query has been parsed, and before
		 * the query is executed.
		 *
		 * The passed WP_User_Query object contains SQL parts formed
		 * from parsing the given query.
		 *
		 * @since 3.1.0
		 *
		 * @param WP_User_Query $query Current instance of WP_User_Query (passed by reference).
		 */
		do_action_ref_array( 'pre_user_query', array( &amp;$this ) );
	}</pre>  </section>  <section> <h2 id="related">Related</h2> <article class="uses"> <h3 id="uses">Uses</h3> <table id="uses-table">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-includes/class-wp-roles.php:</span> <a href="../wp_roles/for_site">WP_Roles::for_site()</a> </td> <td class="related-desc"> <p>Sets the site to operate on. Defaults to the current site.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="fill_query_vars">WP_User_Query::fill_query_vars()</a> </td> <td class="related-desc"> <p>Fills in missing query variables with default values.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="parse_order">WP_User_Query::parse_order()</a> </td> <td class="related-desc"> <p>Parses an ‘order’ query variable and casts it to ASC or DESC as necessary.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="parse_orderby">WP_User_Query::parse_orderby()</a> </td> <td class="related-desc"> <p>Parses and sanitizes ‘orderby’ keys passed to the user query.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="../../hooks/pre_get_users">pre_get_users</a> </td> <td class="related-desc"> <p>Fires before the <a href="../wp_user_query">WP_User_Query</a> has been parsed.</p> </td> </tr> <tr> <td> <span>wp-includes/l10n.php:</span> <a href="../../functions/__">__()</a> </td> <td class="related-desc"> <p>Retrieve the translation of $text.</p> </td> </tr> <tr> <td> <span>wp-includes/formatting.php:</span> <a href="../../functions/sanitize_key">sanitize_key()</a> </td> <td class="related-desc"> <p>Sanitizes a string key.</p> </td> </tr> <tr> <td> <span>wp-includes/load.php:</span> <a href="../../functions/is_multisite">is_multisite()</a> </td> <td class="related-desc"> <p>If Multisite is enabled.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="../../functions/_deprecated_argument">_deprecated_argument()</a> </td> <td class="related-desc"> <p>Mark a function argument as deprecated and inform when it has been used.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="../../functions/wp_parse_id_list">wp_parse_id_list()</a> </td> <td class="related-desc"> <p>Cleans up an array, comma- or space-separated list of IDs.</p> </td> </tr> <tr> <td> <span>wp-includes/functions.php:</span> <a href="../../functions/absint">absint()</a> </td> <td class="related-desc"> <p>Convert a value to non-negative integer.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-date-query.php:</span> <a href="../wp_date_query/__construct">WP_Date_Query::__construct()</a> </td> <td class="related-desc"> <p>Constructor.</p> </td> </tr> <tr> <td> <span>wp-includes/plugin.php:</span> <a href="../../functions/do_action_ref_array">do_action_ref_array()</a> </td> <td class="related-desc"> <p>Calls the callback functions that have been added to an action hook, specifying arguments in an array.</p> </td> </tr> <tr> <td> <span>wp-includes/plugin.php:</span> <a href="../../functions/apply_filters">apply_filters()</a> </td> <td class="related-desc"> <p>Calls the callback functions that have been added to a filter hook.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="get_search_sql">WP_User_Query::get_search_sql()</a> </td> <td class="related-desc"> <p>Used internally to generate an SQL string for searching across multiple columns.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="../../hooks/user_search_columns">user_search_columns</a> </td> <td class="related-desc"> <p>Filters the columns to search in a <a href="../wp_user_query">WP_User_Query</a> search.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="../../hooks/pre_user_query">pre_user_query</a> </td> <td class="related-desc"> <p>Fires after the <a href="../wp_user_query">WP_User_Query</a> has been parsed, and before the query is executed.</p> </td> </tr> <tr> <td> <span>wp-includes/post.php:</span> <a href="../../functions/get_post_types">get_post_types()</a> </td> <td class="related-desc"> <p>Get a list of all registered post type objects.</p> </td> </tr> <tr> <td> <span>wp-includes/ms-functions.php:</span> <a href="../../functions/wp_is_large_network">wp_is_large_network()</a> </td> <td class="related-desc"> <p>Determines whether or not we have a large network.</p> </td> </tr> <tr> <td> <span>wp-includes/wp-db.php:</span> <a href="../wpdb/prepare">wpdb::prepare()</a> </td> <td class="related-desc"> <p>Prepares a SQL query for safe execution.</p> </td> </tr> <tr> <td> <span>wp-includes/wp-db.php:</span> <a href="../wpdb/get_blog_prefix">wpdb::get_blog_prefix()</a> </td> <td class="related-desc"> <p>Gets blog prefix.</p> </td> </tr> <tr> <td> <span>wp-includes/class-wp-meta-query.php:</span> <a href="../wp_meta_query/__construct">WP_Meta_Query::__construct()</a> </td> <td class="related-desc"> <p>Constructor.</p> </td> </tr> </tbody>

</table>   </article>  <article class="used-by"> <h3 id="used-by">Used By</h3> <table id="used-by-table">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-includes/class-wp-user-query.php:</span> <a href="__construct">WP_User_Query::__construct()</a> </td> <td class="related-desc"> <p>PHP5 constructor.</p> </td> </tr> </tbody>

</table> </article> </section>  <section> <h2 id="changelog">Changelog</h2> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/5.9.0/" alt="WordPress 5.9.0">5.9.0</a></td> <td><span class="since-description">Added 'capability', 'capability__in', and 'capability__not_in' parameters.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/5.3.0/" alt="WordPress 5.3.0">5.3.0</a></td> <td><span class="since-description">Introduced the 'meta_type_key' parameter.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/5.1.0/" alt="WordPress 5.1.0">5.1.0</a></td> <td><span class="since-description">Introduced the 'meta_compare_key' parameter.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.7.0/" alt="WordPress 4.7.0">4.7.0</a></td> <td><span class="since-description">Added 'nicename', 'nicename__in', 'nicename__not_in', 'login', 'login__in', and 'login__not_in' parameters.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.4.0/" alt="WordPress 4.4.0">4.4.0</a></td> <td><span class="since-description">Added 'paged', 'role__in', and 'role__not_in' parameters. The 'role' parameter was updated to permit an array or comma-separated list of values. The 'number' parameter was updated to support querying for all users with using -1.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.3.0/" alt="WordPress 4.3.0">4.3.0</a></td> <td><span class="since-description">Added 'has_published_posts' parameter.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.2.0/" alt="WordPress 4.2.0">4.2.0</a></td> <td><span class="since-description">Added 'meta_value_num' support for <code>$orderby</code> parameter. Added multi-dimensional array syntax for <code>$orderby</code> parameter.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.1.0/" alt="WordPress 4.1.0">4.1.0</a></td> <td><span class="since-description">Added the ability to order by the <code>include</code> value.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/3.1.0/" alt="WordPress 3.1.0">3.1.0</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section>    </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://developer.wordpress.org/reference/classes/wp_user_query/prepare_query" class="_attribution-link" target="_blank">https://developer.wordpress.org/reference/classes/wp_user_query/prepare_query</a>
  </p>
</div>
