 <h1 id="circleci">CircleCI</h1> <p>In this section we are going to use <a href="https://circleci.com/">CircleCI</a> as our continuous-integration service. In a <a href="https://circleci.com/docs/2.0/about-circleci/#section=welcome">few words</a> CircleCI automates your software builds, tests, and deployments. It supports <a href="https://circleci.com/docs/2.0/demo-apps/#section=welcome">different programming languages</a> and for our particular case, it supports the <a href="https://circleci.com/docs/2.0/language-crystal/">Crystal language</a>.</p> <p>In this section we are going to present some configuration examples to see how CircleCI implements some <a href="https://circleci.com/docs/2.0/concepts/">continuous integration concepts</a>.</p> <h2 id="circleci-orbs">CircleCI orbs</h2> <p>Before showing some examples, it’s worth mentioning <a href="https://circleci.com/orbs/">CircleCI orbs</a>. As defined in the official docs:</p> <blockquote> <p>Orbs define reusable commands, executors, and jobs so that commonly used pieces of configuration can be condensed into a single line of code.</p> </blockquote> <p>In our case, we are going to use <a href="https://circleci.com/orbs/registry/orb/manastech/crystal">Crystal’s Orb</a></p> <h2 id="build-and-run-specs">Build and run specs</h2> <h3 id="simple-example-using-latest">Simple example using <code>latest</code>
</h3> <p>Let’s start with a simple example. We are going to run the tests <strong>using latest</strong> Crystal release:</p> <div class="highlight">
<span class="filename">.circleci/config.yml</span><pre data-language="crystal">workflows:
  version: 2
  build:
    jobs:
      - crystal/test

orbs:
  crystal: manastech/crystal@1.0
version: 2.1
</pre>
</div> <p>Yeah! That was simple! With Orbs an abstraction layer is built so that the configuration file is more readable and intuitive.</p> <p>In case we are wondering what the job <a href="https://circleci.com/orbs/registry/orb/manastech/crystal#jobs-test">crystal/test</a> does, we always may see the source code.</p> <h3 id="using-nightly">Using <code>nightly</code>
</h3> <p>Using nightly Crystal release is as easy as:</p> <div class="highlight">
<span class="filename">.circleci/config.yml</span><pre data-language="crystal">workflows:
  version: 2
  build:
    jobs:
      - crystal/test:
          name: test-on-nightly
          executor:
            name: crystal/default
            tag: nightly

orbs:
  crystal: manastech/crystal@1.0
version: 2.1
</pre>
</div> <h3 id="using-a-specific-crystal-release">Using a specific Crystal release</h3> <div class="highlight">
<span class="filename">.circleci/config.yml</span><pre data-language="crystal">workflows:
  version: 2
  build:
    jobs:
      - crystal/test:
          name: test-on-0.30
          executor:
            name: crystal/default
            tag: 0.30.0

orbs:
  crystal: manastech/crystal@1.0
version: 2.1
</pre>
</div> <h2 id="installing-shards-packages">Installing shards packages</h2> <p>You need not worry about it since the <code>crystal/test</code> job runs the <code>crystal/shard-install</code> orb command.</p> <h2 id="installing-binary-dependencies">Installing binary dependencies</h2> <p>Our application or maybe some shards may require libraries and packages. This binary dependencies may be installed using the <a href="https://help.ubuntu.com/lts/serverguide/apt.html">Apt</a> command.</p> <p>Here is an example installing the <code>libsqlite3</code> development package:</p> <div class="highlight">
<span class="filename">.circleci/config.yml</span><pre data-language="crystal">workflows:
  version: 2
  build:
    jobs:
      - crystal/test:
          pre-steps:
            - run: apt-get update &amp;&amp; apt-get install -y libsqlite3-dev

orbs:
  crystal: manastech/crystal@1.0
version: 2.1
</pre>
</div> <h2 id="using-services">Using services</h2> <p>Now, let’s run specs using an external service (for example MySQL):</p> <div class="highlight">
<span class="filename">.circleci/config.yml</span><pre data-language="crystal">executors:
  crystal_mysql:
    docker:
      - image: 'crystallang/crystal:latest'
        environment:
          DATABASE_URL: 'mysql://root@localhost/db'
      - image: 'mysql:5.7'
        environment:
          MYSQL_DATABASE: db
          MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'

workflows:
  version: 2
  build:
    jobs:
      - crystal/test:
          executor: crystal_mysql
          pre-steps:
            - run:
                name: Waiting for service to start (check dockerize)
                command: sleep 1m
            - checkout
            - run:
                name: Install MySQL CLI; Import dummy data
                command: |
                        apt-get update &amp;&amp; apt-get install -y mysql-client
                        mysql -h 127.0.0.1 -u root --password="" db &lt; test-data/setup.sql

orbs:
  crystal: manastech/crystal@1.0
version: 2.1
</pre>
</div> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The explicit <code>checkout</code> in the <code>pre-steps</code> is to have the <code>test-data/setup.sql</code> file available.</p> </div> <h2 id="caching">Caching</h2> <p>Caching is enabled by default when using the job <code>crystal/test</code>, because internally it uses the <code>command</code> <a href="https://circleci.com/orbs/registry/orb/manastech/crystal#commands-with-shards-cache">with-shards-cache</a></p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://crystal-lang.org/reference/1.5/guides/ci/circleci.html" class="_attribution-link" target="_blank">https://crystal-lang.org/reference/1.5/guides/ci/circleci.html</a>
  </p>
</div>
