 <h1 id="static-linking">Static Linking</h1> <p>Crystal supports static linking, i.e. it can link a binary with static libraries so that these libraries don't need to be available as runtime dependencies.</p> <p>Static linking can be enabled using the <code>--static</code> compiler flag. See <a href="../using_the_compiler/index#creating-a-statically-linked-executable">the usage instructions</a> in the language reference.</p> <p>When <code>--static</code> is given, linking static libraries is enabled, but it's not exclusive. The produced binary won't be fully static linked if the dynamic version of a library is higher in the compiler's library lookup chain than the static variant (or if the static library is entirely missing). In order to build a static binary you need to make sure that static versions of the linked libraries are available and the compiler can find them.</p> <p>The compiler uses the <code>CRYSTAL_LIBRARY_PATH</code> environment variable as a first lookup destination for static and dynamic libraries that are to be linked. This can be used to provide static versions of libraries that are also available as dynamic libraries.</p> <p>Not all libraries work well with being statically linked, so there may be some issues. <code>openssl</code> for example is known for complications, as well as <code>glibc</code> (see <a href="#fully-static-linking">Fully Static Linking</a>).</p> <p>Some package managers provide specific packages for static libraries, where <code>foo</code> provides the dynamic library and <code>foo-static</code> for example provides the static library. Sometimes static libraries are also included in development packages.</p> <h2 id="fully-static-linking">Fully Static Linking</h2> <p>A fully statically linked program has no dynamic library dependencies at all. Prominent examples of fully statically linked Crystal programs are the <code>crystal</code> and <code>shards</code> binaries from the official distribution packages.</p> <p>In order to link a program fully statically, all dependencies need to be available as static libraries at compiler time. This can be tricky sometimes, especially with common <code>libc</code> libraries.</p> <h3 id="linux">Linux</h3> <h4 id="glibc"><code>glibc</code></h4> <p><code>glibc</code> is the most common <code>libc</code> implementation on Linux systems. Unfortunately, it doesn't play nicely with static linking and it's highly discouraged.</p> <p>Instead, static linking against <a href="#musl-libc"><code>musl-libc</code></a> is the recommended option on Linux. Since it's statically linked, a binary linked against <code>musl-libc</code> will also run on a glibc system. That's the entire point of it.</p> <h4 id="musl-libc"><code>musl-libc</code></h4> <p><a href="https://musl.libc.org/"><code>musl-libc</code></a> is a clean, efficient <code>libc</code> implementation with excellent static linking support.</p> <p>The recommended way to build a statically linked Crystal program is <a href="https://alpinelinux.org/">Alpine Linux</a>, a minimal Linux distribution based on <code>musl-libc</code>.</p> <p>Official <a href="https://crystal-lang.org/2020/02/02/alpine-based-docker-images.html">Docker Images based on Alpine Linux</a> are available on Docker Hub at <a href="https://hub.docker.com/r/crystallang/crystal/"><code>crystallang/crystal</code></a>. The latest release is tagged as <code>crystallang/crystal:latest-alpine</code>. The Dockerfile source is available at <a href="https://github.com/crystal-lang/distribution-scripts/blob/master/docker/alpine.Dockerfile">crystal-lang/distribution-scripts</a>.</p> <p>With pre-installed <code>crystal</code> compiler, <code>shards</code>, and static libraries of all of stdlib's dependencies these Docker images allow to easily build static Crystal binaries even from <code>glibc</code>-based systems. The official Crystal compiler builds for Linux are created using these images.</p> <p>Here's an example how the Docker image can be used to build a statically linked <em>Hello World</em> program:</p> <div class="highlight"><pre data-language="crystal">$ echo 'puts "Hello World!"' &gt; hello-world.cr
$ docker run --rm -it -v $(pwd):/workspace -w /workspace crystallang/crystal:latest-alpine \
    crystal build hello-world.cr --static
$ ./hello-world
Hello World!
$ ldd hello-world
        statically linked
</pre></div> <p>Alpineâ€™s package manager APK is also easy to work with to install static libraries. Available packages can be found at <a href="https://pkgs.alpinelinux.org/packages">pkgs.alpinelinux.org</a>.</p> <h3 id="macos">macOS</h3> <p>macOS doesn't <a href="https://developer.apple.com/library/content/qa/qa1118/_index.html">officially support fully static linking</a> because the required system libraries are not available as static libraries.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://crystal-lang.org/reference/guides/static_linking.html" class="_attribution-link" target="_blank">https://crystal-lang.org/reference/guides/static_linking.html</a>
  </p>
</div>
