 <h1 id="capturing-blocks">Capturing blocks</h1> <p>A block can be captured and turned into a <code>Proc</code>, which represents a block of code with an associated context: the closured data.</p> <p>To capture a block you must specify it as a method's block parameter, give it a name and specify the input and output types. For example:</p> <div class="crystal highlight"><pre data-language="crystal">def int_to_int(&amp;block : Int32 -&gt; Int32)
  block
end

proc = int_to_int { |x| x + 1 }
proc.call(1) # =&gt; 2
</pre></div> <p>The above code captures the block of code passed to <code>int_to_int</code> in the <code>block</code> variable, and returns it from the method. The type of <code>proc</code> is <a href="https://crystal-lang.org/api/latest/Proc.html"><code>Proc(Int32, Int32)</code></a>, a function that accepts a single <code>Int32</code> argument and returns an <code>Int32</code>.</p> <p>In this way a block can be saved as a callback:</p> <div class="crystal highlight"><pre data-language="crystal">class Model
  def on_save(&amp;block)
    @on_save_callback = block
  end

  def save
    if callback = @on_save_callback
      callback.call
    end
  end
end

model = Model.new
model.on_save { puts "Saved!" }
model.save # prints "Saved!"
</pre></div> <p>In the above example the type of <code>&amp;block</code> wasn't specified: this just means that the captured block doesn't take any arguments and doesn't return anything.</p> <p>Note that if the return type is not specified, nothing gets returned from the proc call:</p> <div class="crystal highlight"><pre data-language="crystal">def some_proc(&amp;block : Int32 -&gt;)
  block
end

proc = some_proc { |x| x + 1 }
proc.call(1) # =&gt; nil
</pre></div> <p>To have something returned, either specify the return type or use an underscore to allow any return type:</p> <div class="crystal highlight"><pre data-language="crystal">def some_proc(&amp;block : Int32 -&gt; _)
  block
end

proc = some_proc { |x| x + 1 }
proc.call(1) # 2

proc = some_proc { |x| x.to_s }
proc.call(1) # "1"
</pre></div> <h2 id="break-and-next">break and next</h2> <p><code>return</code> and <code>break</code> can't be used inside a captured block. <code>next</code> can be used and will exit and give the value of the captured block.</p> <h2 id="with-yield">with ... yield</h2> <p>The default receiver within a captured block can't be changed by using <code>with ... yield</code>.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://crystal-lang.org/reference/syntax_and_semantics/capturing_blocks.html" class="_attribution-link" target="_blank">https://crystal-lang.org/reference/syntax_and_semantics/capturing_blocks.html</a>
  </p>
</div>
