 <h1 id="if-var">if var</h1> <p>If a variable is the condition of an <code>if</code>, inside the <code>then</code> branch the variable will be considered as not having the <code>Nil</code> type:</p> <div class="crystal highlight"><pre data-language="crystal">a = some_condition ? nil : 3
# a is Int32 or Nil

if a
  # Since the only way to get here is if a is truthy,
  # a can't be nil. So here a is Int32.
  a.abs
end
</pre></div> <p>This also applies when a variable is assigned in an <code>if</code>'s condition:</p> <div class="crystal highlight"><pre data-language="crystal">if a = some_expression
  # here a is not nil
end
</pre></div> <p>This logic also applies if there are ands (<code>&amp;&amp;</code>) in the condition:</p> <div class="crystal highlight"><pre data-language="crystal">if a &amp;&amp; b
  # here both a and b are guaranteed not to be Nil
end
</pre></div> <p>Here, the right-hand side of the <code>&amp;&amp;</code> expression is also guaranteed to have <code>a</code> as not <code>Nil</code>.</p> <p>Of course, reassigning a variable inside the <code>then</code> branch makes that variable have a new type based on the expression assigned.</p> <h2 id="limitations">Limitations</h2> <p>The above logic works <strong>only for local variables</strong>. It doesnâ€™t work with instance variables, class variables, or variables bound in a closure. The value of these kinds of variables could potentially be affected by another fiber after the condition was checked, rendering it <code>nil</code>. It also does not work with constants.</p> <div class="crystal highlight"><pre data-language="crystal">if @a
  # here `@a` can be nil
end

if @@a
  # here `@@a` can be nil
end

a = nil
closure = -&gt;{ a = "foo" }

if a
  # here `a` can be nil
end
</pre></div> <p>This can be circumvented by assigning the value to a new local variable:</p> <div class="crystal highlight"><pre data-language="crystal">if a = @a
  # here `a` can't be nil
end
</pre></div> <p>Another option is to use <a href="https://crystal-lang.org/api/latest/Object.html#try%28%26block%29-instance-method"><code>Object#try</code></a> found in the standard library which only executes the block if the value is not <code>nil</code>:</p> <div class="crystal highlight"><pre data-language="crystal">@a.try do |a|
  # here `a` can't be nil
end
</pre></div> <h2 id="method-calls">Method calls</h2> <p>That logic also doesn't work with proc and method calls, including getters and properties, because nilable (or, more generally, union-typed) procs and methods aren't guaranteed to return the same more-specific type on two successive calls.</p> <div class="crystal highlight"><pre data-language="crystal">if method # first call to a method that can return Int32 or Nil
  # here we know that the first call did not return Nil
  method # second call can still return Int32 or Nil
end
</pre></div> <p>The techniques described above for instance variables will also work for proc and method calls.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://crystal-lang.org/reference/syntax_and_semantics/if_var.html" class="_attribution-link" target="_blank">https://crystal-lang.org/reference/syntax_and_semantics/if_var.html</a>
  </p>
</div>
