<h1 class="devsite-page-title">tf.function</h1>     <div itemscope itemtype="http://developers.google.com/ReferenceObject"> <meta itemprop="name" content="tf.function"> <meta itemprop="path" content="Stable"> </div>   <table class="tfo-notebook-buttons tfo-api" align="left"> <td> <a target="_blank" href="https://www.tensorflow.org/versions/r1.15/api_docs/python/tf/function">  TensorFlow 1 version</a> </td> <td> <a target="_blank" href="https://github.com/tensorflow/tensorflow/blob/r2.1/tensorflow/python/eager/def_function.py#L953-L1204">  View source on GitHub </a> </td>
</table>  <p>Compiles a function into a callable TensorFlow graph.</p> <pre class="prettyprint lang-python" translate="no" dir="ltr" data-language="python">tf.function(
    func=None,
    input_signature=None,
    autograph=True,
    experimental_implements=None,
    experimental_autograph_options=None,
    experimental_relax_shapes=False,
    experimental_compile=None
)
</pre> <h3 id="used_in_the_guide_2">Used in the guide:</h3> <ul> <li><a href="https://www.tensorflow.org/guide/concrete_function">Concrete functions</a></li> <li><a href="https://www.tensorflow.org/guide/saved_model">Using the SavedModel format</a></li> <li><a href="https://www.tensorflow.org/guide/function">Better performance with tf.function and AutoGraph</a></li> </ul> <h3 id="used_in_the_tutorials_2">Used in the tutorials:</h3> <ul> <li><a href="https://www.tensorflow.org/tutorials/generative/deepdream">DeepDream</a></li> <li><a href="https://www.tensorflow.org/tutorials/generative/style_transfer">Neural style transfer</a></li> <li><a href="https://www.tensorflow.org/tutorials/customization/performance">Better performance with tf.function</a></li> <li><a href="https://www.tensorflow.org/tutorials/generative/pix2pix">Pix2Pix</a></li> <li><a href="https://www.tensorflow.org/tutorials/text/transformer">Transformer model for language understanding</a></li> </ul> <p><a href="function"><code translate="no" dir="ltr">tf.function</code></a> constructs a callable that executes a TensorFlow graph (<a href="graph"><code translate="no" dir="ltr">tf.Graph</code></a>) created by trace-compiling the TensorFlow operations in <code translate="no" dir="ltr">func</code>, effectively executing <code translate="no" dir="ltr">func</code> as a TensorFlow graph.</p> <h4 id="example_usage_2">Example usage:</h4> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x, y): 
  return x ** 2 + y 
x = tf.constant([2, 3]) 
y = tf.constant([3, -2]) 
f(x, y) 
&lt;tf.Tensor: ... numpy=array([7, 7], ...)&gt; 
</pre> <p><em>Features</em></p> <p><code translate="no" dir="ltr">func</code> may use data-dependent control flow, including <code translate="no" dir="ltr">if</code>, <code translate="no" dir="ltr">for</code>, <code translate="no" dir="ltr">while</code> <code translate="no" dir="ltr">break</code>, <code translate="no" dir="ltr">continue</code> and <code translate="no" dir="ltr">return</code> statements:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x): 
  if tf.reduce_sum(x) &gt; 0: 
    return x * x 
  else: 
    return -x // 2 
f(tf.constant(-2)) 
&lt;tf.Tensor: ... numpy=1&gt; 
</pre> <p><code translate="no" dir="ltr">func</code>'s closure may include <a href="tensor"><code translate="no" dir="ltr">tf.Tensor</code></a> and <a href="variable"><code translate="no" dir="ltr">tf.Variable</code></a> objects:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(): 
  return x ** 2 + y 
x = tf.constant([-2, -3]) 
y = tf.Variable([3, -2]) 
f() 
&lt;tf.Tensor: ... numpy=array([7, 7], ...)&gt; 
</pre> <p><code translate="no" dir="ltr">func</code> may also use ops with side effects, such as <a href="print"><code translate="no" dir="ltr">tf.print</code></a>, <a href="variable"><code translate="no" dir="ltr">tf.Variable</code></a> and others:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
v = tf.Variable(1) 
@tf.function 
def f(x): 
  for i in tf.range(x): 
    v.assign_add(i) 
f(3) 
v 
&lt;tf.Variable ... numpy=4&gt; 
</pre> <aside class="special"><strong>Important:</strong><span> Any Python side-effects (appending to a list, printing with <code translate="no" dir="ltr">print</code>, etc) will only happen once, when <code translate="no" dir="ltr">func</code> is traced. To have side-effects executed into your <a href="function"><code translate="no" dir="ltr">tf.function</code></a> they need to be written as TF ops:</span></aside> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
l = [] 
@tf.function 
def f(x): 
  for i in x: 
    l.append(i + 1)    # Caution! Will only happen once when tracing 
f(tf.constant([1, 2, 3])) 
l 
[&lt;tf.Tensor ...&gt;] 
</pre> <p>Instead, use TensorFlow collections like <a href="tensorarray"><code translate="no" dir="ltr">tf.TensorArray</code></a>:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x): 
  ta = tf.TensorArray(dtype=tf.int32, size=0, dynamic_size=True) 
  for i in range(len(x)): 
    ta = ta.write(i, x[i] + 1) 
  return ta.stack() 
f(tf.constant([1, 2, 3])) 
&lt;tf.Tensor: ..., numpy=array([2, 3, 4], ...)&gt; 
</pre> <p><em><a href="function"><code translate="no" dir="ltr">tf.function</code></a> is polymorphic</em></p> <p>Internally, <a href="function"><code translate="no" dir="ltr">tf.function</code></a> can build more than one graph, to support arguments with different data types or shapes, since TensorFlow can build more efficient graphs that are specialized on shapes and dtypes. <a href="function"><code translate="no" dir="ltr">tf.function</code></a> also treats any pure Python value as opaque objects, and builds a separate graph for each set of Python arguments that it encounters.</p> <p>To obtain an individual graph, use the <code translate="no" dir="ltr">get_concrete_function</code> method of the callable created by <a href="function"><code translate="no" dir="ltr">tf.function</code></a>. It can be called with the same arguments as <code translate="no" dir="ltr">func</code> and returns a special <a href="graph"><code translate="no" dir="ltr">tf.Graph</code></a> object:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x): 
  return x + 1 
isinstance(f.get_concrete_function(1).graph, tf.Graph) 
True 
</pre> <aside class="caution"><strong>Caution:</strong><span> Passing python scalars or lists as arguments to <a href="function"><code translate="no" dir="ltr">tf.function</code></a> will always build a new graph. To avoid this, pass numeric arguments as Tensors whenever possible:</span></aside> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x): 
  return tf.abs(x) 
f1 = f.get_concrete_function(1) 
f2 = f.get_concrete_function(2)  # Slow - builds new graph 
f1 is f2 
False 
f1 = f.get_concrete_function(tf.constant(1)) 
f2 = f.get_concrete_function(tf.constant(2))  # Fast - reuses f1 
f1 is f2 
True 
</pre> <p>Python numerical arguments should only be used when they take few distinct values, such as hyperparameters like the number of layers in a neural network.</p> <p><em>Input signatures</em></p> <p>For Tensor arguments, <a href="function"><code translate="no" dir="ltr">tf.function</code></a> instantiates a separate graph for every unique set of input shapes and datatypes. The example below creates two separate graphs, each specialized to a different shape:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function 
def f(x): 
  return x + 1 
vector = tf.constant([1.0, 1.0]) 
matrix = tf.constant([[3.0]]) 
f.get_concrete_function(vector) is f.get_concrete_function(matrix) 
False 
</pre> <p>An "input signature" can be optionally provided to <a href="function"><code translate="no" dir="ltr">tf.function</code></a> to control the graphs traced. The input signature specifies the shape and type of each Tensor argument to the function using a <a href="tensorspec"><code translate="no" dir="ltr">tf.TensorSpec</code></a> object. More general shapes can be used. This is useful to avoid creating multiple graphs when Tensors have dynamic shapes. It also restricts the dhape and datatype of Tensors that can be used:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
@tf.function( 
    input_signature=[tf.TensorSpec(shape=None, dtype=tf.float32)]) 
def f(x): 
  return x + 1 
vector = tf.constant([1.0, 1.0]) 
matrix = tf.constant([[3.0]]) 
f.get_concrete_function(vector) is f.get_concrete_function(matrix) 
True 
</pre> <p><em>Variables may only be created once</em></p> <p><a href="function"><code translate="no" dir="ltr">tf.function</code></a> only allows creating new <a href="variable"><code translate="no" dir="ltr">tf.Variable</code></a> objects when it is called for the first time:</p> <pre class="devsite-click-to-copy prettyprint lang-py" translate="no" dir="ltr" data-language="python">
class MyModule(tf.Module): 
  def __init__(self): 
    self.v = None 
 
  @tf.function 
  def call(self, x): 
    if self.v is None: 
      self.v = tf.Variable(tf.ones_like(x)) 
    return self.v * x 
</pre> <p>In general, it is recommended to create stateful objects like <a href="variable"><code translate="no" dir="ltr">tf.Variable</code></a> outside of <a href="function"><code translate="no" dir="ltr">tf.function</code></a> and passing them as arguments.</p> <h4 id="args_2">Args:</h4> <ul> <li>
<b><code translate="no" dir="ltr">func</code></b>: the function to be compiled. If <code translate="no" dir="ltr">func</code> is None, <a href="function"><code translate="no" dir="ltr">tf.function</code></a> returns a decorator that can be invoked with a single argument - <code translate="no" dir="ltr">func</code>. In other words, <code translate="no" dir="ltr">tf.function(input_signature=...)(func)</code> is equivalent to <a href="function"><code translate="no" dir="ltr">tf.function(func, input_signature=...)</code></a>. The former can be used as decorator.</li> <li>
<b><code translate="no" dir="ltr">input_signature</code></b>: A possibly nested sequence of <a href="tensorspec"><code translate="no" dir="ltr">tf.TensorSpec</code></a> objects specifying the shapes and dtypes of the Tensors that will be supplied to this function. If <code translate="no" dir="ltr">None</code>, a separate function is instantiated for each inferred input signature. If input_signature is specified, every input to <code translate="no" dir="ltr">func</code> must be a <code translate="no" dir="ltr">Tensor</code>, and <code translate="no" dir="ltr">func</code> cannot accept <code translate="no" dir="ltr">**kwargs</code>.</li> <li>
<b><code translate="no" dir="ltr">autograph</code></b>: Whether autograph should be applied on <code translate="no" dir="ltr">func</code> before tracing a graph. Data-dependent control flow requires <code translate="no" dir="ltr">autograph=True</code>. For more information, see the <a href="https://www.tensorflow.org/guide/function">tf.function and AutoGraph guide</a>.</li> <li>
<b><code translate="no" dir="ltr">experimental_implements</code></b>: If provided, contains a name of a "known" function this implements. For example "mycompany.my_recurrent_cell". This is stored as an attribute in inference function, which can then be detected when processing serialized function. See https://github.com/tensorflow/community/blob/master/rfcs/20190610-standardizing-composite_ops.md for details. For an example of utilizing this attribute see: https://github.com/tensorflow/tensorflow/blob/master/tensorflow/compiler/mlir/lite/transforms/prepare_composite_functions_tf.cc The code above automatically detects and substitutes function that implements "embedded_matmul" and allows TFLite to substitute its own implementations. For instance, a tensorflow user can use this attribute to mark that their function also implements <code translate="no" dir="ltr">embedded_matmul</code>`` (perhaps more efficiently!) by specifying it using this flag.</li> </ul> <pre class="prettyprint" translate="no" dir="ltr" data-language="python">@tf.function(experimental_implements="embedded_matmul"):
def embedding_matmul(a, b):
   # custom implementation here
</pre> <ul> <li>
<b><code translate="no" dir="ltr">experimental_autograph_options</code></b>: Optional tuple of <code translate="no" dir="ltr">tf.autograph.experimental.Feature</code> values.</li> <li>
<b><code translate="no" dir="ltr">experimental_relax_shapes</code></b>: When True, <code translate="no" dir="ltr">tf.function</code> may generate fewer, graphs that are less specialized on input shapes.</li> <li>
<b><code translate="no" dir="ltr">experimental_compile</code></b>: If True, the function is always compiled by <a href="https://www.tensorflow.org/xla">XLA</a>. XLA may be more efficient in some cases (e.g. TPU, XLA_GPU, dense tensor computations).</li> </ul> <h4 id="returns_2">Returns:</h4> <p>If <code translate="no" dir="ltr">func</code> is not None, returns a callable that will execute the compiled function (and return zero or more <code translate="no" dir="ltr">tf.Tensor</code> objects). If <code translate="no" dir="ltr">func</code> is None, returns a decorator that, when invoked with a single <code translate="no" dir="ltr">func</code> argument, returns a callable equivalent to the case above.</p> <h2 id="compat_aliases_2">Compat aliases</h2> <ul> <li><code translate="no" dir="ltr">tf.compat.v1.function</code></li> <li><code translate="no" dir="ltr">tf.compat.v2.function</code></li> </ul>  <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0"> </devsite-page-rating><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2019 The TensorFlow Authors. All rights reserved.<br>Licensed under the Creative Commons Attribution License 3.0.<br>Code samples licensed under the Apache 2.0 License.<br>
    <a href="https://www.tensorflow.org/api_docs/python/tf/function" class="_attribution-link">https://www.tensorflow.org/api_docs/python/tf/function</a>
  </p>
</div>
