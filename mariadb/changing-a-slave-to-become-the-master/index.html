<h1>Changing a Slave to Become the Master</h1> <div> <div class="node creole"> <div class="answer formatted"> <p> This article describes how to change a slave to become a master and optionally to set the old master as a slave for the new master.</p> <p>A typical scenario of when this is useful is if you have set up a new version of MariaDB as a slave, for example for testing, and want to upgrade your master to the new version.</p> <p>In MariaDB replication, a slave should be of a version same or newer than the master. Because of this, one should first upgrades all slaves to the latest version before changing a slave to be a master. In some cases one can have a slave to be of an older version than the master, as long as one doesn't execute on the master any SQL commands that the slave doesn't understand. This is however not guaranteed between all major MariaDB versions.</p> <p>Note that in the examples below, <code class="fixed" style="white-space:pre-wrap">[connection_name]</code> is used as the <a href="../multi-source-replication/index">name of the connection</a>. If you are not using named connections you can ignore this.</p> <h3 class="anchored_heading" id="stopping-the-original-master">Stopping the Original Master.</h3> <p>First one needs to take down the original master in such a way that the slave has all information on the master.</p> <p>If you are using <a href="../semisynchronous-replication/index">Semisynchronous Replication</a> you can just stop the server with the <a href="../shutdown/index">SHUTDOWN</a> command as the slaves should be automatically up to date.</p> <p>If you are using <a href="../maxscale/index">MariaDB MaxScale proxy</a>, then you <a href="https://mariadb.com/resources/blog/mariadb-maxscale-2-2-introducing-failover-switchover-and-automatic-rejoin">can use MaxScale</a> to handle the whole process of taking down the master and replacing it with one of the slaves.</p> <p>If neither of the above is true, you have to do this step manually:</p> <h4 class="anchored_heading" id="manually-take-down-the-master">Manually Take Down the Master</h4> <p>First we have to set the master to read only to ensure that there are no new updates on the master:</p> <pre class="fixed" data-language="sql">FLUSH TABLES WITH READ LOCK;
</pre>
<p>Note that you should not disconnect this session as otherwise the read lock will disappear and you have to start from the beginning.</p> <p>Then you should check the current position of the master:</p> <pre class="fixed" data-language="sql">SHOW MASTER STATUS;
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| mariadb-bin.000003 |      343 |              |                  |
+--------------------+----------+--------------+------------------+
SELECT @@global.gtid_binlog_pos;
+--------------------------+
| @@global.gtid_binlog_pos |
+--------------------------+
| 0-1-2                    |
+--------------------------+
</pre>
<p>And wait until you have the same position on the slave: (The following should be excepted on the slave)</p> <pre class="fixed" data-language="sql">SHOW SLAVE [connection_name] STATUS;
+-------------------+-------------------+
Master_Log_File     | narttu-bin.000003 +
Read_Master_Log_Pos | 343               +
Exec_Master_Log_Pos | 343               +
...
Gtid_IO_Pos          0-1-2              +
+-------------------+-------------------+
</pre>
<p>The most important information to watch are <code>Master_Log_File</code> and <code>Exec_Master_Log_Pos</code> as when this matches the master, it signals that all transactions has been committed on the slave.</p> <p>Note that <code>Gtid_IO_Pos</code> on slave can contain many different positions separated with ',' if the slave has been connected to many different masters. What is important is that all the sequences that are on the master is also on the slave.</p> <p>When slave is up to date, you can then take the <strong>MASTER</strong> down. This should be on the same connection where you executed <code><a href="../flush/index">FLUSH TABLES WITH READ LOCK</a></code>.</p> <pre class="fixed" data-language="sql">SHUTDOWN;
</pre>
<h3 class="anchored_heading" id="preparing-the-slave-to-be-a-master">Preparing the Slave to be a Master</h3> <p>Stop all old connections to the old master(s) and reset <strong>read only mode</strong>, if you had it enabled. You also want to save the values of <code><a href="../show-master-status/index">SHOW MASTER STATUS</a></code> and <code>gtid_binlog_pos</code>, as you may need these to setup new slaves.</p> <pre class="fixed" data-language="sql">STOP ALL SLAVES;
RESET SLAVE ALL;
SHOW MASTER STATUS;
SELECT @@global.gtid_binlog_pos;
SET @@global.read_only=0;
</pre>
<h3 class="anchored_heading" id="reconnect-other-slaves-to-the-new-master">Reconnect Other Slaves to the New Master</h3> <p>On the other slaves you have point them to the new master (the slave you promoted to a master).</p> <pre class="fixed" data-language="sql">STOP SLAVE [connection_name];
CHANGE MASTER [connection_name] TO MASTER_HOST="new_master_name",
MASTER_PORT=3306, MASTER_USER='root', MASTER_USE_GTID=current_pos,
MASTER_LOG_FILE="XXX", MASTER_LOG_POS=XXX;
START SLAVE;
</pre>
<p>The <code class="fixed" style="white-space:pre-wrap">XXX</code> values for <code>MASTER_LOG_FILE</code> and <code>MASTER_LOG_POS</code> should be the values you got from the <code>SHOW MASTER STATUS</code> command you did when you finished setting up the slave.</p> <h3 class="anchored_heading" id="changing-the-old-master-to-be-a-slave">Changing the Old Master to be a Slave</h3> <p>Now you can upgrade the new master to a newer version of MariaDB and then follow the same procedure to connect it as a slave.</p> <p>When starting the original master, it's good to start the <code>mysqld</code> executable with the <code>--with-skip-slave-start</code> and <code>--read-only</code> options to ensure that no old slave configurations could cause any conflicts.</p> <p>For the same reason it's also good to execute the following commands on the old master (same as for other slaves, but with some extra security). The <code>read_only</code> option below is there to ensure that old applications doesn't by accident try to update the old master by mistake. It only affects normal connections to the slave, not changes from the new master.</p> <pre class="fixed" data-language="sql">set @@global.read_only=1;
STOP ALL SLAVES;
RESET MASTER;
RESET SLAVE ALL;
CHANGE MASTER [connection_name] TO MASTER_HOST="new_master_name",
MASTER_PORT=3306, MASTER_USER='root', MASTER_USE_GTID=current_pos,
MASTER_LOG_FILE="XXX", MASTER_LOG_POS=XXX;
START SLAVE;
</pre>
<h3 class="anchored_heading" id="moving-applications-to-use-new-master">Moving Applications to Use New Master</h3> <p>You should now point your applications to use the new master. If you are using the <a href="../maxscale/index">MariaDB MaxScale proxy</a>, then you don't have to do this step as MaxScale will take care of sending write request to the new master.</p> <h3 class="anchored_heading" id="see-also">See Also</h3> <ul start="1">
<li>
<a href="../change-master-to/index">CHANGE MASTER TO</a> command </li>
<li>
<a href="https://mariadb.com/resources/blog/mariadb-maxscale-2-2-introducing-failover-switchover-and-automatic-rejoin">MaxScale Blog about using Switchover to swap a master and slave</a> </li>
<li><a href="https://www.percona.com/blog/2015/12/01/upgrade-master-server-minimal-downtime">Percona blog about how to upgrade slave to master</a></li>
</ul> </div>     </div> <div id="content_disclaimer" class="graybox"> Content reproduced on this site is the property of its respective owners, and this content is not reviewed in advance by MariaDB. The views, information and opinions expressed by this content do not necessarily represent those of MariaDB or any other party. </div> </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://mariadb.com/kb/en/changing-a-slave-to-become-the-master/" class="_attribution-link" target="_blank">https://mariadb.com/kb/en/changing-a-slave-to-become-the-master/</a>
  </p>
</div>
