<h1>Filesort with Small LIMIT Optimization</h1> <div> <div class="node creole"> <div class="answer formatted">  <h2 class="anchored_heading" id="optimization-description">Optimization description</h2> <p>MySQL 5.6 has an optimization for <code>ORDER BY ...LIMIT n</code> queries. When <code>n</code> is sufficiently small, the optimizer will use a <a href="http://en.wikipedia.org/wiki/Priority_queue">priority queue</a> for sorting. The alternative is, roughly speaking, to sort the entire output and then pick only first <code>n</code> rows.</p> <p>The optimization was ported into <a href="../what-is-mariadb-100/index">MariaDB 10.0</a> in version 10.0.0. The server would not give any indication of whether the optimization was used, though. (This is how the feature was designed by Oracle. In MySQL 5.6, the only way one can see this feature is to examine the optimizer_trace, which is not currently supported by MariaDB).</p> <h2 class="anchored_heading" id="optimization-visibility-in-mariadb">Optimization visibility in MariaDB</h2> <div class="mariadb_from_10_0_13 mariadb from_10_0_13 product">
<strong class="product_title">MariaDB starting with <a href="https://mariadb.com/kb/en/mariadb-10013-release-notes/">10.0.13</a></strong><p>Starting from <a href="https://mariadb.com/kb/en/mariadb-10013-release-notes/">MariaDB 10.0.13</a>, there are two ways to check whether filesort has used a priority queue.</p> </div>
<h3 class="anchored_heading" id="status-variable">Status variable</h3> <p>The first way is to check the <a href="../server-status-variables/index#sort_priority_queue_sorts">Sort_priority_queue_sorts</a> status variable. It shows the number of times that sorting was done through a priority queue. (The total number of times sorting was done is a sum <a href="../server-status-variables/index#sort_range">Sort_range</a> and <a href="../server-status-variables/index#sort_scan">Sort_scan</a>).</p> <h3 class="anchored_heading" id="slow-query-log">Slow query log</h3> <p>The second way is to check the slow query log. When one uses <a href="../slow-query-log-extended-statistics/index">Extended statistics in the slow query log</a> and specifies <a href="../server-system-variables/index#log_slow_verbosity">log_slow_verbosity=query_plan</a>, <a href="../slow-query-log/index">slow query log</a> entries look like this</p> <pre class="fixed" data-language="sql"># Time: 140714 18:30:39
# User@Host: root[root] @ localhost []
# Thread_id: 3  Schema: test  QC_hit: No
# Query_time: 0.053857  Lock_time: 0.000188  Rows_sent: 11  Rows_examined: 100011
# Full_scan: Yes  Full_join: No  Tmp_table: No  Tmp_table_on_disk: No
# Filesort: Yes  Filesort_on_disk: No  Merge_passes: 0  Priority_queue: Yes
SET timestamp=1405348239;SET timestamp=1405348239;
select * from t1 where col1 between 10 and 20 order by col2 limit 100;
</pre>
<p>Note the "Priority_queue: Yes" on the last comment line. (<code>pt-query-digest</code> is able to parse slow query logs with the Priority_queue field)</p> <p>As for <code>EXPLAIN</code>, it will give no indication whether filesort uses priority queue or the generic quicksort and merge algorithm. <code>Using filesort</code> will be shown in both cases, by both MariaDB and MySQL.</p> <h2 class="anchored_heading" id="see-also">See also</h2> <ul start="1">
<li>
<a href="http://dev.mysql.com/doc/refman/5.6/en/limit-optimization.html">LIMIT Optimization</a> page in the MySQL 5.6 manual (search for "priority queue"). </li>
<li>MySQL WorkLog entry, <a href="http://dev.mysql.com/worklog/task/?id=1393">WL#1393</a> </li>
<li>
<a href="https://jira.mariadb.org/browse/MDEV-415">MDEV-415</a>, <a href="https://jira.mariadb.org/browse/MDEV-6430">MDEV-6430</a>
</li>
</ul> </div>     </div> <div id="content_disclaimer" class="graybox"> Content reproduced on this site is the property of its respective owners, and this content is not reviewed in advance by MariaDB. The views, information and opinions expressed by this content do not necessarily represent those of MariaDB or any other party. </div> </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://mariadb.com/kb/en/filesort-with-small-limit-optimization/" class="_attribution-link" target="_blank">https://mariadb.com/kb/en/filesort-with-small-limit-optimization/</a>
  </p>
</div>
