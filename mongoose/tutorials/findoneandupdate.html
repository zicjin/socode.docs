<a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/tutorials/findoneandupdate.md" target="_blank"> <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCAxMDAwIDEwMDAiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDEwMDAgMTAwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz48ZyB0cmFuc2Zvcm09Im1hdHJpeCgxIDAgMCAtMSAwIDQ4MCkiPjxwYXRoIHN0cm9rZT0iIzA5NzFCMiIgZmlsbD0iIzA5NzFCMiIgZD0iTTkzMC45LDQyMC41Yy0zMy4xLDMxLjgtNjkuMyw0Ny43LTEwOC43LDQ3LjdjLTQ0LjUsMC04My45LTE3LjItMTE4LjItNTEuNUw5OS40LTE4NS45Yy0zLjgtMy44LTYuNC04LjktNy42LTE1LjNjLTIuNS04LjktMjkuMi05Ny45LTgwLjEtMjY3Yy0zLjgtMTIuNy0xLjMtMjMuNSw3LjYtMzIuNGM2LjQtNS4xLDE0LTcuNiwyMi45LTcuNmg5LjVjMTMyLjIsNDQuNSwyMTkuOSw3My4xLDI2My4yLDg1LjhjMy44LDEuMyw3LjYsMy44LDExLjQsNy42YzM3NSwzNzAsNTc3LjIsNTcwLjIsNjA2LjQsNjAwLjdjMzguMSwzOS40LDU3LjIsNzkuNSw1Ny4yLDEyMC4xQzk4OC43LDM0Ni44LDk2OSwzODQuOSw5MzAuOSw0MjAuNXogTTY5NC40LDMxOS40YzMxLjgtNy42LDYxLjctMjUuNCw4OS42LTUzLjRjMjYuNy0yNi43LDQzLjItNTcuMiw0OS42LTkxLjVDNzQ3LjIsODguMSw1NzguNy03OS4xLDMyOC4zLTMyN2MtMTIuNywzMC41LTI5LjksNTYuNi01MS41LDc4LjJjLTI2LjcsMjYuNy01Ni42LDQ3LTg5LjYsNjFMMzMyLjEtNDIuOWwyMTAuNywyMTAuN0w2OTQuNCwzMTkuNHogTTE0NS4yLTIzOS4zYzMxLjgtNy42LDYxLTI1LjQsODcuNy01My40YzIxLjYtMjEuNiwzNi45LTQ3LDQ1LjgtNzYuM2MtMTIuNy0zLjgtNDIuOS0xNC05MC42LTMwLjVjLTQ3LjctMTYuNS04Mi4zLTI4LTEwMy45LTM0LjNjNi40LDE5LjEsMTYuOCw1Mi4xLDMxLjUsOTkuMkMxMzAuMy0yODcuNiwxNDAuMS0yNTUuOCwxNDUuMi0yMzkuM3ogTTg4OC45LDIyOS44bC01LjctNS43Yy0xMi43LDMzLjEtMzEuMSw2MS43LTU1LjMsODUuOEM4MDIuNSwzMzUuMyw3NzQuNSwzNTUsNzQ0LDM2OWwxLjksMS45bDEuOSwxLjljMjIuOSwyMi45LDQ3LjcsMzQuMyw3NC40LDM0LjNjMjIuOSwwLDQ1LjEtMTAuOCw2Ni43LTMyLjRjMjUuNC0yNC4yLDM4LjEtNDcuNywzOC4xLTcwLjZTOTE0LjQsMjU2LjUsODg4LjksMjI5Ljh6Ii8+PC9nPjwvZz4NCjwvc3ZnPg=="> </a><h1 id="how-to-use-findoneandupdate-in-mongoose">  How to Use <code>findOneAndUpdate()</code> in Mongoose  </h1>   <p>The <a href="https://mongoosejs.com/docs/api.html#query_Query-findOneAndUpdate"><code>findOneAndUpdate()</code> function in Mongoose</a> has a wide variety of use cases. <a href="https://masteringjs.io/tutorials/mongoose/update">You should use <code>save()</code> to update documents where possible</a>, but there are some cases where you need to use <a href="https://masteringjs.io/tutorials/mongoose/findoneandupdate"><code>findOneAndUpdate()</code></a>. In this tutorial, you'll see how to use <code>findOneAndUpdate()</code>, and learn when you need to use it.</p> <ul> <li><a href="#getting-started">Getting Started</a></li> <li><a href="#atomic-updates">Atomic Updates</a></li> <li><a href="#upsert">Upsert</a></li> <li><a href="#raw-result">The <code>rawResult</code> Option</a></li> </ul> <h2 id="getting-started">  Getting Started  </h2> <p>As the name implies, <code>findOneAndUpdate()</code> finds the first document that matches a given <code>filter</code>, applies an <code>update</code>, and returns the document. By default, <code>findOneAndUpdate()</code> returns the document as it was <strong>before</strong> <code>update</code> was applied.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> Character = mongoose.model(<span class="hljs-string">'Character'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">Number</span>
}));

<span class="hljs-keyword">await</span> Character.create({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> });

<span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">59</span> };

<span class="hljs-comment">// `doc` is the document _before_ `update` was applied</span>
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Character.findOneAndUpdate(filter, update);
doc.name; <span class="hljs-comment">// 'Jean-Luc Picard'</span>
doc.age; <span class="hljs-comment">// undefined</span>

doc = <span class="hljs-keyword">await</span> Character.findOne(filter);
doc.age; <span class="hljs-comment">// 59</span>
</pre> <p>You should set the <code>new</code> option to <code>true</code> to return the document <strong>after</strong> <code>update</code> was applied.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">59</span> };

<span class="hljs-comment">// `doc` is the document _after_ `update` was applied because of</span>
<span class="hljs-comment">// `new: true`</span>
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Character.findOneAndUpdate(filter, update, {
  <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span>
});
doc.name; <span class="hljs-comment">// 'Jean-Luc Picard'</span>
doc.age; <span class="hljs-comment">// 59</span>
</pre> <p>Mongoose's <code>findOneAndUpdate()</code> is slightly different from <a href="http://mongodb.github.io/node-mongodb-native/3.1/api/Collection.html#findOneAndUpdate">the MongoDB Node.js driver's <code>findOneAndUpdate()</code></a> because it returns the document itself, not a <a href="http://mongodb.github.io/node-mongodb-native/3.1/api/Collection.html#~findAndModifyWriteOpResult">result object</a>.</p> <p>As an alternative to the <code>new</code> option, you can also use the <code>returnOriginal</code> option. <code>returnOriginal: false</code> is equivalent to <code>new: true</code>. The <code>returnOriginal</code> option exists for consistency with the <a href="http://mongodb.github.io/node-mongodb-native/3.1/api/Collection.html#findOneAndUpdate">the MongoDB Node.js driver's <code>findOneAndUpdate()</code></a>, which has the same option.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">59</span> };

<span class="hljs-comment">// `doc` is the document _after_ `update` was applied because of</span>
<span class="hljs-comment">// `returnOriginal: false`</span>
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Character.findOneAndUpdate(filter, update, {
  <span class="hljs-attr">returnOriginal</span>: <span class="hljs-literal">false</span>
});
doc.name; <span class="hljs-comment">// 'Jean-Luc Picard'</span>
doc.age; <span class="hljs-comment">// 59</span>
</pre> <h2 id="atomic-updates">  Atomic Updates  </h2> <p>With the exception of an <a href="https://docs.mongodb.com/manual/reference/method/db.collection.findAndModify/#upsert-with-unique-index">unindexed upsert</a>, <a href="https://docs.mongodb.com/manual/core/write-operations-atomicity/#atomicity"><code>findOneAndUpdate()</code> is atomic</a>. That means you can assume the document doesn't change between when MongoDB finds the document and when it updates the document, <em>unless</em> you're doing an <a href="#upsert">upsert</a>.</p> <p>For example, if you're using <code>save()</code> to update a document, the document can change in MongoDB in between when you load the document using <code>findOne()</code> and when you save the document using <code>save()</code> as show below. For many use cases, the <code>save()</code> race condition is a non-issue. But you can work around it with <code>findOneAndUpdate()</code> (or <a href="../transactions">transactions</a>) if you need to.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">59</span> };

<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Character.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Jean-Luc Picard'</span> });

<span class="hljs-comment">// Document changed in MongoDB, but not in Mongoose</span>
<span class="hljs-keyword">await</span> Character.updateOne(filter, { <span class="hljs-attr">name</span>: <span class="hljs-string">'Will Riker'</span> });

<span class="hljs-comment">// This will update `doc` age to `59`, even though the doc changed.</span>
doc.age = <span class="hljs-number">59</span>;
<span class="hljs-keyword">await</span> doc.save();

doc = <span class="hljs-keyword">await</span> Character.findOne();
doc.name; <span class="hljs-comment">// Will Riker</span>
doc.age; <span class="hljs-comment">// 59</span>
</pre> <h2 id="upsert">  Upsert  </h2> <p>Using the <code>upsert</code> option, you can use <code>findOneAndUpdate()</code> as a find-and-<a href="https://docs.mongodb.com/manual/reference/method/db.collection.update/#db.collection.update">upsert</a> operation. An upsert behaves like a normal <code>findOneAndUpdate()</code> if it finds a document that matches <code>filter</code>. But, if no document matches <code>filter</code>, MongoDB will insert one by combining <code>filter</code> and <code>update</code> as shown below.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Will Riker'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">29</span> };

<span class="hljs-keyword">await</span> Character.countDocuments(filter); <span class="hljs-comment">// 0</span>

<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> Character.findOneAndUpdate(filter, update, {
  <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">upsert</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// Make this update into an upsert</span>
});
doc.name; <span class="hljs-comment">// Will Riker</span>
doc.age; <span class="hljs-comment">// 29</span>
</pre> <h2 id="raw-result">The `rawResult` Option</h2> <p>Mongoose transforms the result of <code>findOneAndUpdate()</code> by default: it returns the updated document. That makes it difficult to check whether a document was upserted or not. In order to get the updated document and check whether MongoDB upserted a new document in the same operation, you can set the <code>rawResult</code> flag to make Mongoose return the raw result from MongoDB.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> filter = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Will Riker'</span> };
<span class="hljs-keyword">const</span> update = { <span class="hljs-attr">age</span>: <span class="hljs-number">29</span> };

<span class="hljs-keyword">await</span> Character.countDocuments(filter); <span class="hljs-comment">// 0</span>

<span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> Character.findOneAndUpdate(filter, update, {
  <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">upsert</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">rawResult</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// Return the raw result from the MongoDB driver</span>
});

res.value <span class="hljs-keyword">instanceof</span> Character; <span class="hljs-comment">// true</span>
<span class="hljs-comment">// The below property will be `false` if MongoDB upserted a new</span>
<span class="hljs-comment">// document, and `true` if MongoDB updated an existing object.</span>
res.lastErrorObject.updatedExisting; <span class="hljs-comment">// false</span>
</pre> <p>Here's what the <code>res</code> object from the above example looks like:</p> <pre data-language="javascript">{ <span class="hljs-attr">lastErrorObject</span>:
   { <span class="hljs-attr">n</span>: <span class="hljs-number">1</span>,
     <span class="hljs-attr">updatedExisting</span>: <span class="hljs-literal">false</span>,
     <span class="hljs-attr">upserted</span>: <span class="hljs-number">5e6</span>a9e5ec6e44398ae2ac16a },
  <span class="hljs-attr">value</span>:
   { <span class="hljs-attr">_id</span>: <span class="hljs-number">5e6</span>a9e5ec6e44398ae2ac16a,
     <span class="hljs-attr">name</span>: <span class="hljs-string">'Will Riker'</span>,
     <span class="hljs-attr">__v</span>: <span class="hljs-number">0</span>,
     <span class="hljs-attr">age</span>: <span class="hljs-number">29</span> },
  <span class="hljs-attr">ok</span>: <span class="hljs-number">1</span> }
</pre><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://mongoosejs.com/docs/tutorials/findoneandupdate.html" class="_attribution-link" target="_blank">https://mongoosejs.com/docs/tutorials/findoneandupdate.html</a>
  </p>
</div>
