<a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/plugins.md" target="_blank"> <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCAxMDAwIDEwMDAiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDEwMDAgMTAwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz48ZyB0cmFuc2Zvcm09Im1hdHJpeCgxIDAgMCAtMSAwIDQ4MCkiPjxwYXRoIHN0cm9rZT0iIzA5NzFCMiIgZmlsbD0iIzA5NzFCMiIgZD0iTTkzMC45LDQyMC41Yy0zMy4xLDMxLjgtNjkuMyw0Ny43LTEwOC43LDQ3LjdjLTQ0LjUsMC04My45LTE3LjItMTE4LjItNTEuNUw5OS40LTE4NS45Yy0zLjgtMy44LTYuNC04LjktNy42LTE1LjNjLTIuNS04LjktMjkuMi05Ny45LTgwLjEtMjY3Yy0zLjgtMTIuNy0xLjMtMjMuNSw3LjYtMzIuNGM2LjQtNS4xLDE0LTcuNiwyMi45LTcuNmg5LjVjMTMyLjIsNDQuNSwyMTkuOSw3My4xLDI2My4yLDg1LjhjMy44LDEuMyw3LjYsMy44LDExLjQsNy42YzM3NSwzNzAsNTc3LjIsNTcwLjIsNjA2LjQsNjAwLjdjMzguMSwzOS40LDU3LjIsNzkuNSw1Ny4yLDEyMC4xQzk4OC43LDM0Ni44LDk2OSwzODQuOSw5MzAuOSw0MjAuNXogTTY5NC40LDMxOS40YzMxLjgtNy42LDYxLjctMjUuNCw4OS42LTUzLjRjMjYuNy0yNi43LDQzLjItNTcuMiw0OS42LTkxLjVDNzQ3LjIsODguMSw1NzguNy03OS4xLDMyOC4zLTMyN2MtMTIuNywzMC41LTI5LjksNTYuNi01MS41LDc4LjJjLTI2LjcsMjYuNy01Ni42LDQ3LTg5LjYsNjFMMzMyLjEtNDIuOWwyMTAuNywyMTAuN0w2OTQuNCwzMTkuNHogTTE0NS4yLTIzOS4zYzMxLjgtNy42LDYxLTI1LjQsODcuNy01My40YzIxLjYtMjEuNiwzNi45LTQ3LDQ1LjgtNzYuM2MtMTIuNy0zLjgtNDIuOS0xNC05MC42LTMwLjVjLTQ3LjctMTYuNS04Mi4zLTI4LTEwMy45LTM0LjNjNi40LDE5LjEsMTYuOCw1Mi4xLDMxLjUsOTkuMkMxMzAuMy0yODcuNiwxNDAuMS0yNTUuOCwxNDUuMi0yMzkuM3ogTTg4OC45LDIyOS44bC01LjctNS43Yy0xMi43LDMzLjEtMzEuMSw2MS43LTU1LjMsODUuOEM4MDIuNSwzMzUuMyw3NzQuNSwzNTUsNzQ0LDM2OWwxLjksMS45bDEuOSwxLjljMjIuOSwyMi45LDQ3LjcsMzQuMyw3NC40LDM0LjNjMjIuOSwwLDQ1LjEtMTAuOCw2Ni43LTMyLjRjMjUuNC0yNC4yLDM4LjEtNDcuNywzOC4xLTcwLjZTOTE0LjQsMjU2LjUsODg4LjksMjI5Ljh6Ii8+PC9nPjwvZz4NCjwvc3ZnPg=="> </a><h1 id="plugins">  Plugins  </h1>   <p>Schemas are pluggable, that is, they allow for applying pre-packaged capabilities to extend their functionality. This is a very powerful feature.</p>  <h2 id="example">Example</h2> <p>Plugins are a tool for reusing logic in multiple schemas. Suppose you have several models in your database and want to add a <code>loadedAt</code> property to each one. Just create a plugin once and apply it to each <code>Schema</code>:</p> <pre data-language="javascript"><span class="hljs-comment">// loadedAt.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadedAtPlugin</span>(<span class="hljs-params">schema, options</span>) {
  schema.<span class="hljs-title function_">virtual</span>(<span class="hljs-string">'loadedAt'</span>).
    <span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_loadedAt</span>; }).
    <span class="hljs-title function_">set</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_loadedAt</span> = v; });

  schema.<span class="hljs-title function_">post</span>([<span class="hljs-string">'find'</span>, <span class="hljs-string">'findOne'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">docs</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(docs)) {
      docs = [docs];
    }
    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> doc <span class="hljs-keyword">of</span> docs) {
      doc.<span class="hljs-property">loadedAt</span> = now;
    }
  });
};

<span class="hljs-comment">// game-schema.js</span>
<span class="hljs-keyword">const</span> loadedAtPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./loadedAt'</span>);
<span class="hljs-keyword">const</span> gameSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ ... });
gameSchema.<span class="hljs-title function_">plugin</span>(loadedAtPlugin);

<span class="hljs-comment">// player-schema.js</span>
<span class="hljs-keyword">const</span> loadedAtPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./loadedAt'</span>);
<span class="hljs-keyword">const</span> playerSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ ... });
playerSchema.<span class="hljs-title function_">plugin</span>(loadedAtPlugin);
</pre> <p>We just added last-modified behavior to both our <code>Game</code> and <code>Player</code> schemas and declared an index on the <code>lastMod</code> path of our Games to boot. Not bad for a few lines of code.</p> <h2 id="global">Global Plugins</h2> <p>Want to register a plugin for all schemas? The mongoose singleton has a <code>.plugin()</code> function that registers a plugin for every schema. For example:</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
mongoose.<span class="hljs-title function_">plugin</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./loadedAt'</span>));

<span class="hljs-keyword">const</span> gameSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ ... });
<span class="hljs-keyword">const</span> playerSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ ... });
<span class="hljs-comment">// `loadedAtPlugin` gets attached to both schemas</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Game</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Game'</span>, gameSchema);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Player</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Player'</span>, playerSchema);
</pre> <h2 id="apply-plugins-before-compiling-models">Apply Plugins Before Compiling Models</h2> <p>Because many plugins rely on <a href="middleware">middleware</a>, you should make sure to apply plugins <strong>before</strong> you call <code>mongoose.model()</code> or <code>conn.model()</code>. Otherwise, <a href="middleware#defining">any middleware the plugin registers won't get applied</a>.</p> <pre data-language="javascript"><span class="hljs-comment">// loadedAt.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadedAtPlugin</span>(<span class="hljs-params">schema, options</span>) {
  schema.<span class="hljs-title function_">virtual</span>(<span class="hljs-string">'loadedAt'</span>).
    <span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_loadedAt</span>; }).
    <span class="hljs-title function_">set</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_loadedAt</span> = v; });

  schema.<span class="hljs-title function_">post</span>([<span class="hljs-string">'find'</span>, <span class="hljs-string">'findOne'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">docs</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(docs)) {
      docs = [docs];
    }
    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> doc <span class="hljs-keyword">of</span> docs) {
      doc.<span class="hljs-property">loadedAt</span> = now;
    }
  });
};

<span class="hljs-comment">// game-schema.js</span>
<span class="hljs-keyword">const</span> loadedAtPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./loadedAt'</span>);
<span class="hljs-keyword">const</span> gameSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ ... });
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Game</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Game'</span>, gameSchema);

<span class="hljs-comment">// `find()` and `findOne()` hooks from `loadedAtPlugin()` won't get applied</span>
<span class="hljs-comment">// because `mongoose.model()` was already called!</span>
gameSchema.<span class="hljs-title function_">plugin</span>(loadedAtPlugin);
</pre> <h2 id="official">Officially Supported Plugins</h2> <p>The Mongoose team maintains several plugins that add cool new features to Mongoose. Here's a couple:</p> <ul> <li>
<a href="http://plugins.mongoosejs.io/plugins/autopopulate">mongoose-autopopulate</a>: Always <a href="populate"><code>populate()</code></a> certain fields in your Mongoose schemas.</li> <li>
<a href="http://plugins.mongoosejs.io/plugins/lean-virtuals">mongoose-lean-virtuals</a>: Attach virtuals to the results of Mongoose queries when using <a href="https://mongoosejs.com/docs/api.html#query_Query-lean"><code>.lean()</code></a>.</li> <li><a href="https://www.npmjs.com/package/mongoose-cast-aggregation">mongoose-cast-aggregation</a></li> </ul> <p>You can find a full list of officially supported plugins on <a href="https://plugins.mongoosejs.io/">Mongoose's plugins search site</a>.</p> <h2 id="community">  Community!  </h2> <p>Not only can you re-use schema functionality in your own projects, but you also reap the benefits of the Mongoose community as well. Any plugin published to <a href="https://npmjs.org/">npm</a> and with 'mongoose' as an <a href="https://docs.npmjs.com/files/package.json#keywords">npm keyword</a> will show up on our <a href="http://plugins.mongoosejs.io">search results</a> page.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://mongoosejs.com/docs/plugins.html" class="_attribution-link" target="_blank">https://mongoosejs.com/docs/plugins.html</a>
  </p>
</div>
