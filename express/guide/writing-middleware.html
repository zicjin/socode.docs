<h1 id="writing-middleware-for-use-in-express-apps" data-level="2">Writing middleware for use in Express apps</h1> <h2>Overview</h2> <p><em>Middleware</em> functions are functions that have access to the <a href="../index#req">request object</a> (<code>req</code>), the <a href="../index#res">response object</a> (<code>res</code>), and the <code>next</code> function in the application’s request-response cycle. The <code>next</code> function is a function in the Express router which, when invoked, executes the middleware succeeding the current middleware.</p> <p>Middleware functions can perform the following tasks:</p> <ul> <li>Execute any code.</li> <li>Make changes to the request and the response objects.</li> <li>End the request-response cycle.</li> <li>Call the next middleware in the stack.</li> </ul> <p>If the current middleware function does not end the request-response cycle, it must call <code>next()</code> to pass control to the next middleware function. Otherwise, the request will be left hanging.</p> <p>The following figure shows the elements of a middleware function call:</p> <table id="mw-fig"> <tr>
<td id="mw-fig-imgcell"> <img src="data:image/png;base64,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" id="mw-fig-img"> </td> <td class="mw-fig-callouts"> <div class="callout" id="callout1">HTTP method for which the middleware function applies.</div> <div class="callout" id="callout2">Path (route) for which the middleware function applies.</div> <div class="callout" id="callout3">The middleware function.</div> <div class="callout" id="callout4">Callback argument to the middleware function, called "next" by convention.</div> <div class="callout" id="callout5">HTTP <a href="../index#res">response</a> argument to the middleware function, called "res" by convention.</div> <div class="callout" id="callout6">HTTP <a href="../index#req">request</a> argument to the middleware function, called "req" by convention.</div> </td>
</tr> </table> <p>Starting with Express 5, middleware functions that return a Promise will call <code>next(value)</code> when they reject or throw an error. <code>next</code> will be called with either the rejected value or the thrown Error.</p> <h2>Example</h2> <p>Here is an example of a simple “Hello World” Express application. The remainder of this article will define and add three middleware functions to the application: one called <code>myLogger</code> that prints a simple log message, one called <code>requestTime</code> that displays the timestamp of the HTTP request, and one called <code>validateCookies</code> that validates incoming cookies.</p> <pre data-language="js">var express = require('express')
var app = express()

app.get('/', function (req, res) {
  res.send('Hello World!')
})

app.listen(3000)
</pre> <h3>Middleware function myLogger</h3> <p>Here is a simple example of a middleware function called “myLogger”. This function just prints “LOGGED” when a request to the app passes through it. The middleware function is assigned to a variable named <code>myLogger</code>.</p> <pre data-language="js">var myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}
</pre> <div class="doc-box doc-notice"> <p>Notice the call above to <code>next()</code>. Calling this function invokes the next middleware function in the app. The <code>next()</code> function is not a part of the Node.js or Express API, but is the third argument that is passed to the middleware function. The <code>next()</code> function could be named anything, but by convention it is always named “next”. To avoid confusion, always use this convention.</p> </div> <p>To load the middleware function, call <code>app.use()</code>, specifying the middleware function. For example, the following code loads the <code>myLogger</code> middleware function before the route to the root path (/).</p> <pre data-language="js">var express = require('express')
var app = express()

var myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}

app.use(myLogger)

app.get('/', function (req, res) {
  res.send('Hello World!')
})

app.listen(3000)
</pre> <p>Every time the app receives a request, it prints the message “LOGGED” to the terminal.</p> <p>The order of middleware loading is important: middleware functions that are loaded first are also executed first.</p> <p>If <code>myLogger</code> is loaded after the route to the root path, the request never reaches it and the app doesn’t print “LOGGED”, because the route handler of the root path terminates the request-response cycle.</p> <p>The middleware function <code>myLogger</code> simply prints a message, then passes on the request to the next middleware function in the stack by calling the <code>next()</code> function.</p> <h3>Middleware function requestTime</h3> <p>Next, we’ll create a middleware function called “requestTime” and add a property called <code>requestTime</code> to the request object.</p> <pre data-language="js">var requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}
</pre> <p>The app now uses the <code>requestTime</code> middleware function. Also, the callback function of the root path route uses the property that the middleware function adds to <code>req</code> (the request object).</p> <pre data-language="js">var express = require('express')
var app = express()

var requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}

app.use(requestTime)

app.get('/', function (req, res) {
  var responseText = 'Hello World!&lt;br&gt;'
  responseText += '&lt;small&gt;Requested at: ' + req.requestTime + '&lt;/small&gt;'
  res.send(responseText)
})

app.listen(3000)
</pre> <p>When you make a request to the root of the app, the app now displays the timestamp of your request in the browser.</p> <h3>Middleware function validateCookies</h3> <p>Finally, we’ll create a middleware function that validates incoming cookies and sends a 400 response if cookies are invalid.</p> <p>Here’s an example function that validates cookies with an external async service.</p> <pre data-language="js">async function cookieValidator (cookies) {
  try {
    await externallyValidateCookie(cookies.testCookie)
  } catch {
    throw new Error('Invalid cookies')
  }
}
</pre> <p>Here we use the <a href="http://expressjs.com/resources/middleware/cookie-parser.html"><code>cookie-parser</code></a> middleware to parse incoming cookies off the <code>req</code> object and pass them to our <code>cookieValidator</code> function. The <code>validateCookies</code> middleware returns a Promise that upon rejection will automatically trigger our error handler.</p> <pre data-language="js">var express = require('express')
var cookieParser = require('cookie-parser')
var cookieValidator = require('./cookieValidator')

var app = express()

async function validateCookies (req, res, next) {
  await cookieValidator(req.cookies)
  next()
}

app.use(cookieParser())

app.use(validateCookies)

// error handler
app.use(function (err, req, res, next) {
  res.status(400).send(err.message)
})

app.listen(3000)
</pre> <div class="doc-box doc-notice"> <p>Note how <code>next()</code> is called after <code>await cookieValidator(req.cookies)</code>. This ensures that if <code>cookieValidator</code> resolves, the next middleware in the stack will get called. If you pass anything to the <code>next()</code> function (except the string <code>'route'</code> or <code>'router'</code>), Express regards the current request as being an error and will skip any remaining non-error handling routing and middleware functions.</p> </div> <p>Because you have access to the request object, the response object, the next middleware function in the stack, and the whole Node.js API, the possibilities with middleware functions are endless.</p> <p>For more information about Express middleware, see: <a href="using-middleware">Using Express middleware</a>.</p> <h2>Configurable middleware</h2> <p>If you need your middleware to be configurable, export a function which accepts an options object or other parameters, which, then returns the middleware implementation based on the input parameters.</p> <p>File: <code>my-middleware.js</code></p> <pre data-language="js">module.exports = function (options) {
  return function (req, res, next) {
    // Implement the middleware function based on the options object
    next()
  }
}
</pre> <p>The middleware can now be used as shown below.</p> <pre data-language="js">var mw = require('./my-middleware.js')

app.use(mw({ option1: '1', option2: '2' }))
</pre> <p>Refer to <a href="https://github.com/expressjs/cookie-session">cookie-session</a> and <a href="https://github.com/expressjs/compression">compression</a> for examples of configurable middleware.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="http://expressjs.com/en/guide/writing-middleware.html" class="_attribution-link" target="_blank">http://expressjs.com/en/guide/writing-middleware.html</a>
  </p>
</div>
