<p>This package allows you to provide a way for your users to enable 2FA on their accounts, using an authenticator app such as Google Authenticator, or 1Password. When the user is logged in on your app, they will be able to generate a new QR code and read this code on the app they prefer. After that, they’ll start receiving their codes. Then, they can finish enabling 2FA on your app, and every time they try to log in to your app, you can redirect them to a place where they can provide a code they received from the authenticator.</p> <p>To provide codes that are exactly compatible with all other Authenticator apps and services that implements TOTP, this package uses <a href="https://www.npmjs.com/package/node-2fa" target="_blank" rel="noopener">node-2fa</a> which works on top of <a href="https://github.com/guyht/notp" target="_blank" rel="noopener">notp</a>, <strong>that</strong> implements TOTP (<a href="https://www.ietf.org/rfc/rfc6238.txt" target="_blank" rel="noopener">RFC 6238</a>) (the Authenticator standard), which is based on HOTP (<a href="https://www.ietf.org/rfc/rfc4226.txt" target="_blank" rel="noopener">RFC 4226</a>).</p> <blockquote> <p>This package is meant to be used with <a href="../api/passwords"><code>accounts-password</code></a> or <a href="accounts-passwordless"><code>accounts-passwordless</code></a>, so if you don’t have either of those in your project, you’ll need to add one of them. In the future, we want to enable the use of this package with other login methods, our oauth methods (Google, GitHub, etc…).</p> </blockquote> <h2 id="activating-2fa">Activating 2FA</h2> <p>The first step, in order to enable 2FA, is to generate a QR code so that the user can scan it in an authenticator app and start receiving codes.</p>  <h2 class="api-heading" id="Accounts-generate2faActivationQrCode"> <div class="locus"> Client </div> <code>Accounts.generate2faActivationQrCode(appName, callback)</code> <div class="subtext-api"> <code>import { Accounts } from 'meteor/accounts-base'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-2fa/2fa-client.js#L31" target="_blank"> (accounts-2fa/2fa-client.js, line 31) </a> </div> </h2>   <p>Generates a svg QR code and save secret on user</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>appName</code> <span class="type">String</span> </dt> <dd> <p>It's the name of your app that will show up when the user scans the QR code.</p> </dd> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Called with a single <code>Error</code> argument on failure. Or, on success, called with an object containing the QR code in SVG format (svg), the QR secret (secret), and the URI so the user can manually activate the 2FA without reading the QR code (uri).</p> </dd> </dl>   <p>Receives an <code>appName</code> which is the name of your app that will show up when the user scans the QR code. Also, a callback called, on success, with a QR code in SVG format, a QR secret, and the URI that can be used to activate the 2FA in an authenticator app, or a single <code>Error</code> argument on failure.</p> <p>On success, this function will also add an object to the logged user’s services object containing the QR secret:</p>  <pre class="line-numbers" style><code class="language-js">services: {
  ...
  twoFactorAuthentication: {
    secret: "***"
  }
}
</code></pre> <p>Here it’s an example on how to call this function:</p>  <pre class="line-numbers" style><code class="language-js">import { Buffer } from "buffer";
import { Accounts } from 'meteor/accounts-base';

--
  
const [qrCode, setQrCode] = useState(null);

--
  
&lt;button
  onClick={() =&gt; {
    Accounts.generate2faActivationQrCode("My app name", (err, result) =&gt; {
      if (err) {console.error("...", err);return;}
      const { svg, secret, uri } = result;
      /*
        the svg can be converted to base64, then be used like: 
         &lt;img 
            width="200"
            src={`data:image/svg+xml;base64,${qrCode}`}
         /&gt;
      */
      setQrCode(Buffer.from(svg).toString('base64'));
    })
  }}
&gt;
  Generate a new code
&lt;/button&gt;
</code></pre> <p>This method can fail throwing the following error:</p> <ul> <li>“The 2FA is activated. You need to disable the 2FA first before trying to generate a new activation code [2fa-activated]” if trying to generate an activation when the user already have 2FA enabled.</li> </ul> <p>At this point, the 2FA won’t be activated just yet. Now that the user has access to the codes generated by their authenticator app, you can call the function <code>Accounts.enableUser2fa</code>:</p>  <h2 class="api-heading" id="Accounts-enableUser2fa"> <div class="locus"> Client </div> <code>Accounts.enableUser2fa(code, [callback])</code> <div class="subtext-api"> <code>import { Accounts } from 'meteor/accounts-base'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-2fa/2fa-client.js#L57" target="_blank"> (accounts-2fa/2fa-client.js, line 57) </a> </div> </h2>   <p>Enable the user 2FA</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>code</code> <span class="type">String</span> </dt> <dd> <p>Code received from the authenticator app.</p> </dd> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Optional callback. Called with no arguments on success, or with a single <code>Error</code> argument on failure.</p> </dd> </dl>   <p>It should be called with a code that the users will receive from the authenticator app once they read the QR code. The callback is called with a single <code>Error</code> argument on failure. If the code provided is correct, a <code>type</code> will be added to the user’s <code>twoFactorAuthentication</code> object and now 2FA is considered enabled:</p>  <pre class="line-numbers" style><code class="language-js">services: {
  ...
  twoFactorAuthentication: {
    type: "otp",
    secret: "***",
  }
}
</code></pre> <p>To verify whether or not a user has 2FA enabled, you can call the function <code>Accounts.has2faEnabled</code>:</p>  <h2 class="api-heading" id="Accounts-has2faEnabled"> <div class="locus"> Client </div> <code>Accounts.has2faEnabled([callback])</code> <div class="subtext-api"> <code>import { Accounts } from 'meteor/accounts-base'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-2fa/2fa-client.js#L18" target="_blank"> (accounts-2fa/2fa-client.js, line 18) </a> </div> </h2>   <p>Verify if the logged user has 2FA enabled</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Called with a boolean on success that indicates whether the user has or not 2FA enabled, or with a single <code>Error</code> argument on failure.</p> </dd> </dl>   <p>This function must be called when the user is logged in.</p> <h2 id="disabling-2fa">Disabling 2FA</h2> <p>To disable 2FA for a user use this method:</p>  <h2 class="api-heading" id="Accounts-disableUser2fa"> <div class="locus"> Client </div> <code>Accounts.disableUser2fa([callback])</code> <div class="subtext-api"> <code>import { Accounts } from 'meteor/accounts-base'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-2fa/2fa-client.js#L74" target="_blank"> (accounts-2fa/2fa-client.js, line 74) </a> </div> </h2>   <p>Disable user 2FA</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Optional callback. Called with no arguments on success, or with a single <code>Error</code> argument on failure.</p> </dd> </dl>   <p>To call this function the user must be already logged in.</p> <h2 id="log-in-with-2fa">Log in with 2FA</h2> <p>Now that you have a way to allow your users to enable 2FA on their accounts, you can create a login flow based on that.</p> <p>As said at the beginning of this guide, this package is currently working with two other packages: <code>accounts-password</code> and <code>accounts-passwordless</code>. Below there is an explanation on how to use this package with them.</p> <h3 id="working-with-accounts-password">Working with accounts-password</h3> <p>When calling the function <code>Meteor.loginWithPassword</code>, if the 2FA is enabled for the user, an error will be returned to the callback, so you can redirect the user to a place where they can provide a code.</p> <p>As an example:</p>  <pre class="line-numbers" style><code class="language-js">&lt;button 
  onClick={() =&gt; {
    Meteor.loginWithPassword(username, password, error =&gt; {
      if (error) {
        if (error.error === 'no-2fa-code') {
            // send user to a page or show a component 
            // where they can provide a 2FA code
            setShouldAskCode(true);
            return;
        }
        console.error("Error trying to log in (user without 2fa)", error);
      }
    });
  }
}&gt;
  Login
&lt;/button&gt;
</code></pre> <p>If the 2FA is not enabled, the user will be logged in normally.</p> <p>The function you will need to call now to allow the user to login is <code>Meteor.loginWithPasswordAnd2faCode</code>:</p>  <h2 class="api-heading" id="Meteor-loginWithPasswordAnd2faCode"> <div class="locus"> Client </div> <code>Meteor.loginWithPasswordAnd2faCode(selector, password, token, [callback])</code> <div class="subtext-api"> <code>import { Meteor } from 'meteor/meteor'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-password/password_client.js#L83" target="_blank"> (accounts-password/password_client.js, line 83) </a> </div> </h2>   <p>Log the user in with a password and token.</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>selector</code> <span class="type">Object or String</span> </dt> <dd> <p>Either a string interpreted as a username or an email; or an object with a single key: <code>email</code>, <code>username</code> or <code>id</code>. Username or email match in a case insensitive manner.</p> </dd> <dt> <code>password</code> <span class="type">String</span> </dt> <dd> <p>The user's password.</p> </dd> <dt> <code>token</code> <span class="type">String</span> </dt> <dd> <p>Token provide by the user's authenticator app.</p> </dd> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Optional callback. Called with no arguments on success, or with a single <code>Error</code> argument on failure.</p> </dd> </dl>   <p>Now you will be able to receive a code from the user and this function will verify if the code is valid. If it is, the user will be logged in.</p> <p>So the call of this function should look something like this:</p>  <pre class="line-numbers" style><code class="language-js">&lt;button onClick={() =&gt; {
  Meteor.loginWithPasswordAnd2faCode(username, password, code, error =&gt; {
    if (error) {
      console.error("Error trying to log in (user with 2fa)", error);
    }
  })}
}&gt;
  Validate and log in
&lt;/button&gt;
</code></pre> <p>This method can fail throwing one of the following errors:</p> <ul> <li>“2FA code must be informed [no-2fa-code]” if a 2FA code was not provided.</li> <li>“Invalid 2FA code [invalid-2fa-code]” if the provided 2FA code is invalid.</li> </ul> <h3 id="working-with-accounts-passwordless">Working with accounts-passwordless</h3> <p>Following the same logic from the previous package, if the 2FA is enabled, an error will be returned to the callback of the function <a href="accounts-passwordless#Meteor-passwordlessLoginWithToken"><code>Meteor.passwordlessLoginWithToken</code></a>, then you can redirect the user to a place where they can provide a code.</p> <p>Here is an example:</p>  <pre class="line-numbers" style><code class="language-js">&lt;button
  onClick={() =&gt; {
    // logging in just with token 
    Meteor.passwordlessLoginWithToken(
      email,
      token,
      error =&gt; {
        if (error) {
          if (error.error === 'no-2fa-code') {
            // send user to a page or show a component 
            // where they can provide a 2FA code
            setShouldAskCode(true);
            return;
          }
          console.error('Error verifying token', error);
        }
      }
    );
  }}
&gt;
  Validate token
&lt;/button&gt;;
</code></pre> <p>Now you can call the function <code>Meteor.passwordlessLoginWithTokenAnd2faCode</code> that will allow you to provide a selector, token, and 2FA code:</p>  <h2 class="api-heading" id="Meteor-passwordlessLoginWithTokenAnd2faCode"> <div class="locus"> Client </div> <code>Meteor.passwordlessLoginWithTokenAnd2faCode(selector, token, code, [callback])</code> <div class="subtext-api"> <code>import { Meteor } from 'meteor/meteor'</code> <a class="src-code link secondary" href="https://github.com/meteor/meteor/blob/master/packages/accounts-passwordless/passwordless_client.js#L85" target="_blank"> (accounts-passwordless/passwordless_client.js, line 85) </a> </div> </h2>   <p>Log the user in with a one time token.</p>  <h4 class="subheading">Arguments</h4> <dl class="args"> <dt> <code>selector</code> <span class="type">Object or String</span> </dt> <dd> <p>Username, email or custom selector to identify the user.</p> </dd> <dt> <code>token</code> <span class="type">String</span> </dt> <dd> <p>one time token generated by the server</p> </dd> <dt> <code>code</code> <span class="type">String</span> </dt> <dd> <p>generated by the user's authenticator app</p> </dd> <dt> <code>callback</code> <span class="type">Function</span> </dt> <dd> <p>Optional callback. Called with no arguments on success, or with a single <code>Error</code> argument on failure.</p> </dd> </dl>   <p>This method can fail throwing one of the following errors:</p> <ul> <li>“2FA code must be informed [no-2fa-code]” if a 2FA code was not provided.</li> <li>“Invalid 2FA code [invalid-2fa-code]” if the provided 2FA code is invalid.</li> </ul> <h2 id="integrating-auth-package">How to integrate an Authentication Package with accounts-2fa</h2> <p>To integrate this package with any other existing Login method, it’s necessary following two steps:</p> <p>1 - For the client, create a new method from your current login method. So for example, from the method <code>Meteor.loginWithPassword</code> we created a new one called <code>Meteor.loginWithPasswordAnd2faCode</code>, and the only difference between them is that the latest one receives one additional parameter, the 2FA code, but we call the same function on the server side.</p> <p>2 - For the server, inside the function that will log the user in, you verify if the function <code>Accounts._check2faEnabled</code> exists, and if yes, you call it providing the user object you want to check if the 2FA is enabled, and if either of these statements are false, you proceed with the login flow. This function exists only when the package <code>accounts-2fa</code> is added to the project.</p> <p>If both statements are true, and the login validation succeeds, you verify if a code was provided: if not, throw an error; if it was provided, verify if the code is valid by calling the function <code>Accounts._isTokenValid</code>. if <code>Accounts._isTokenValid</code> returns false, throw an error.</p> <p>Here it’s an example:</p>  <pre class="line-numbers" style><code class="language-js">  const result = validateLogin();
  if (
    !result.error &amp;&amp;
    Accounts._check2faEnabled?.(user)
  ) {
    if (!code) {
      Accounts._handleError('2FA code must be informed.');
    }
    if (
      !Accounts._isTokenValid(user.services.twoFactorAuthentication.secret, code)
    ) {
      Accounts._handleError('Invalid 2FA code.');
    }
  }
  
  return result;
</code></pre><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://docs.meteor.com/packages/accounts-2fa.html" class="_attribution-link" target="_blank">https://docs.meteor.com/packages/accounts-2fa.html</a>
  </p>
</div>
