<p>Is your Meteor Cordova app not getting the updates you’re deploying?</p> <p>After reading this article, you’ll know:</p> <ol> <li>The prerequisites to using Hot Code Push</li> <li>Some techniques to diagnose and solve common issues</li> <li>How to dig deeper if that doesn’t solve your issue</li> </ol> <p>This article builds on the <a href="cordova">Cordova</a> article. We recommend reading that first, though we’ve tried to link back to its relevant sections.</p> <h2 id="prerequisites">Prerequisites</h2> <p>Make sure that you have:</p> <ul> <li>an Android and/or iOS mobile app based on Meteor’s <a href="cordova#cordova-integration-in-meteor">Cordova integration</a>
</li> <li>the package <code>hot-code-push</code> listed in your <code>.meteor/versions</code> file</li> <li>locally: make sure your test device and development device are <a href="cordova#connecting-to-the-server">on the same network</a>
</li> <li>in production: make sure the <code>--server</code> flag of your <code>meteor build</code> command points to the same place as your <code>ROOT_URL</code> environment variable (or, on Galaxy, the <em>site</em> in <code>meteor deploy site</code>). <a href="cordova#configuring-server-for-hot-code-push">See details</a>
</li> </ul> <h2 id="known-issues">Known issues</h2> <h3 id="override-compatability-versions">Override compatability versions</h3> <p>Did the app suddenly stop getting new code after you updated meteor, or you changed plugins?</p> <p>The client probably logs: <code>Skipping downloading new version because the Cordova platform version or plugin versions have changed and are potentially incompatible</code></p> <p>Meteor, Cordova and plugins cannot be updated through Hot Code Push. So Meteor by default disables Hot Code Push to app versions that have different versions than the server. This avoids crashing a user’s app, for example, when new JS calls a plugin that his app version doesn’t yet have.</p> <p>You can <a href="cordova#controlling-compatibility-version">override this behavior</a>. Just make sure you deal with potentially incompatible versions in your JS instead.</p> <h3 id="set-autoupdate-version">Update your AUTOUPDATE_VERSION</h3> <p><code>AUTOUPDATE_VERSION</code> is an environment variable you can add to your <code>run</code> and <code>deploy</code> <a href="https://docs.meteor.com/commandline.html" target="_blank" rel="noopener">commands</a>:</p>  <pre class="line-numbers" style><code class="language-sh">$ AUTOUPDATE_VERSION=abc meteor deploy example.com
</code></pre> <p>If your app has an <code>AUTOUPDATE_VERSION</code> set, make sure you change its value when you want a deploy to update your clients.</p> <h3 id="no-soft-update-in-cordova">Cordova doesn’t hot reload CSS separately</h3> <p>Are you seeing your web app incorporate changes without reload, yet your cordova app reloads each time?</p> <p>For CSS-only changes, this is the expected behaviour. Browsers update the layout without reload, but in cordova, <a href="https://docs.meteor.com/packages/autoupdate.html#Cordova-Client" target="_blank" rel="noopener">any change reloads the whole app</a>.</p> <p>In case you want to implement soft CSS update for Cordova, see below <a href="#how-to-edit-the-source">how to edit the source</a>.</p> <h3 id="custom-code-and-packages">Outdated custom reload code and packages</h3> <p>There are <a href="https://atmospherejs.com/?q=reload" target="_blank" rel="noopener">several reload packages</a>, and maybe your app includes some custom reload code. Of course, these may have bugs or be outdated.</p> <p>In particular, when you push an update, does the app reload but use the old code anyways? Probably, the code hasn’t been updated to work with Meteor 1.8.1 or later. As mentioned in the <a href="https://docs.meteor.com/changelog.html#v18120190403" target="_blank" rel="noopener">changelog</a>, we recommend you call <code>WebAppLocalServer.switchToPendingVersion</code> before forcing a browser reload.</p> <p>Alternatively, use the built-in behavior to reload. Instead of, say, <code>window.location.reload()</code>, call the <code>retry</code> function passed to the <code>Reload._onMigrate()</code> callback. For example:</p>  <pre class="line-numbers" style><code class="language-js">Reload._onMigrate((retry) =&gt; {
  if (/* not ready */) {
    window.setTimeout(retry, 5 * 1000); // Check again in 5 seconds
    return [false];
  }
  // ready
  return [true];
});
</code></pre> <p>If you use a package that is no longer compatible, consider forking it or opening a PR with the above changes. Alternatively, you can switch to a compatible one such as <a href="https://github.com/quavedev/reloader" target="_blank" rel="noopener"><code>quave:reloader</code></a></p> <h3 id="avoid-hash-fragments">Avoid hash fragments</h3> <p>Cordova doesn’t show the URL bar, but the user is still on some URL or other, which may have a hash (<code>#</code>). HCP <a href="https://github.com/meteor/meteor/blob/devel/packages/reload/reload.js#L224" target="_blank" rel="noopener">works better if it doesn’t</a>.</p> <p>If you can, remove the hash fragment before the reload.</p> <h3 id="avoid-big-files">Avoid making it download big files</h3> <p>In the <a href="cordova#logging-and-remote-debugging">client side logs</a>, you may see HCP fail with errors like:</p>  <pre class="line-numbers" style><code class="language-clike">Error: Error downloading asset: /
  at http://localhost:12472/plugins/cordova-plugin-meteor-webapp/www/webapp-local-server.js:51:21
  at Object.callbackFromNative (http://localhost:12472/cordova.js:287:58)
  at &lt;anonymous&gt;:1:9
</code></pre> <p>This error from <a href="https://github.com/meteor/cordova-plugin-meteor-webapp" target="_blank" rel="noopener">cordova-plugin-meteor-webapp</a> may be caused by big files, often in the <code>public</code> folder. Downloading these can fail depending on connection speed, and available space on the device.</p> <p>You could run <code>$ du -a public | sort -n -r | head -n 20</code> to find the 20 biggest files and their sizes. Consider serving them from an external storage service or CDN instead. Then they are only downloaded when really needed, and can fail downloading without blocking HCP.</p> <h3 id="locally">If it is only broken locally</h3> <p>If you notice HCP works in production but not when you test locally, you may need to enable clear text or set a correct <code>--mobile-server</code>. Both are <a href="https://docs.meteor.com/packages/autoupdate.html#Cordova-Client" target="_blank" rel="noopener">explained in the docs</a>.</p> <h2 id="dig-deeper">Still having issues?</h2> <p>If none of that solved your issues and you’d like to dive deeper, here’s some tips to get you started.</p> <p>If you end up finding a bug in one of Meteor’s packages or plugins, don’t hesitate to open an <a href="https://github.com/meteor/meteor/issues" target="_blank" rel="noopener">issue</a> and/or a <a href="https://github.com/meteor/meteor/pulls" target="_blank" rel="noopener">pull request</a>.</p> <h3 id="where-does-it-live">Where does hot code push live?</h3> <p>Hot code push is included in <code>meteor-base</code> through a web of <a href="https://github.com/meteor/meteor/tree/devel/packages" target="_blank" rel="noopener">official meteor packages</a>, most importantly <a href="https://github.com/meteor/meteor/tree/devel/packages/reload" target="_blank" rel="noopener"><code>reload</code></a> and <a href="https://github.com/meteor/meteor/tree/devel/packages/autoupdate" target="_blank" rel="noopener"><code>autoupdate</code></a>.</p> <p>In the case of cordova, a lot of the heavy lifting is done by <a href="https://github.com/meteor/cordova-plugin-meteor-webapp" target="_blank" rel="noopener"><code>cordova-plugin-meteor-webapp</code></a>.</p> <p>To oversimplify, <code>autoupdate</code> decides <em>when</em> to refresh the client, the plugin then downloads the new client code and assets, and <code>reload</code> then refreshes the page to start using them.</p> <h3 id="what-are-the-steps">What are the steps it takes?</h3> <p>We can break it down a bit more:</p> <ul> <li>whenever the server thinks the client side may have changed, it calculates a hash of your entire client bundle</li> <li>it <a href="https://docs.meteor.com/api/pubsub.html" target="_blank" rel="noopener">publishes</a> this hash to all clients</li> <li>the clients subscribe to this publish</li> <li>when a new hash arrives, each client compares it to its own hash</li> <li>if it’s different, it starts to download the new client bundle</li> <li>when it’s done, the client saves any data and announces that it will reload</li> <li>the app and packages get a chance to <a href="https://forums.meteor.com/t/is-there-an-official-documentation-of-reload--onmigrate/16974/2" target="_blank" rel="noopener">save their data or to deny the reload</a>
</li> <li>if/when allowed, it reloads</li> </ul> <h3 id="how-to-inspect">How to spy on it?</h3> <p>To figure out where the issue is, we can log the various steps HCP takes.</p> <p>First, make sure you can <a href="cordova#logging-and-remote-debugging">see client-side logs</a> (or print them on some screen of your app).</p> <p>A few more useful values to print, and events to listen to, might be:</p> <ul> <li>
<p>The version hashes: <code>__meteor_runtime_config__.autoupdate.versions['web.cordova']</code></p> </li> <li>
<p>The reactive <a href="https://github.com/meteor/meteor/blob/devel/packages/autoupdate/QA.md#autoupdatenewclientavailable" target="_blank" rel="noopener"><code>Autoupdate.newClientAvailable()</code></a>: if this turns into <code>true</code> and then doesn’t refresh, you know the client does receive the new version but something goes wrong trying to download or apply it.</p> </li> </ul>  <pre class="line-numbers" style><code class="language-js">Tracker.autorun(() =&gt; {
  console.log(‘new client available:’, Autoupdate.newClientAvailable());
});
</code></pre> <ul> <li>To check the client’s subscription to the new versions, check <code>Meteor.default_connection._subscriptions</code>. For example, to log whether the subscription is <code>ready</code> and <code>inactive</code> (using lodash):</li> </ul>  <pre class="line-numbers" style><code class="language-js">const { ready, inactive } = _.chain(Meteor)
  .get('default_connection._subscriptions', {})
  .toPairs()
  .map(1)
  .find({ name: 'meteor_autoupdate_clientVersions' })
  .pick(['inactive', 'ready']) // comment this to see all options
  .value();
console.log(‘ready:’, ready);
console.log(‘inactive:’, inactive);
</code></pre> <p>Or, to log the value of <code>ready</code> each time the subscription changes:</p>  <pre class="line-numbers" style><code class="language-js">const hcpSub = _.chain(Meteor)
  .get('default_connection._subscriptions', {})
  .toPairs()
  .map(1)
  .find({ name: 'meteor_autoupdate_clientVersions' })
  .value(); // no .pick() this time; return whole subscription object

Tracker.autorun(() =&gt; {
  hcpSub.readyDeps.depend(); // Rerun when something changes in the subscription
  console.log('hcpSub.ready', hcpSub.ready);
});
</code></pre> <p>Should print <code>false</code> and then <code>true</code> less than a second later.</p> <ul> <li>To see if we finish downloading and preparing the new version, listen to <code>WebAppLocalServer.onNewVersionReady</code>;</li> </ul>  <pre class="line-numbers" style><code class="language-js">WebAppLocalServer.onNewVersionReady(() =&gt; {
  console.log('new version is ready!');
  // Copied from original in autoupdate/autoupdate_cordova.js because we overwrite it
  if (Package.reload) {
    Package.reload.Reload._reload();
  }
});
</code></pre> <ul> <li>To see if permission to reload is being requested, listen to <code>Reload._onMigrate()</code>. Be sure to return <code>[true]</code> or the reload may not happen. (I believe that if this is run in your app code, it means all packages allowed the reload. But I didn’t find my source on this.)</li> </ul>  <pre class="line-numbers" style><code class="language-js">Reload._onMigrate(() =&gt; {
  console.log('going to reload now');
  return [true];
});
</code></pre> <ul> <li>To know if a run of <code>Meteor.startup</code> was the result of a HCP reload or not, we can take advantage of the fact that <code>Session</code>s (like <code>ReactiveDict</code>s) are preserved.</li> </ul>  <pre class="line-numbers" style><code class="language-js">Meteor.startup(() =&gt; {
  console.log('Was HCP:', Session.get('wasHCP'));
  Session.set('wasHCP', false);

  Reload._onMigrate(() =&gt; {
    Session.set('wasHCP', true);
    return [true];
  });
});
</code></pre> <h2 id="how-to-edit-source">How to edit the source</h2> <p>Finally, if you want to change some of the package and plugin code locally, you can.</p> <h3 id="editing-packages">Editing the packages</h3> <p>Say we want to edit the <code>autoupdate</code> package.</p> <p>In the root of your project, create a folder named <code>packages</code>, then add a folder <code>autoupdate</code>. Here we put the code from the original package (found in <code>~/.meteor/packages</code>), then we edit it.</p> <p>Meteor will now use the local version instead of the official one.</p> <h3 id="editing-plugins">Editing the plugin</h3> <p>To install a modified version of a plugin,</p> <ul> <li>from another folder, download the original code e.g. <code>git clone https://github.com/meteor/cordova-plugin-meteor-webapp.git</code>
</li> <li>install it into your meteor project with <a href="https://stackoverflow.com/a/35941588/5786714" target="_blank" rel="noopener"><code>meteor add cordova:cordova-plugin-meteor-webapp@file://path/to/cordova-plugin-meteor-webapp</code></a>
</li> <li>modify it as you like</li> </ul> <p>Meteor will start using the local version instead of the official one. But note you will have to rerun <code>meteor build</code> or <code>meteor run</code> every time you change the plugin.</p> <h2 id="file-issue">Found a bug?</h2> <p>If you found a bug in one of the packages or plugins, don’t hesitate to open an <a href="https://github.com/meteor/meteor/issues" target="_blank" rel="noopener">issue</a> and/or <a href="https://github.com/meteor/meteor/pulls" target="_blank" rel="noopener">pull request</a>.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://guide.meteor.com/hot-code-push.html" class="_attribution-link" target="_blank">https://guide.meteor.com/hot-code-push.html</a>
  </p>
</div>
