 <h1 id="the-count-meta-argument">  The <code>count</code> Meta-Argument </h1> <blockquote class="alert alert-info" role="alert"> <p><strong>Version note:</strong> Module support for <code>count</code> was added in Terraform 0.13, and previous versions can only use it with resources.</p> </blockquote> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> A given resource or module block cannot use both <code>count</code> and <code>for_each</code>.</p> </blockquote> <blockquote> <p><strong>Hands-on:</strong> Try the <a href="https://learn.hashicorp.com/tutorials/terraform/count?in=terraform/0-13&amp;utm_source=WEBSITE&amp;utm_medium=WEB_IO&amp;utm_offer=ARTICLE_PAGE&amp;utm_content=DOCS">Manage Similar Resources With Count</a> tutorial on HashiCorp Learn.</p> </blockquote> <p>By default, a <a href="../resources/syntax">resource block</a> configures one real infrastructure object. (Similarly, a <a href="../modules/syntax">module block</a> includes a child module's contents into the configuration one time.) However, sometimes you want to manage several similar objects (like a fixed pool of compute instances) without writing a separate block for each one. Terraform has two ways to do this: <code>count</code> and <a href="for_each"><code>for_each</code></a>.</p> <p>If a resource or module block includes a <code>count</code> argument whose value is a whole number, Terraform will create that many instances.</p> <h2 id="basic-syntax">  Basic Syntax </h2> <p><code>count</code> is a meta-argument defined by the Terraform language. It can be used with modules and with every resource type.</p> <p>The <code>count</code> meta-argument accepts a whole number, and creates that many instances of the resource or module. Each instance has a distinct infrastructure object associated with it, and each is separately created, updated, or destroyed when the configuration is applied.</p> <pre data-language="ruby">resource "aws_instance" "server" {
  count = 4 # create four similar EC2 instances

  ami           = "ami-a1b2c3d4"
  instance_type = "t2.micro"

  tags = {
    Name = "Server ${count.index}"
  }
}
</pre>
<h2 id="the-count-object">  The <code>count</code> Object </h2> <p>In blocks where <code>count</code> is set, an additional <code>count</code> object is available in expressions, so you can modify the configuration of each instance. This object has one attribute:</p> <ul> <li>
<a href="#count-index"><code>count.index</code></a> â€” The distinct index number (starting with <code>0</code>) corresponding to this instance. </li> </ul> <h2 id="using-expressions-in-count">  Using Expressions in <code>count</code> </h2> <p>The <code>count</code> meta-argument accepts numeric <a href="../expressions/index">expressions</a>. However, unlike most arguments, the <code>count</code> value must be known <em>before</em> Terraform performs any remote resource actions. This means <code>count</code> can't refer to any resource attributes that aren't known until after a configuration is applied (such as a unique ID generated by the remote API when an object is created).</p> <h2 id="referring-to-instances">  Referring to Instances </h2> <p>When <code>count</code> is set, Terraform distinguishes between the block itself and the multiple <em>resource or module instances</em> associated with it. Instances are identified by an index number, starting with <code>0</code>.</p> <ul> <li>
<a href="#lt-type-gt-lt-name-gt-"><code>&lt;TYPE&gt;.&lt;NAME&gt;</code></a> or <code>module.&lt;NAME&gt;</code> (for example, <code>aws_instance.server</code>) refers to the resource block. </li> <li>
<a href="#lt-type-gt-lt-name-gt-lt-index-gt-"><code>&lt;TYPE&gt;.&lt;NAME&gt;[&lt;INDEX&gt;]</code></a> or <code>module.&lt;NAME&gt;[&lt;INDEX&gt;]</code> (for example, <code>aws_instance.server[0]</code>, <code>aws_instance.server[1]</code>, etc.) refers to individual instances. </li> </ul> <p>This is different from resources and modules without <code>count</code> or <code>for_each</code>, which can be referenced without an index or key.</p> <p>Similarly, resources from child modules with multiple instances are prefixed with <code>module.&lt;NAME&gt;[&lt;KEY&gt;]</code> when displayed in plan output and elsewhere in the UI. For a module without <code>count</code> or <code>for_each</code>, the address will not contain the module index as the module's name suffices to reference the module.</p> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Within nested <code>provisioner</code> or <code>connection</code> blocks, the special <code>self</code> object refers to the current <em>resource instance,</em> not the resource block as a whole.</p> </blockquote> <h2 id="when-to-use-for_each-instead-of-count">  When to Use <code>for_each</code> Instead of <code>count</code> </h2> <p>If your instances are almost identical, <code>count</code> is appropriate. If some of their arguments need distinct values that can't be directly derived from an integer, it's safer to use <code>for_each</code>.</p> <p>Before <code>for_each</code> was available, it was common to derive <code>count</code> from the length of a list and use <code>count.index</code> to look up the original list value:</p> <pre data-language="ruby">variable "subnet_ids" {
  type = list(string)
}

resource "aws_instance" "server" {
  # Create one instance for each subnet
  count = length(var.subnet_ids)

  ami           = "ami-a1b2c3d4"
  instance_type = "t2.micro"
  subnet_id     = var.subnet_ids[count.index]

  tags = {
    Name = "Server ${count.index}"
  }
}
</pre>
<p>This was fragile, because the resource instances were still identified by their <em>index</em> instead of the string values in the list. If an element was removed from the middle of the list, every instance <em>after</em> that element would see its <code>subnet_id</code> value change, resulting in more remote object changes than intended. Using <code>for_each</code> gives the same flexibility without the extra churn.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/language/meta-arguments/count.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/language/meta-arguments/count.html</a>
  </p>
</div>
