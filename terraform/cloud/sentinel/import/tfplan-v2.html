 <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Sentinel policies are a paid feature, available as part of the <strong>Team &amp; Governance</strong> upgrade package. <a href="https://www.hashicorp.com/products/terraform/pricing">Learn more about Terraform Cloud pricing here</a>.</p> </blockquote> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> This is documentation for the next version of the <code>tfplan</code> Sentinel import, designed specifically for Terraform 0.12. This import requires Terraform 0.12 or higher, and must currently be loaded by path, using an alias, example: <code>import "tfplan/v2" as tfplan</code>.</p> </blockquote> <h1 id="import-tfplan-v2">  Import: tfplan/v2 </h1> <p>The <code>tfplan/v2</code> import provides access to a Terraform plan.</p> <p>A Terraform plan is the file created as a result of <code>terraform plan</code> and is the input to <code>terraform apply</code>. The plan represents the changes that Terraform needs to make to infrastructure to reach the desired state represented by the configuration.</p> <p>In addition to the diff data available in the plan, there is a "planned state" that is available through this import, via the <a href="#the-planned_values-collection"><code>planned_values</code></a> collection. This collection presents the Terraform state as how it might look after the plan data is applied, but is not guaranteed to be the final state.</p> <p>The data in the <code>tfplan/v2</code> import is sourced from the JSON configuration file that is generated by the <a href="../../../cli/commands/show#json-output"><code>terraform show
-json</code></a> command. For more information on the file format, see the <a href="../../../internals/json-format">JSON Output Format</a> page.</p> <p>The entirety of the JSON output file is exposed as a Sentinel map via the <a href="#the-raw-collection"><code>raw</code></a> collection. This allows direct, low-level access to the JSON data, but should only be used in complex situations where the higher-level collections do not serve the purpose.</p> <h2 id="import-overview">  Import Overview </h2> <p>The <code>tfplan/v2</code> import is structured as a series of <em>collections</em>, keyed as a specific format depending on the collection.</p> <pre>tfplan/v2
├── terraform_version (string)
├── variables
│   └── (indexed by name)
│       ├── name (string)
│       └── value (value)
├── planned_values
│   ├── outputs (tfstate/v2 outputs representation)
│   └── resources (tfstate/v2 resources representation)
├── resource_changes
│   └── (indexed by address[:deposed])
│       ├── address (string)
│       ├── module_address (string)
│       ├── mode (string)
│       ├── type (string)
│       ├── name (string)
│       ├── index (float (number) or string)
│       ├── provider_name (string)
│       ├── deposed (string)
│       └── change (change representation)
├── output_changes
│   └── (indexed by name)
│       ├── name (string)
│       └── change (change representation)
└── raw (map)
</pre>
<p>The collections are:</p> <ul> <li>
<a href="#the-variables-collection"><code>variables</code></a> - The values of variables that have been set in the plan itself. This collection only contains variables set in the root module. </li> <li>
<a href="#the-planned_values-collection"><code>planned_values</code></a> - The state representation of <em>planned values</em>, or an estimation of what the state will look like after the plan is applied. </li> <li>
<a href="#the-resource_changes-collection"><code>resource_changes</code></a> - The set of change operations for resources and data sources within this plan. </li> <li>
<a href="#the-output_changes-collection"><code>output_changes</code></a> - The changes to outputs within this plan. This collection only contains outputs set in the root module. </li> <li>
<a href="#the-raw-collection"><code>raw</code></a> - Access to the raw plan data as stored by Terraform Cloud. </li> </ul> <p>These collections are specifically designed to be used with the <a href="https://docs.hashicorp.com/sentinel/language/collection-operations#filter-expression"><code>filter</code></a> quantifier expression in Sentinel, so that one can collect a list of resources to perform policy checks on without having to write complex discovery code. As an example, the following code will return all <code>aws_instance</code> resource changes, across all modules in the plan:</p> <pre>all_aws_instances = filter tfplan.resource_changes as _, rc {
    rc.mode is "managed" and
        rc.type is "aws_instance"
}
</pre>
<p>You can add specific attributes to the filter to narrow the search, such as the module address, or the operation being performed. The following code would return resources in a module named <code>foo</code> only, and further narrow the search down to only resources that were being created:</p> <pre>all_aws_instances = filter tfplan.resource_changes as _, rc {
    rc.module_address is "module.foo" and
        rc.mode is "managed" and
        rc.type is "aws_instance" and
        rc.change.actions is ["create"]
}
</pre>
<h3 id="change-representation">  Change Representation </h3> <p>Certain collections in this import contain a <em>change representation</em>, an object with details about changes to a particular entity, such as a resource (within the <a href="#the-resource_changes-collection"><code>resource_changes</code></a> collection), or output (within the <a href="#the-output_changes-collection"><code>output_changes</code></a> collection).</p> <pre>(change representation)
├── actions (list)
├── before (value, or map)
├── after (value, or map)
└── after_unknown (boolean, or map of booleans)
</pre>
<p>This change representation contains the following fields:</p> <ul> <li>
<a href="#actions"><code>actions</code></a> - A list of actions being carried out for this change. The order is important, for example a regular replace operation is denoted by <code>["delete",
"create"]</code>, but a <a href="../../../language/meta-arguments/lifecycle#create_before_destroy"><code>create_before_destroy</code></a> resource will have an operation order of <code>["create", "delete"]</code>. </li> <li>
<a href="#before"><code>before</code></a> - The representation of the resource data object value before the action. For create-only actions, this is unset. For no-op actions, this value will be identical with <code>after</code>. </li> <li>
<a href="#after"><code>after</code></a> - The representation of the resource data object value after the action. For delete-only actions, this is unset. For no-op actions, this value will be identical with <code>before</code>. Note that unknown values will not show up in this field. </li> <li>
<a href="#after_unknown"><code>after_unknown</code></a> - A deep object of booleans that denotes any values that are unknown in a resource. These values were previously referred to as "computed" values. If the value cannot be found in this map, then its value should be available within <code>after</code>, so long as the operation supports it. </li> </ul> <h4 id="actions-1">  Actions </h4> <p>As mentioned above, actions show up within the <code>actions</code> field of a change representation and indicate the type of actions being performed as part of the change, and the order that they are being performed in.</p> <p>The current list of actions are as follows:</p> <ul> <li>
<a href="#create"><code>create</code></a> - The action will create the associated entity. Depending on the order this appears in, the entity may be created alongside a copy of the entity before replacing it. </li> <li>
<a href="#read"><code>read</code></a> - The action will read the associated entity. In practice, seeing this change type should be rare, as reads generally happen before a plan is executed (usually during a refresh). </li> <li>
<a href="#update"><code>update</code></a> - The action will update the associated entity in a way that alters its state in some way. </li> <li>
<a href="#delete"><code>delete</code></a> - The action will remove the associated entity, deleting any applicable state and associated real resources or infrastructure. </li> <li>
<a href="#no-op"><code>no-op</code></a> - No action will be performed on the associated entity. </li> </ul> <p>The <code>actions</code> field is a list, as some real-world actions are actually a composite of more than one primitive action. At this point in time, this is generally only applicable to resource replacement, in which the following action orders apply:</p> <ul> <li>
<strong>Normal replacement:</strong> <code>["delete", "create"]</code> - Applies to default lifecycle configurations. </li> <li>
<strong>Create-before-destroy:</strong> <code>["create", "delete"]</code> - Applies when <a href="../../../language/meta-arguments/lifecycle#create_before_destroy"><code>create_before_destroy</code></a> is used in a lifecycle configuration. </li> </ul> <p>Note that, in most situations, the plan will list all "changes", including no-op changes. This makes filtering on change type crucial to the accurate selection of data if you are concerned with the state change of a particular resource.</p> <p>To filter on a change type, use exact list comparison. For example, the following example from the <a href="#import-overview">Import Overview</a> filters on exactly the resources being created <em>only</em>:</p> <pre>all_aws_instances = filter tfplan.resource_changes as _, rc {
    rc.module_address is "module.foo" and
        rc.mode is "managed" and
        rc.type is "aws_instance" and
    rc.change.actions is ["create"]
}
</pre>
<h4 id="before-after-and-after_unknown">  <code>before</code>, <code>after</code>, and <code>after_unknown</code> </h4> <p>The exact attribute changes for a particular operation are outlined in the <code>before</code> and <code>after</code> attributes. Depending on the entity being operated on, this will either be a map (as with <a href="#the-resource_changes-collection"><code>resource_changes</code></a>) or a singular value (as with <a href="#the-output_changes-collection"><code>output_changes</code></a>).</p> <p>What you can expect in these fields varies depending on the operation:</p> <ul> <li>For fresh create operations, <code>before</code> will generally be <code>null</code>, and <code>after</code> will contain the data you can expect to see after the change. </li> <li>For full delete operations, this will be reversed - <code>before</code> will contain data, and <code>after</code> will be <code>null</code>. </li> <li>Update or replace operations will have data in both fields relevant to their states before and after the operation. </li> <li>No-op operations should have identical data in <code>before</code> and <code>after</code>. </li> </ul> <p>For resources, if a field cannot be found in <code>after</code>, it generally means one of two things:</p> <ul> <li>The attribute does not exist in the resource schema. Generally, known attributes that do not have a value will show up as <code>null</code> or otherwise empty in <code>after</code>. </li> <li>The attribute is <em>unknown</em>, that is, it was unable to be determined at plan time and will only be available after apply-time values have been able to be calculated. </li> </ul> <p>In the latter case, there should be a value for the particular attribute in <code>after_unknown</code>, which can be checked to assert that the value is indeed unknown, versus invalid:</p> <pre>import "tfplan/v2" as tfplan

no_unknown_amis = rule {
    all filter tfplan.resource_changes as _, rc {
        rc.module_address is "module.foo" and
            rc.mode is "managed" and
            rc.type is "aws_instance" and
            rc.change.actions is ["create"]
    } as _, rc {
        rc.change.after_unknown.ami else false is false
    }
}
</pre>
<p>For output changes, <code>after_unknown</code> will simply be <code>true</code> if the value won't be known until the plan is applied.</p> <h2 id="the-terraform_version-value">  The <code>terraform_version</code> Value </h2> <p>The top-level <code>terraform_version</code> value in this import gives the Terraform version that made the plan. This can be used to do version validation.</p> <pre>import "tfplan/v2" as tfplan
import "strings"

v = strings.split(tfplan.terraform_version, ".")
version_major = int(v[1])
version_minor = int(v[2])

main = rule {
    version_major is 12 and version_minor &gt;= 19
}
</pre>
<blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> The above example will give errors when working with pre-release versions (example: <code>0.12.0beta1</code>). Future versions of this import will include helpers to assist with processing versions that will account for these kinds of exceptions.</p> </blockquote> <h2 id="the-variables-collection">  The <code>variables</code> Collection </h2> <p>The <code>variables</code> collection is a collection of the variables set in the root module when creating the plan.</p> <p>This collection is indexed on the name of the variable.</p> <p>The valid values are:</p> <ul> <li>
<a href="#name"><code>name</code></a> - The name of the variable, also used as the collection key. </li> <li>
<a href="#value"><code>value</code></a> - The value of the variable assigned during the plan. </li> </ul> <h2 id="the-planned_values-collection">  The <code>planned_values</code> Collection </h2> <p>The <code>planned_values</code> collection is a special collection in that it contains two fields that alias to state collections with the <em>planned</em> state set. This is the best prediction of what the state will look like after the plan is executed.</p> <p>The two fields are:</p> <ul> <li>
<a href="#outputs"><code>outputs</code></a> - The prediction of what output values will look like after the state is applied. For more details on the structure of this collection, see the <a href="tfstate-v2#the-outputs-collection"><code>outputs</code></a> collection in the <a href="tfstate-v2"><code>tfstate/v2</code></a> documentation. </li> <li>
<a href="#resources"><code>resources</code></a> - The prediction of what resource values will look like after the state is applied. For more details on the structure of this collection, see the <a href="tfstate-v2#the-resources-collection"><code>resources</code></a> collection in the <a href="tfstate-v2"><code>tfstate/v2</code></a> documentation. </li> </ul> <blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> Unknown values are omitted from the <code>planned_values</code> state representations, regardless of whether or not they existed before. Use <a href="#the-resource_changes-collection"><code>resource_changes</code></a> if awareness of unknown data is important.</p> </blockquote> <h2 id="the-resource_changes-collection">  The <code>resource_changes</code> Collection </h2> <p>The <code>resource_changes</code> collection is the set of change operations for resources and data sources within this plan.</p> <p>This includes all resources that have been found in the configuration and state, regardless of whether or not they are changing.</p> <blockquote class="alert alert-warning" role="alert"> <p>When <a href="../../../cli/commands/plan#resource-targeting">resource targeting</a> is in effect, the <code>resource_changes</code> collection will only include the resources specified as targets for the run. This may lead to unexpected outcomes if a policy expects a resource to be present in the plan. To prohibit targeted runs altogether, ensure <a href="tfrun#value-target_addrs"><code>tfrun.target_addrs</code></a> is undefined or empty.</p> </blockquote> <p>This collection is indexed on the complete resource address as the key. If <code>deposed</code> is non-empty, it is appended to the end, and may look something like <code>aws_instance.foo:deposed-abc123</code>.</p> <p>An element contains the following fields:</p> <ul> <li>
<a href="#address"><code>address</code></a> - The absolute resource address - also the key for the collection's index, if <code>deposed</code> is empty. </li> <li>
<a href="#module_address"><code>module_address</code></a> - The module portion of the absolute resource address. </li> <li>
<a href="#mode"><code>mode</code></a> - The resource mode, either <code>managed</code> (resources) or <code>data</code> (data sources). </li> <li>
<a href="#type"><code>type</code></a> - The resource type, example: <code>aws_instance</code> for <code>aws_instance.foo</code>. </li> <li>
<a href="#name-1"><code>name</code></a> - The resource name, example: <code>foo</code> for <code>aws_instance.foo</code>. </li> <li>
<a href="#index"><code>index</code></a> - The resource index. Can be either a number or a string. </li> <li>
<p><a href="#provider_name"><code>provider_name</code></a> - The name of the provider this resource belongs to. This allows the provider to be interpreted unambiguously in the unusual situation where a provider offers a resource type whose name does not start with its own name, such as the <code>googlebeta</code> provider offering <code>google_compute_instance</code>.</p> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Starting with Terraform 0.13, the <code>provider_name</code> field contains the <em>full</em> source address to the provider in the Terraform Registry. Example: <code>registry.terraform.io/hashicorp/null</code> for the null provider.</p> </blockquote> </li> <li>
<p><a href="#deposed"><code>deposed</code></a> - An identifier used during replacement operations, and can be used to identify the exact resource being replaced in state.</p> </li> <li>
<p><a href="#change"><code>change</code></a> - The data describing the change that will be made to this resource. For more details, see <a href="#change-representation">Change Representation</a>.</p> </li> </ul> <h2 id="the-output_changes-collection">  The <code>output_changes</code> Collection </h2> <p>The <code>output_changes</code> collection is a collection of the change operations for outputs within this plan.</p> <p>Only outputs for the root module are included.</p> <p>This collection is indexed by the name of the output. The fields in a collection value are below:</p> <ul> <li>
<a href="#name-2"><code>name</code></a> - The name of the output, also the index key. </li> <li>
<a href="#change-1"><code>change</code></a> - The data describing the change that will be made to this output. For more details, see <a href="#change-representation">Change Representation</a>. </li> </ul> <h2 id="the-raw-collection">  The <code>raw</code> Collection </h2> <p>The <code>raw</code> collection exposes the raw, unprocessed plan data, direct from the data stored by Terraform Cloud.</p> <p>This is the same data that is produced by <a href="../../../cli/commands/show#json-output"><code>terraform show
-json</code></a> on the plan file for the run this policy check is attached to.</p> <p>Use of this data is only recommended in expert situations where the data the collections present may not exactly serve the needs of the policy. For more information on the file format, see the <a href="../../../internals/json-format">JSON Output Format</a> page.</p> <blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> Although designed to be relatively stable, the actual makeup for the JSON output format is a Terraform CLI concern and as such not managed by Terraform Cloud. Use at your own risk, follow the <a href="https://github.com/hashicorp/terraform">Terraform CLI project</a>, and watch the file format documentation for any changes.</p> </blockquote><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/cloud/sentinel/import/tfplan-v2.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/cloud/sentinel/import/tfplan-v2.html</a>
  </p>
</div>
