 <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Sentinel policies are a paid feature, available as part of the <strong>Team &amp; Governance</strong> upgrade package. <a href="https://www.hashicorp.com/products/terraform/pricing">Learn more about Terraform Cloud pricing here</a>.</p> </blockquote> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> This is documentation for the next version of the <code>tfconfig</code> Sentinel import, designed specifically for Terraform 0.12. This import requires Terraform 0.12 or higher, and must currently be loaded by path, using an alias, example: <code>import "tfconfig/v2" as tfconfig</code>.</p> </blockquote> <h1 id="import-tfconfig-v2">  Import: tfconfig/v2 </h1> <p>The <code>tfconfig/v2</code> import provides access to a Terraform configuration.</p> <p>The Terraform configuration is the set of <code>*.tf</code> files that are used to describe the desired infrastructure state. Policies using the <code>tfconfig</code> import can access all aspects of the configuration: providers, resources, data sources, modules, and variables.</p> <p>Some use cases for <code>tfconfig</code> include:</p> <ul> <li>
<strong>Organizational naming conventions</strong>: requiring that configuration elements are named in a way that conforms to some organization-wide standard. </li> <li>
<strong>Required inputs and outputs</strong>: organizations may require a particular set of input variable names across all workspaces or may require a particular set of outputs for asset management purposes. </li> <li>
<strong>Enforcing particular modules</strong>: organizations may provide a number of "building block" modules and require that each workspace be built only from combinations of these modules. </li> <li>
<strong>Enforcing particular providers or resources</strong>: an organization may wish to require or prevent the use of providers and/or resources so that configuration authors cannot use alternative approaches to work around policy restrictions. </li> </ul> <p>The data in the <code>tfconfig/v2</code> import is sourced from the JSON configuration file that is generated by the <a href="../../../cli/commands/show#json-output"><code>terraform show
-json</code></a> command. For more information on the file format, see the <a href="../../../internals/json-format">JSON Output Format</a> page.</p> <h2 id="import-overview">  Import Overview </h2> <p>The <code>tfconfig/v2</code> import is structured as a series of <em>collections</em>, keyed as a specific format, such as resource address, module address, or a specifically-formatted provider key.</p> <pre>tfconfig/v2
├── strip_index() (function)
├── providers
│   └── (indexed by [module_address:]provider[.alias])
│       ├── provider_config_key (string)
│       ├── name (string)
│       ├── alias (string)
│       ├── module_address (string)
│       ├── config (block expression representation)
│       └── version_constraint (string)
├── resources
│   └── (indexed by address)
│       ├── address (string)
│       ├── module_address (string)
│       ├── mode (string)
│       ├── type (string)
│       ├── name (string)
│       ├── provider_config_key (string)
│       ├── provisioners (list)
│       │   └── (ordered provisioners for this resource only)
│       ├── config (block expression representation)
│       ├── count (expression representation)
│       ├── for_each (expression representation)
│       └── depends_on (list of strings)
├── provisioners
│   └── (indexed by resource_address:index)
│       ├── resource_address (string)
│       ├── type (string)
│       ├── index (string)
│       └── config (block expression representation)
├── variables
│   └── (indexed by module_address:name)
│       ├── module_address (string)
│       ├── name (string)
│       ├── default (value)
│       └── description (string)
├── outputs
│   └── (indexed by module_address:name)
│       ├── module_address (string)
│       ├── name (string)
│       ├── sensitive (boolean)
│       ├── value (expression representation)
│       ├── description (string)
│       └── depends_on (list of strings)
└── module_calls
    └── (indexed by module_address:name)
        ├── module_address (string)
        ├── name (string)
        ├── source (string)
        ├── config (block expression representation)
        ├── count (expression representation)
        ├── depends_on (expression representation)
        ├── for_each (expression representation)
        └── version_constraint (string)
</pre>
<p>The collections are:</p> <ul> <li>
<a href="#the-providers-collection"><code>providers</code></a> - The configuration for all provider instances across all modules in the configuration. </li> <li>
<a href="#the-resources-collection"><code>resources</code></a> - The configuration of all resources across all modules in the configuration. </li> <li>
<a href="#the-variables-collection"><code>variables</code></a> - The configuration of all variable definitions across all modules in the configuration. </li> <li>
<a href="#the-outputs-collection"><code>outputs</code></a> - The configuration of all output definitions across all modules in the configuration. </li> <li>
<a href="#the-module_calls-collection"><code>module_calls</code></a> - The configuration of all module calls (individual <a href="../../../configuration/modules"><code>module</code></a> blocks) across all modules in the configuration. </li> </ul> <p>These collections are specifically designed to be used with the <a href="https://docs.hashicorp.com/sentinel/language/collection-operations#filter-expression"><code>filter</code></a> quantifier expression in Sentinel, so that one can collect a list of resources to perform policy checks on without having to write complex module or configuration traversal. As an example, the following code will return all <code>aws_instance</code> resource types within the configuration, regardless of what module they are in:</p> <pre>all_aws_instances = filter tfconfig.resources as _, r {
    r.mode is "managed" and
        r.type is "aws_instance"
}
</pre>
<p>You can add specific attributes to the filter to narrow the search, such as the module address. The following code would return resources in a module named <code>foo</code> only:</p> <pre>all_aws_instances = filter tfconfig.resources as _, r {
    r.module_address is "module.foo" and
        r.mode is "managed" and
        r.type is "aws_instance"
}
</pre>
<h3 id="address-differences-between-tfconfig-tfplan-and-tfstate">  Address Differences Between <code>tfconfig</code>, <code>tfplan</code>, and <code>tfstate</code> </h3> <p>This import deals with configuration before it is expanded into a resource graph by Terraform. As such, it is not possible to compute an index as the import is building its collections and computing addresses for resources and modules.</p> <p>As such, addresses found here may not always match the expanded addresses found in the <a href="tfplan-v2"><code>tfplan/v2</code></a> and <a href="tfstate-v2"><code>tfstate/v2</code></a> imports, specifically when <a href="../../../configuration/resources#count-multiple-resource-instances-by-count"><code>count</code></a> and <a href="../../../configuration/resources#for_each-multiple-resource-instances-defined-by-a-map-or-set-of-strings"><code>for_each</code></a>, are used.</p> <p>As an example, consider a resource named <code>null_resource.foo</code> with a count of <code>2</code> located in a module named <code>bar</code>. While there will possibly be entries in the other imports for <code>module.bar.null_resource.foo[0]</code> and <code>module.bar.null_resource.foo[1]</code>, in <code>tfconfig/v2</code>, there will only be a <code>module.bar.null_resource.foo</code>. As mentioned in the start of this section, this is because configuration actually <em>defines</em> this scaling, whereas <em>expansion</em> actually happens when the resource graph is built, which happens as a natural part of the refresh and planning process.</p> <p>The <code>strip_index</code> helper function, found in this import, can assist in removing the indexes from addresses found in the <code>tfplan/v2</code> and <code>tfstate/v2</code> imports so that data from those imports can be used to reference data in this one.</p> <h2 id="the-strip_index-function">  The <code>strip_index</code> Function </h2> <p>The <code>strip_index</code> helper function can be used to remove indexes from addresses found in <a href="tfplan-v2"><code>tfplan/v2</code></a> and <a href="tfstate-v2"><code>tfstate/v2</code></a>, by removing the indexes from each resource.</p> <p>This can be used to help facilitate cross-import lookups for data between plan, state, and config.</p> <pre>import "tfconfig/v2" as tfconfig
import "tfplan/v2" as tfplan

main = rule {
    all filter tfplan.resource_changes as _, rc {
        rc.mode is "managed" and
            rc.type is "aws_instance"
    } as _, rc {
        tfconfig.resources[tfconfig.strip_index(rc.address)].config.ami.constant_value is "ami-abcdefgh012345"
    }
}
</pre>
<h2 id="expression-representations">  Expression Representations </h2> <p>Most collections in this import will have one of two kinds of <em>expression representations</em>. This is a verbose format for expressing a (parsed) configuration value independent of the configuration source code, which is not 100% available to a policy check in Terraform Cloud.</p> <pre>(expression representation)
├── constant_value (value)
└── references (list of strings)
</pre>
<p>There are two major parts to an expression representation:</p> <ul> <li>Any <em>strictly constant value</em> is expressed as an expression with a <code>constant_value</code> field. </li> <li>Any expression that requires some degree of evaluation to generate the final value - even if that value is known at plan time - is not expressed in configuration. Instead, any particular references that are made are added to the <code>references</code> field. More details on this field can be found in the <a href="../../../internals/json-format#expression-representation">expression representation</a> section of the JSON output format documentation. </li> </ul> <p>For example, to determine if an output is based on a particular resource value, one could do:</p> <pre>import "tfconfig/v2" as tfconfig

main = rule {
    tfconfig.outputs["instance_id"].value.references is ["aws_instance.foo"]
}
</pre>
<blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> The expression representation currently does not account for complex interpolations or other expressions that combine constants with other expression data. An example would be something like <code>"foo${var.bar}"</code> or <code>"foo"
+ var.bar</code>. In this situation, the partially constant data would be lost. We will be working to resolve this within future versions of the <code>tfconfig/v2</code> import.</p> </blockquote> <h3 id="block-expression-representation">  Block Expression Representation </h3> <p>Expanding on the above, a multi-value expression representation (such as the kind found in a <a href="#the-resources-collection"><code>resources</code></a> collection element) is similar, but the root value is a keyed map of expression representations. This is repeated until a "scalar" expression value is encountered, ie: a field that is not a block in the resource's schema.</p> <pre>(block expression representation)
└── (attribute key)
    ├── (child block expression representation)
    │   └── (...)
    ├── constant_value (value)
    └── references (list of strings)
</pre>
<p>As an example, one can validate expressions in an <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance"><code>aws_instance</code></a> resource using the following:</p> <pre>import "tfconfig/v2" as tfconfig

main = rule {
    tfconfig.resources["aws_instance.foo"].config.ami.constant_value is "ami-abcdefgh012345"
}
</pre>
<p>Note that <em>nested blocks</em>, sometimes known as <em>sub-resources</em>, will be nested in configuration as as list of blocks (reflecting their ultimate nature as a list of objects). An example would be the <code>aws_instance</code> resource's <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance#ebs-ephemeral-and-root-block-devices"><code>ebs_block_device</code></a> block:</p> <pre>import "tfconfig/v2" as tfconfig

main = rule {
    tfconfig.resources["aws_instance.foo"].config.ebs_block_device[0].volume_size &lt; 10
}
</pre>
<h2 id="the-providers-collection">  The <code>providers</code> Collection </h2> <p>The <code>providers</code> collection is a collection representing the configurations of all provider instances across all modules in the configuration.</p> <p>This collection is indexed by an opaque key. This is currently <code>module_address:provider.alias</code>, the same value as found in the <code>provider_config_key</code> field. <code>module_address</code> and the colon delimiter are omitted for the root module.</p> <p>The <code>provider_config_key</code> field is also found in the <code>resources</code> collection and can be used to locate a provider that belongs to a configured resource.</p> <p>The fields in this collection are as follows:</p> <ul> <li>
<a href="#provider_config_key"><code>provider_config_key</code></a> - The opaque configuration key, used as the index key. </li> <li>
<a href="#name"><code>name</code></a> - The name of the provider, ie: <code>aws</code>. </li> <li>
<a href="#alias"><code>alias</code></a> - The alias of the provider, ie: <code>east</code>. Empty for a default provider. </li> <li>
<a href="#module_address"><code>module_address</code></a> - The address of the module this provider appears in. </li> <li>
<a href="#config"><code>config</code></a> - A <a href="#block-expression-representation">block expression representation</a> with provider configuration values. </li> <li>
<a href="#version_constraint"><code>version_constraint</code></a> - The defined version constraint for this provider. </li> </ul> <h2 id="the-resources-collection">  The <code>resources</code> Collection </h2> <p>The <code>resources</code> collection is a collection representing all of the resources found in all modules in the configuration.</p> <p>This collection is indexed by the resource address.</p> <p>The fields in this collection are as follows:</p> <ul> <li>
<a href="#address"><code>address</code></a> - The resource address. This is the index of the collection. </li> <li>
<a href="#module_address-1"><code>module_address</code></a> - The module address that this resource was found in. </li> <li>
<a href="#mode"><code>mode</code></a> - The resource mode, either <code>managed</code> (resources) or <code>data</code> (data sources). </li> <li>
<a href="#type"><code>type</code></a> - The type of resource, ie: <code>null_resource</code> in <code>null_resource.foo</code>. </li> <li>
<a href="#name-1"><code>name</code></a> - The name of the resource, ie: <code>foo</code> in <code>null_resource.foo</code>. </li> <li>
<a href="#provider_config_key-1"><code>provider_config_key</code></a> - The opaque configuration key that serves as the index of the <a href="#the-providers-collection"><code>providers</code></a> collection. </li> <li>
<a href="#provisioners"><code>provisioners</code></a> - The ordered list of provisioners for this resource. The syntax of the provisioners matches those found in the <a href="#the-provisioners-collection"><code>provisioners</code></a> collection, but is a list indexed by the order the provisioners show up in the resource. </li> <li>
<a href="#config-1"><code>config</code></a> - The <a href="#block-expression-representation">block expression representation</a> of the configuration values found in the resource. </li> <li>
<a href="#count"><code>count</code></a> - The <a href="#expression-representations">expression data</a> for the <code>count</code> value in the resource. </li> <li>
<a href="#for_each"><code>for_each</code></a> - The <a href="#expression-representations">expression data</a> for the <code>for_each</code> value in the resource. </li> <li>
<a href="#depends_on"><code>depends_on</code></a> - The contents of the <code>depends_on</code> config directive, which declares explicit dependencies for this resource. </li> </ul> <h2 id="the-provisioners-collection">  The <code>provisioners</code> Collection </h2> <p>The <code>provisioners</code> collection is a collection of all of the provisioners found across all resources in the configuration.</p> <p>While normally bound to a resource in an ordered fashion, this collection allows for the filtering of provisioners within a single expression.</p> <p>This collection is indexed with a key following the format <code>resource_address:index</code>, with each field matching their respective field in the particular element below:</p> <ul> <li>
<a href="#resource_address"><code>resource_address</code></a>: The address of the resource that the provisioner was found in. This can be found in the <a href="#the-resources-collection"><code>resources</code></a> collection. </li> <li>
<a href="#type-1"><code>type</code></a>: The provisioner type, ie: <code>local_exec</code>. </li> <li>
<a href="#index"><code>index</code></a>: The provisioner index as it shows up in the resource provisioner order. </li> <li>
<a href="#config-2"><code>config</code></a>: The <a href="#block-expression-representation">block expression representation</a> of the configuration values in the provisioner. </li> </ul> <h2 id="the-variables-collection">  The <code>variables</code> Collection </h2> <p>The <code>variables</code> collection is a collection of all variables across all modules in the configuration.</p> <p>Note that this tracks variable definitions, not values. See the <a href="tfplan-v2#the-variables-collection"><code>tfplan/v2</code> <code>variables</code> collection</a> for variable values set within a plan.</p> <p>This collection is indexed by the key format <code>module_address:name</code>, with each field matching their respective name below. <code>module_address</code> and the colon delimiter are omitted for the root module.</p> <ul> <li>
<a href="#module_address-2"><code>module_address</code></a> - The address of the module the variable was found in. </li> <li>
<a href="#name-2"><code>name</code></a> - The name of the variable. </li> <li>
<a href="#default"><code>default</code></a> - The defined default value of the variable. </li> <li>
<a href="#description"><code>description</code></a> - The description of the variable. </li> </ul> <h2 id="the-outputs-collection">  The <code>outputs</code> Collection </h2> <p>The <code>outputs</code> collection is a collection of all outputs across all modules in the configuration.</p> <p>Note that this tracks variable definitions, not values. See the <a href="tfstate-v2#the-outputs-collection"><code>tfstate/v2</code> <code>outputs</code> collection</a> for the final values of outputs set within a state. The <a href="tfplan-v2#the-output_changes-collection"><code>tfplan/v2</code> <code>output_changes</code> collection</a> also contains a more complex collection of planned output changes.</p> <p>This collection is indexed by the key format <code>module_address:name</code>, with each field matching their respective name below. <code>module_address</code> and the colon delimiter are omitted for the root module.</p> <ul> <li>
<a href="#module_address-3"><code>module_address</code></a> - The address of the module the output was found in. </li> <li>
<a href="#name-3"><code>name</code></a> - The name of the output. </li> <li>
<a href="#sensitive"><code>sensitive</code></a> - Indicates whether or not the output was marked as <a href="../../../language/values/outputs#sensitive-suppressing-values-in-cli-output"><code>sensitive</code></a>. </li> <li>
<a href="#value"><code>value</code></a> - An <a href="#expression-representations">expression representation</a> for the output. </li> <li>
<a href="#description-1"><code>description</code></a> - The description of the output. </li> <li>
<a href="#depends_on-1"><code>depends_on</code></a> - A list of resource names that the output depends on. These are the hard-defined output dependencies as defined in the <a href="../../../language/values/outputs#depends_on-explicit-output-dependencies"><code>depends_on</code></a> field in an output declaration, not the dependencies that get derived from natural evaluation of the output expression (these can be found in the <code>references</code> field of the expression representation). </li> </ul> <h2 id="the-module_calls-collection">  The <code>module_calls</code> Collection </h2> <p>The <code>module_calls</code> collection is a collection of all module declarations at all levels within the configuration.</p> <p>Note that this is the <a href="../../../configuration/modules#calling-a-child-module"><code>module</code></a> stanza in any particular configuration, and not the module itself. Hence, a declaration for <code>module.foo</code> would actually be declared in the root module, which would be represented by a blank field in <code>module_address</code>.</p> <p>This collection is indexed by the key format <code>module_address:name</code>, with each field matching their respective name below. <code>module_address</code> and the colon delimiter are omitted for the root module.</p> <ul> <li>
<a href="#module_address-4"><code>module_address</code></a> - The address of the module the declaration was found in. </li> <li>
<a href="#name-4"><code>name</code></a> - The name of the module. </li> <li>
<a href="#source"><code>source</code></a> - The contents of the <code>source</code> field. </li> <li>
<a href="#config-3"><code>config</code></a> - A <a href="#block-expression-representation">block expression representation</a> for all parameter values sent to the module. </li> <li>
<a href="#count-1"><code>count</code></a> - An <a href="#expression-representations">expression representation</a> for the <code>count</code> field. </li> <li>
<a href="#depends_on-2"><code>depends_on</code></a>: An <a href="#expression-representations">expression representation</a> for the <code>depends_on</code> field. </li> <li>
<a href="#for_each-1"><code>for_each</code></a> - An <a href="#expression-representations">expression representation</a> for the <code>for_each</code> field. </li> <li>
<a href="#version_constraint-1"><code>version_constraint</code></a> - The string value found in the <code>version</code> field of the module declaration. </li> </ul><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/cloud/sentinel/import/tfconfig-v2.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/cloud/sentinel/import/tfconfig-v2.html</a>
  </p>
</div>
