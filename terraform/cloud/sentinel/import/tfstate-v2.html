 <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Sentinel policies are a paid feature, available as part of the <strong>Team &amp; Governance</strong> upgrade package. <a href="https://www.hashicorp.com/products/terraform/pricing">Learn more about Terraform Cloud pricing here</a>.</p> </blockquote> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> This is documentation for the next version of the <code>tfstate</code> Sentinel import, designed specifically for Terraform 0.12. This import requires Terraform 0.12 or higher, and must currently be loaded by path, using an alias, example: <code>import "tfstate/v2" as tfstate</code>.</p> </blockquote> <h1 id="import-tfstate-v2">  Import: tfstate/v2 </h1> <p>The <code>tfstate/v2</code> import provides access to a Terraform state.</p> <p>The <em>state</em> is the data that Terraform has recorded about a workspace at a particular point in its lifecycle, usually after an apply. You can read more general information about how Terraform uses state <a href="../../../language/state/index">here</a>.</p> <blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> Since Terraform Cloud currently only supports policy checks at plan time, the usefulness of this import is somewhat limited, as it will usually give you the state <em>prior</em> to the plan the policy check is currently being run for. Depending on your needs, you may find the <a href="tfplan-v2#the-planned_values-collection"><code>planned_values</code></a> collection in <code>tfplan/v2</code> more useful, which will give you a <em>predicted</em> state by applying plan data to the data found here. The one exception to this rule is <em>data sources</em>, which will always give up to date data here, as long as the data source could be evaluated at plan time.</p> </blockquote> <p>The data in the <code>tfstate/v2</code> import is sourced from the JSON configuration file that is generated by the <a href="../../../cli/commands/show#json-output"><code>terraform show
-json</code></a> command. For more information on the file format, see the <a href="../../../internals/json-format">JSON Output Format</a> page.</p> <h2 id="import-overview">  Import Overview </h2> <p>The <code>tfstate/v2</code> import is structured as currently two <em>collections</em>, keyed in resource address and output name, respectively.</p> <pre>(tfstate/v2)
├── terraform_version (string)
├── resources
│   └── (indexed by address)
│       ├── address (string)
│       ├── module_address (string)
│       ├── mode (string)
│       ├── type (string)
│       ├── name (string)
│       ├── index (float (number) or string)
│       ├── provider_name (string)
│       ├── values (map)
│       ├── depends_on (list of strings)
│       ├── tainted (boolean)
│       └── deposed_key (string)
└── outputs
    └── (indexed by name)
        ├── name (string)
        ├── sensitive (boolean)
        └── value (value)
</pre>
<p>The collections are:</p> <ul> <li>
<a href="#the-resources-collection"><code>resources</code></a> - The state of all resources across all modules in the state. </li> <li>
<a href="#the-outputs-collection"><code>outputs</code></a> - The state of all outputs from the root module in the state. </li> </ul> <p>These collections are specifically designed to be used with the <a href="https://docs.hashicorp.com/sentinel/language/collection-operations#filter-expression"><code>filter</code></a> quantifier expression in Sentinel, so that one can collect a list of resources to perform policy checks on without having to write complex module traversal. As an example, the following code will return all <code>aws_instance</code> resource types within the state, regardless of what module they are in:</p> <pre>all_aws_instances = filter tfstate.resources as _, r {
    r.mode is "managed" and
        r.type is "aws_instance"
}
</pre>
<p>You can add specific attributes to the filter to narrow the search, such as the module address. The following code would return resources in a module named <code>foo</code> only:</p> <pre>all_aws_instances = filter tfstate.resources as _, r {
    r.module_address is "module.foo" and
        r.mode is "managed" and
        r.type is "aws_instance"
}
</pre>
<h2 id="the-terraform_version-value">  The <code>terraform_version</code> Value </h2> <p>The top-level <code>terraform_version</code> value in this import gives the Terraform version that recorded the state. This can be used to do version validation.</p> <pre>import "tfstate/v2" as tfstate
import "strings"

v = strings.split(tfstate.terraform_version, ".")
version_major = int(v[1])
version_minor = int(v[2])

main = rule {
    version_major is 12 and version_minor &gt;= 19
}
</pre>
<blockquote class="alert alert-info" role="alert"> <p><strong>NOTE:</strong> The above example will give errors when working with pre-release versions (example: <code>0.12.0beta1</code>). Future versions of this import will include helpers to assist with processing versions that will account for these kinds of exceptions.</p> </blockquote> <h2 id="the-resources-collection">  The <code>resources</code> Collection </h2> <p>The <code>resources</code> collection is a collection representing all of the resources in the state, across all modules.</p> <p>This collection is indexed on the complete resource address as the key.</p> <p>An element in the collection has the following values:</p> <ul> <li>
<a href="#address"><code>address</code></a> - The absolute resource address - also the key for the collection's index. </li> <li>
<a href="#module_address"><code>module_address</code></a> - The address portion of the absolute resource address. </li> <li>
<a href="#mode"><code>mode</code></a> - The resource mode, either <code>managed</code> (resources) or <code>data</code> (data sources). </li> <li>
<a href="#type"><code>type</code></a> - The resource type, example: <code>aws_instance</code> for <code>aws_instance.foo</code>. </li> <li>
<a href="#name"><code>name</code></a> - The resource name, example: <code>foo</code> for <code>aws_instance.foo</code>. </li> <li>
<a href="#index"><code>index</code></a> - The resource index. Can be either a number or a string. </li> <li>
<p><a href="#provider_name"><code>provider_name</code></a> - The name of the provider this resource belongs to. This allows the provider to be interpreted unambiguously in the unusual situation where a provider offers a resource type whose name does not start with its own name, such as the <code>googlebeta</code> provider offering <code>google_compute_instance</code>.</p> <blockquote class="alert alert-info" role="alert"> <p><strong>Note:</strong> Starting with Terraform 0.13, the <code>provider_name</code> field contains the <em>full</em> source address to the provider in the Terraform Registry. Example: <code>registry.terraform.io/hashicorp/null</code> for the null provider.</p> </blockquote> </li> <li>
<p><a href="#values"><code>values</code></a> - An object (map) representation of the attribute values of the resource, whose structure depends on the resource type schema. When accessing proposed state through the <a href="tfplan-v2#the-planned_values-collection"><code>planned_values</code></a> collection of the tfplan/v2 import, unknown values will be omitted.</p> </li> <li>
<p><a href="#depends_on"><code>depends_on</code></a> - The addresses of the resources that this resource depends on.</p> </li> <li>
<p><a href="#tainted"><code>tainted</code></a> - <code>true</code> if the resource has been explicitly marked as <a href="../../../cli/commands/taint">tainted</a> in the state.</p> </li> <li>
<p><a href="#deposed_key"><code>deposed_key</code></a> - Set if the resource has been marked deposed and will be destroyed on the next apply. This matches the deposed field in the <a href="tfplan-v2#the-resource_changes-collection"><code>resource_changes</code></a> collection in the <a href="tfplan-v2"><code>tfplan/v2</code></a> import.</p> </li> </ul> <h2 id="the-outputs-collection">  The <code>outputs</code> Collection </h2> <p>The <code>outputs</code> collection is a collection of outputs from the root module of the state.</p> <p>Note that no child modules are included in this output set, and there is no way to fetch child module output values. This is to encourage the correct flow of outputs to the recommended root consumption level.</p> <p>The collection is indexed on the output name, with the following fields:</p> <ul> <li>
<a href="#name-1"><code>name</code></a>: The name of the output, also the collection key. </li> <li>
<a href="#sensitive"><code>sensitive</code></a>: Whether or not the value was marked as <a href="../../../language/values/outputs#sensitive-suppressing-values-in-cli-output">sensitive</a> in configuration. </li> <li>
<a href="#value"><code>value</code></a>: The value of the output. </li> </ul><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/cloud/sentinel/import/tfstate-v2.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/cloud/sentinel/import/tfstate-v2.html</a>
  </p>
</div>
