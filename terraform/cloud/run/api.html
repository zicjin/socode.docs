 <h1 id="the-api-driven-run-workflow">  The API-driven Run Workflow </h1> <p>Terraform Cloud has three workflows for managing Terraform runs.</p> <ul> <li>The <a href="ui">UI/VCS-driven run workflow</a>, which is the primary mode of operation. </li> <li>The API-driven run workflow described below, which is more flexible but requires you to create some tooling. </li> <li>The <a href="cli">CLI-driven run workflow</a>, which uses Terraform's standard CLI tools to execute runs in Terraform Cloud. </li> </ul> <h2 id="summary">  Summary </h2> <p>In the API-driven workflow, workspaces are not directly associated with a VCS repo, and runs are not driven by webhooks on your VCS provider.</p> <p>Instead, one of your organization's other tools is in charge of deciding when configuration has changed and a run should occur. Usually this is something like a CI system, or something else capable of monitoring changes to your Terraform code and performing actions in response.</p> <p>Once your other tooling has decided a run should occur, it must make a series of calls to Terraform Cloud's <code>runs</code> and <code>configuration-versions</code> APIs to upload configuration files and perform a run with them. For the exact series of API calls, see the <a href="#pushing-a-new-configuration-version">pushing a new configuration version</a> section.</p> <p>The most significant difference in this workflow is that Terraform Cloud <em>does not</em> fetch configuration files from version control. Instead, your own tooling must upload the configurations as a <code>.tar.gz</code> file. This allows you to work with configurations from unsupported version control systems, automatically generate Terraform configurations from some other source of data, or build a variety of other integrations.</p> <blockquote class="alert alert-warning" role="alert"> <p><strong>Important:</strong> The script below is provided to illustrate the run process, and is not intended for production use. If you want to drive Terraform Cloud runs from the command line, please see the <a href="cli">CLI-driven run workflow</a>.</p> </blockquote> <h2 id="pushing-a-new-configuration-version">  Pushing a New Configuration Version </h2> <p>Pushing a new configuration to an existing workspace is a multi-step process. This section walks through each step in detail, using an example bash script to illustrate.</p> <p>Creating new configuration versions requires permission to queue plans for the workspace. (<a href="../users-teams-organizations/permissions">More about permissions.</a>)</p> <h3 id="1-define-variables">  1. Define Variables </h3> <p>To perform an upload, a few user parameters must be set:</p> <ul> <li>
<strong>path_to_content_directory</strong> is the folder with the terraform configuration. There must be at least one <code>.tf</code> file in the root of this path. </li> <li>
<strong>organization</strong> is the organization name (not ID) for your Terraform Cloud organization. </li> <li>
<strong>workspace</strong> is the workspace name (not ID) in the Terraform Cloud organization. </li> <li>
<strong>$TOKEN</strong> is the API Token used for <a href="../api/index#authentication">authenticating with the Terraform Cloud API</a>. </li> </ul> <p>This script extracts the <code>path_to_content_directory</code>, <code>organization</code>, and <code>workspace</code> from command line arguments, and expects the <code>$TOKEN</code> as an environment variable.</p> <pre data-language="shell">#!/bin/bash

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: $0 &lt;path_to_content_directory&gt; &lt;organization&gt;/&lt;workspace&gt;"
  exit 0
fi

CONTENT_DIRECTORY="$1"
ORG_NAME="$(cut -d'/' -f1 &lt;&lt;&lt;"$2")"
WORKSPACE_NAME="$(cut -d'/' -f2 &lt;&lt;&lt;"$2")"
</pre>
<h3 id="2-create-the-file-for-upload">  2. Create the File for Upload </h3> <p>The <a href="../api/configuration-versions">configuration version API</a> requires a <code>tar.gz</code> file to be uploaded in order for the configration version to be used for a run, so the content directory (the directory containing the Terraform configuration) must be packaged into a <code>tar.gz</code> file.</p> <blockquote class="alert alert-warning" role="alert"> <p><strong>Important:</strong> The configuration directory must be the root of the tar file, with no intermediate directories. In other words, when the tar file is extracted the result must be paths like <code>./main.tf</code> rather than <code>./terraform-appserver/main.tf</code>.</p> </blockquote> <pre data-language="shell">UPLOAD_FILE_NAME="./content-$(date +%s).tar.gz"
tar -zcvf "$UPLOAD_FILE_NAME" -C "$CONTENT_DIRECTORY" .
</pre>
<h3 id="3-look-up-the-workspace-id">  3. Look Up the Workspace ID </h3> <p>The first step identified the organization name and the workspace name; however, the <a href="../api/configuration-versions">configuration version API</a> expects the workspace ID. As such, the ID has to be looked up. If the workspace ID is already known, this step can be skipped. This step uses the <a href="https://stedolan.github.io/jq/"><code>jq</code> tool</a> to parse the JSON output and extract the ID value into the <code>WORKSPACE_ID</code> variable.</p> <pre data-language="shell">WORKSPACE_ID=($(curl \
  --header "Authorization: Bearer $TOKEN" \
  --header "Content-Type: application/vnd.api+json" \
  https://app.terraform.io/api/v2/organizations/$ORG_NAME/workspaces/$WORKSPACE_NAME \
  | jq -r '.data.id'))
</pre>
<h3 id="4-create-a-new-configuration-version">  4. Create a New Configuration Version </h3> <p>Before uploading the configuration files, you must create a <code>configuration-version</code> to associate uploaded content with the workspace. This API call performs two tasks: it creates the new configuration version and it extracts the upload URL to be used in the next step.</p> <pre data-language="shell">echo '{"data":{"type":"configuration-versions"}}' &gt; ./create_config_version.json

UPLOAD_URL=($(curl \
  --header "Authorization: Bearer $TOKEN" \
  --header "Content-Type: application/vnd.api+json" \
  --request POST \
  --data @create_config_version.json \
  https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/configuration-versions \
  | jq -r '.data.attributes."upload-url"'))
</pre>
<h3 id="5-upload-the-configuration-content-file">  5. Upload the Configuration Content File </h3> <p>Next, upload the configuration version <code>tar.gz</code> file to the upload URL extracted from the previous step. If a file is not uploaded, the configuration version will not be usable, since it will have no Terraform configuration files.</p> <p>Terraform Cloud automatically creates a new run with a plan once the new file is uploaded. If the workspace is configured to auto-apply, it will also apply if the plan succeeds; otherwise, an apply can be triggered via the <a href="../api/run#apply">Run Apply API</a>. If the API token used for the upload lacks permission to apply runs for the workspace, the run can't be auto-applied. (<a href="../users-teams-organizations/permissions">More about permissions.</a>)</p> <pre data-language="shell">curl \
  --header "Content-Type: application/octet-stream" \
  --request PUT \
  --data-binary @"$UPLOAD_FILE_NAME" \
  $UPLOAD_URL
</pre>
<h3 id="6-delete-temporary-files">  6. Delete Temporary Files </h3> <p>In the previous steps a few files were created; they are no longer needed, so they should be deleted.</p> <pre data-language="shell">rm "$UPLOAD_FILE_NAME"
rm ./create_config_version.json
</pre>
<h3 id="complete-script">  Complete Script </h3> <p>Combine all of the code blocks into a single file, <code>./terraform-enterprise-push.sh</code> and give execution permission to create a combined bash script to perform all of the operations.</p> <pre data-language="shell">chmod +x ./terraform-enterprise-push.sh
./terraform-enterprise-push.sh ./content my-organization/my-workspace
</pre>
<p><strong>Note</strong>: This script does not have error handling, so for a more robust script consider adding error checking.</p> <p><strong><code>./terraform-enterprise-push.sh</code>:</strong></p> <pre data-language="shell">#!/bin/bash

# Complete script for API-driven runs.
# Documentation can be found at:
# https://www.terraform.io/docs/cloud/run/api.html

# 1. Define Variables

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: $0 &lt;path_to_content_directory&gt; &lt;organization&gt;/&lt;workspace&gt;"
  exit 0
fi

CONTENT_DIRECTORY="$1"
ORG_NAME="$(cut -d'/' -f1 &lt;&lt;&lt;"$2")"
WORKSPACE_NAME="$(cut -d'/' -f2 &lt;&lt;&lt;"$2")"

# 2. Create the File for Upload

UPLOAD_FILE_NAME="./content-$(date +%s).tar.gz"
tar -zcvf "$UPLOAD_FILE_NAME" -C "$CONTENT_DIRECTORY" .

# 3. Look Up the Workspace ID

WORKSPACE_ID=($(curl \
  --header "Authorization: Bearer $TOKEN" \
  --header "Content-Type: application/vnd.api+json" \
  https://app.terraform.io/api/v2/organizations/$ORG_NAME/workspaces/$WORKSPACE_NAME \
  | jq -r '.data.id'))

# 4. Create a New Configuration Version

echo '{"data":{"type":"configuration-versions"}}' &gt; ./create_config_version.json

UPLOAD_URL=($(curl \
  --header "Authorization: Bearer $TOKEN" \
  --header "Content-Type: application/vnd.api+json" \
  --request POST \
  --data @create_config_version.json \
  https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/configuration-versions \
  | jq -r '.data.attributes."upload-url"'))

# 5. Upload the Configuration Content File

curl \
  --header "Content-Type: application/octet-stream" \
  --request PUT \
  --data-binary @"$UPLOAD_FILE_NAME" \
  $UPLOAD_URL

# 6. Delete Temporary Files

rm "$UPLOAD_FILE_NAME"
rm ./create_config_version.json
</pre>
<h2 id="advanced-use-cases">  Advanced Use Cases </h2> <p>For advanced use cases see the <a href="https://github.com/hashicorp/terraform-guides/tree/master/operations/automation-script">TFE Automation Script</a> repository for automating interactions with Terraform Cloud, including the creation of a workspace, uploading code, setting variables, and triggering a plan/apply.</p> <p>In addition to uploading configurations and starting runs, you can use Terraform Cloud's APIs to create and modify workspaces, edit variable values, and more. See the <a href="../api/index">API documentation</a> for more details.</p><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/cloud/run/api.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/cloud/run/api.html</a>
  </p>
</div>
