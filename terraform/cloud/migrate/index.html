 <h1 id="migrating-state-from-local-terraform">  Migrating State from Local Terraform </h1> <blockquote> <p><strong>Hands-on:</strong> Try the <a href="https://learn.hashicorp.com/tutorials/terraform/cloud-migrate?in=terraform/state&amp;utm_source=WEBSITE&amp;utm_medium=WEB_IO&amp;utm_offer=ARTICLE_PAGE&amp;utm_content=DOCS">Migrate State to Terraform Cloud</a> tutorial on HashiCorp Learn.</p> </blockquote> <p>If you already use Terraform to manage infrastructure, you're probably managing some resources that you want to transfer to Terraform Cloud. By migrating your Terraform <a href="../../language/state/index">state</a> to Terraform Cloud, you can continue managing that infrastructure without de-provisioning anything.</p> <blockquote class="alert alert-warning" role="alert"> <p><strong>Important:</strong> These instructions are for migrating state in a basic working directory that only uses the <code>default</code> workspace. If you use multiple <a href="../../language/state/workspaces">workspaces</a> in one working directory, the instructions are different; see <a href="workspaces">Migrating State from Multiple Terraform Workspaces</a> instead.</p> </blockquote> <blockquote class="alert alert-info" role="alert"> <p><strong>API:</strong> See the <a href="../api/state-versions">State Versions API</a>. Be sure to stop Terraform runs before migrating state to Terraform Cloud, and only import state into Terraform Cloud workspaces that have never performed a run.</p> </blockquote> <h2 id="step-1-ensure-terraform-0-11-13-is-installed">  Step 1: Ensure Terraform â‰¥ 0.11.13 is Installed </h2> <p>To follow these instructions, you need Terraform 0.11.13 or later on the workstation where you are performing the migration. In older versions, <a href="../../language/settings/backends/remote">the <code>remote</code> backend</a> is either absent or only partially supported.</p> <h2 id="step-2-gather-credentials-data-and-code">  Step 2: Gather Credentials, Data, and Code </h2> <p>Make sure you have all of the following:</p> <ul> <li>The location of the VCS repository for the Terraform configuration in question. </li> <li>A local working copy of the Terraform configuration in question. </li> <li>The existing state data. The location of the state depends on which <a href="../../language/settings/backends/index">backend</a> you've been using: <ul> <li>If you were using the default <code>local</code> backend, your state is a file on disk. You need the original working directory where you've been running Terraform, or a copy of the <code>terraform.tfstate</code> file to copy into a fresh working directory. </li> <li>For other backends, you need the path to the particular storage being used (usually already included in the configuration) and access credentials (which you usually must set as an environment variable). </li> </ul> </li> <li>
<p>A Terraform Cloud user account.</p> <p>This account must have permission to manage workspaces for the organization. (<a href="../users-teams-organizations/permissions">More about permissions.</a>)</p> </li> </ul> <p>You also need to authenticate Terraform with Terraform Cloud. If you're using Terraform 0.12.21 or later, you can use the <code>terraform login</code> command. Alternatively, you can create a <a href="../users-teams-organizations/users#api-tokens">user API token</a> and <a href="../../cli/config/config-file#credentials">manually configure credentials in the CLI config file</a>.</p> <h2 id="step-3-stop-terraform-runs">  Step 3: Stop Terraform Runs </h2> <p>However you currently run Terraform to manage this infrastructure, stop. Let any current runs finish, then make sure there won't be more.</p> <p>This might involve locking or deleting CI jobs, restricting access to the state backend, or just communicating very clearly with your colleagues.</p> <h2 id="step-4-prepare-your-terraform-working-directory">  Step 4: Prepare Your Terraform Working Directory </h2> <p>In your shell, go to the directory with the Terraform configuration you're migrating.</p> <ul> <li>If you've already been doing Terraform runs in this directory, you should be ready to go. </li> <li>If you had to retrieve a <code>terraform.tfstate</code> file from elsewhere, copy it into the root of the working directory and run <code>terraform init</code>. </li> <li>If you use a remote backend and had to check out a fresh working directory from version control, run <code>terraform init</code>. </li> </ul> <h2 id="step-5-edit-the-backend-configuration">  Step 5: Edit the Backend Configuration </h2> <p>If the Terraform configuration has an existing <a href="../../language/settings/backends/configuration">backend configuration block</a>, delete it now.</p> <p>Add a new backend block to the configuration:</p> <pre data-language="ruby">terraform {
  backend "remote" {
    hostname = "app.terraform.io"
    organization = "my-org"

    workspaces {
      name = "my-workspace"
    }
  }
}
</pre> <ul> <li>Use the <code>remote</code> backend. </li> <li>In the <code>organization</code> attribute, specify the name of your Terraform Cloud organization. </li> <li>The <code>hostname</code> attribute is only necessary with Terraform Enterprise instances. You can omit it if you're using the SaaS version of Terraform Cloud. </li> <li>In the <code>name</code> attribute in the <code>workspaces</code> block, specify the name of a new <a href="../workspaces/index">Terraform Cloud workspace</a> to create with your state. Make sure your organization doesn't already have a workspace with this name. </li> </ul> <p>For more details about this configuration block, see <a href="../../language/settings/backends/remote">the remote backend documentation</a>.</p> <h2 id="step-6-run-terraform-init-to-migrate-the-workspace">  Step 6: Run <code>terraform init</code> to Migrate the Workspace </h2> <p>Run <code>terraform init</code>.</p> <p>The init command will offer to migrate the previous state to a new Terraform Cloud workspace. The prompt usually looks like this:</p> <pre>Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous "local" backend to the
  newly configured "remote" backend. No existing state was found in the newly
  configured "remote" backend. Do you want to copy this state to the new "remote"
  backend? Enter "yes" to copy and "no" to start with an empty state.
</pre>
<p>Answer "yes," and Terraform will migrate your state.</p> <h2 id="step-7-configure-the-terraform-cloud-workspace">  Step 7: Configure the Terraform Cloud Workspace </h2> <p>In Terraform Cloud's UI, make any settings changes necessary for your new workspace.</p> <ul> <li>
<a href="../workspaces/vcs#vcs-connection-and-repository">Set the VCS repository</a>. This is optional, but enables automatic Terraform runs on code changes and automatic plans on pull requests. For more information, see <a href="../run/ui">The UI- and VCS-driven Run Workflow</a>. </li> <li>
<a href="../workspaces/variables">Set values for variables</a>. </li> <li>
<a href="../workspaces/access">Set team access permissions</a>. </li> </ul> <h2 id="step-8-queue-a-run-in-the-new-workspace">  Step 8: Queue a Run in the New Workspace </h2> <p>Either run <code>terraform plan</code> on the CLI or navigate to the workspace in Terraform Cloud's UI and <a href="../run/ui#manually-starting-runs">queue a plan</a>. Examine the results.</p> <p>If all went well, the plan should result in no changes or very small changes. Terraform Cloud can now take over all Terraform runs for this infrastructure.</p> <h2 id="troubleshooting">  Troubleshooting </h2> <ul> <li>
<p>If the plan would create an entirely new set of infrastructure resources, you probably have the wrong state file.</p> <p>In the case of a wrong state file, you can recover by fixing your local working directory and trying again. You'll need to re-set to the local backend, run <code>terraform init</code>, replace the state file with the correct one, change back to the <code>remote</code> backend, run <code>terraform init</code> again, and confirm that you want to replace the remote state with the current local state.</p> </li> <li>
<p>If the plan recognizes the existing resources but would make unexpected changes, check whether the designated VCS branch for the workspace is the same branch you've been running Terraform on; if not, update it. You can also check whether variables in the Terraform Cloud workspace have the correct values.</p> </li> </ul><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://www.terraform.io/docs/cloud/migrate/index.html" class="_attribution-link" target="_blank">https://www.terraform.io/docs/cloud/migrate/index.html</a>
  </p>
</div>
