<h1 data-toc="kmm-concurrent-mutability" id="kmm-concurrent-mutability.md">Concurrent mutability</h1>
<p id="137b299c">When it comes to working with iOS, <a href="kmm-concurrency-overview" id="b72733e7">Kotlin/Native's state and concurrency model</a> has <a href="kmm-concurrency-overview#rules-for-state-sharing" id="313e88ef">two simple rules</a>.</p>
<ol class="list _decimal" id="3f2dd65e">
<li class="list__item" id="a7146e92"><p>A mutable, non-frozen state is visible to only one thread at a time.</p></li>
<li class="list__item" id="4547f93e"><p>An immutable, frozen state can be shared between threads.</p></li>
</ol>
<p id="7d159dbf">The result of following these rules is that you can't change <a href="kmm-concurrency-overview#global-state" id="508a4080">global states</a>, and you can't change the same shared state from multiple threads. In many cases, simply changing your approach to how you design your code will work fine, and you don't need concurrent mutability. States were mutable from multiple threads in JVM code, but they didn't <em id="75a7671e" class="">need</em> to be.</p>
<p id="3145cf7a">However, in many other cases, you may need arbitrary thread access to a state, or you may have <em id="db3ccf95" class="">service</em> objects that should be available to the entire application. Or maybe you simply don't want to go through the potentially costly exercise of redesigning existing code. Whatever the reason, <em id="52d93f99" class="">it will not always be feasible to constrain a mutable state to a single thread</em>.</p>
<p id="34afd62c">There are various techniques that help you work around these restrictions, each with their own pros and cons:</p>
<ul class="list _ul" id="5274e3e7">
<li class="list__item" id="7695ce9a"><p><a href="#atomics" id="b62a7fd1">Atomics</a></p></li>
<li class="list__item" id="f289e1f3"><p><a href="#thread-isolated-state" id="44732c58">Thread-isolated states</a></p></li>
<li class="list__item" id="7cbe226e"><p><a href="#low-level-capabilities" id="f2d5c1b2">Low-level capabilities</a></p></li>
</ul>
<section class="chapter"><h2 id="atomics" data-toc="kmm-concurrent-mutability#atomics">Atomics</h2>
<p id="23806fe0">Kotlin/Native provides a set of Atomic classes that can be frozen while still supporting changes to the value they contain. These classes implement a special-case handling of states in the Kotlin/Native runtime. This means that you can change values inside a frozen state.</p>
<p id="d27720f8">The Kotlin/Native runtime includes a few different variations of Atomics. You can use them directly or from a library.</p>
<p id="7fefc099">Kotlin provides an experimental low-level <a href="https://github.com/Kotlin/kotlinx.atomicfu" id="97acd9bb" data-external="true" rel="noopener noreferrer"><code class="code ">kotlinx.atomicfu</code></a> library that is currently used only for internal purposes and is not supported for general usage. You can also use <a href="https://github.com/touchlab/Stately" id="a6f19d3a" data-external="true" rel="noopener noreferrer">Stately</a>, a utility library for multiplatform compatibility with Kotlin/Native-specific concurrency, developed by <a href="https://touchlab.co" id="9bdbab97" data-external="true" rel="noopener noreferrer">Touchlab</a>.</p>
<section class="chapter"><h3 id="atomicint-atomiclong" data-toc="kmm-concurrent-mutability#atomicint-atomiclong">AtomicInt/AtomicLong</h3>
<p id="80cd6c49">The first two are simple numerics: <code class="code ">AtomicInt</code> and <code class="code ">AtomicLong</code>. They allow you to have a shared <code class="code ">Int</code> or <code class="code ">Long</code> that can be read and changed from multiple threads.</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">object AtomicDataCounter { val count = AtomicInt(3) fun addOne() { count.increment() } } </pre>
<p id="6832754f">The example above is a global <code class="code ">object</code>, which is frozen by default in Kotlin/Native. In this case, however, you can change the value of <code class="code ">count</code>. It's important to note that you can change the value of <code class="code ">count</code><em id="1c641f2b" class="">from any thread</em>.</p></section><section class="chapter"><h3 id="atomicreference" data-toc="kmm-concurrent-mutability#atomicreference">AtomicReference</h3>
<p id="cd9470f8"><code class="code ">AtomicReference</code> holds an object instance, and you can change that object instance. The object you put in <code class="code ">AtomicReference</code> must be frozen, but you can change the value that <code class="code ">AtomicReference</code> holds. For example, the following won't work in Kotlin/Native:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">data class SomeData(val i: Int) object GlobalData { var sd = SomeData(0) fun storeNewValue(i: Int) { sd = SomeData(i) //Doesn't work } } </pre>
<p id="fa9b0298">According to the <a href="kmm-concurrency-overview#global-state" id="5d003854">rules of global state</a>, global <code class="code ">object</code> values are frozen in Kotlin/Native, so trying to modify <code class="code ">sd</code> will fail. You could implement it instead with <code class="code ">AtomicReference</code>:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">data class SomeData(val i: Int) object GlobalData { val sd = AtomicReference(SomeData(0).freeze()) fun storeNewValue(i: Int) { sd.value = SomeData(i).freeze() } } </pre>
<p id="a74bb698">The <code class="code ">AtomicReference</code> itself is frozen, which lets it live inside something that is frozen. The data in the <code class="code ">AtomicReference</code> instance is explicitly frozen in the code above. However, in the multiplatform libraries, the data will be frozen automatically. If you use the Kotlin/Native runtime's <code class="code ">AtomicReference</code>, you <em id="49d593a" class="">should</em> remember to call <code class="code ">freeze()</code> explicitly.</p>
<p id="54d1cc45"><code class="code ">AtomicReference</code> can be very useful when you need to share a state. There are some drawbacks to consider, however.</p>
<p id="d9a69985">Accessing and changing values in an <code class="code ">AtomicReference</code> is very costly performance-wise <em id="253b5469" class="">relative to</em> a standard mutable state. If performance is a concern, you may want to consider using another approach involving a <a href="#thread-isolated-state" id="73874448">thread-isolated state</a>.</p>
<p id="aa6bf25f">There is also a potential issue with memory leaks, which will be resolved in the future. In situations where the object kept in the <code class="code ">AtomicReference</code> has cyclical references, it may leak memory if you don't explicitly clear it out:</p>
<ul class="list _ul" id="329031c8">
<li class="list__item" id="b2327910"><p>If you have state that may have cyclic references and needs to be reclaimed, you should use a nullable type in the <code class="code ">AtomicReference</code> and set it to null explicitly when you're done with it.</p></li>
<li class="list__item" id="c1465ab5"><p>If you're keeping <code class="code ">AtomicReference</code> in a global object that never leaves scope, this won't matter (because the memory never needs to be reclaimed during the life of the process).</p></li>
</ul>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">class Container(a:A) { val atom = AtomicReference&lt;A?&gt;(a.freeze()) /** * Call when you're done with Container */ fun clear(){ atom.value = null } } </pre>
<p id="8212afb8">Finally, there's also a consistency concern. Setting/getting values in <code class="code ">AtomicReference</code> is itself atomic, but if your logic requires a longer chain of thread exclusion, you'll need to implement that yourself. For example, if you have a list of values in an <code class="code ">AtomicReference</code> and you want to scan them first before adding a new one, you'll need to have some form of concurrency management that <code class="code ">AtomicReference</code> alone does not provide.</p>
<p id="a54be008">The following won't protect against duplicate values in the list if called from multiple threads:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">object MyListCache { val atomicList = AtomicReference(listOf&lt;String&gt;().freeze()) fun addEntry(s:String){ val l = atomicList.value val newList = mutableListOf&lt;String&gt;() newList.addAll(l) if(!newList.contains(s)){ newList.add(s) } atomicList.value = newList.freeze() } } </pre>
<p id="910b5548">You will need to implement some form of locking or check-and-set logic to ensure proper concurrency.</p></section></section><section class="chapter"><h2 id="thread-isolated-state" data-toc="kmm-concurrent-mutability#thread-isolated-state">Thread-isolated state</h2>
<p id="c302665c"><a href="kmm-concurrency-overview#rule-1-mutable-state-1-thread" id="c6b6269">Rule 1 of Kotlin/Native state</a> is that a mutable state is visible to only one thread. Atomics allow mutability from any thread. Isolating a mutable state to a single thread, and allowing other threads to communicate with that state, is an alternative method for achieving concurrent mutability.</p>
<p id="2eb42284">To do this, create a work queue that has exclusive access to a thread, and create a mutable state that lives in just that thread. Other threads communicate with the mutable thread by scheduling <em id="fd312e" class="">work</em> on the work queue.</p>
<p id="64d5dc78">Data that goes in or comes out, if any, needs to be frozen, but the mutable state hidden in the worker thread remains mutable.</p>
<p id="6b00622a">Conceptually it looks like the following: one thread pushes a frozen state into the state worker, which stores it in the mutable state container. Another thread later schedules work that takes that state out.</p>
<figure data-theme="light" id="2329fc7c" width="600" class=" "><img class="js-gif article__bordered-element  " src="data:image/png;base64,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" data-gif-src="images/isolated-state.animated.gif" alt="Thread-isolated state" width="600" style="width: 600px;"></figure><p id="5405f1a9">Implementing thread-isolated states is somewhat complex, but there are libraries that provide this functionality.</p>
<section class="chapter"><h3 id="atomicreference-vs-thread-isolated-state" data-toc="kmm-concurrent-mutability#atomicreference-vs-thread-isolated-state">AtomicReference vs. thread-isolated state</h3>
<p id="3794a628">For simple values, <code class="code ">AtomicReference</code> will likely be an easier option. For cases with significant states, and potentially significant state changes, using a thread-isolated state may be a better choice. The main performance penalty is actually crossing over threads. But in performance tests with collections, for example, a thread-isolated state significantly outperforms a mutable state implemented with <code class="code ">AtomicReference</code>.</p>
<p id="21186e0e">The thread-isolated state also avoids the consistency issues that <code class="code ">AtomicReference</code> has. Because all operations happen in the state thread, and because you're scheduling work, you can perform operations with multiple steps and guarantee consistency without managing thread exclusion. Thread isolation is a design feature of the Kotlin/Native state rules, and isolating mutable states works with those rules.</p>
<p id="f1c8a108">The thread-isolated state is also more flexible insofar as you can make mutable states concurrent. You can use any type of mutable state, rather than needing to create complex concurrent implementations.</p></section></section><section class="chapter"><h2 id="low-level-capabilities" data-toc="kmm-concurrent-mutability#low-level-capabilities">Low-level capabilities</h2>
<p id="731ed66b">Kotlin/Native has some more advanced ways of sharing concurrent states. To achieve high performance, you may need to avoid the concurrency rules altogether.</p>
<aside data-type="note" class="prompt" data-title="" id="4b0376f0"><p id="900d39b7">This is a more advanced topic. You should have a deep understanding of how concurrency in Kotlin/Native works under the hood, and you’ll need to be very careful when using this approach. Learn more about <a href="native-concurrency" id="ba5baf1c">concurrency</a>.</p></aside><p id="b5d30be3">Kotlin/Native runs on top of C++ and provides interop with C and Objective-C. If you are running on iOS, you can also pass lambda arguments into your shared code from Swift. All of this native code runs outside of the Kotlin/Native state restrictions.</p>
<p id="6a378610">That means that you can implement a concurrent mutable state in a native language and have Kotlin/Native talk to it.</p>
<p id="8c986dce">You can use <a href="native-c-interop" id="64bf58dd">Objective-C interop</a> to access low-level code. You can also use Swift to implement Kotlin interfaces or pass in lambdas that Kotlin code can call from any thread.</p>
<p id="67024230">One of the benefits of a platform-native approach is performance. On the negative side, you'll need to manage concurrency on your own. Objective-C does not know about <code class="code ">frozen</code>, but if you store states from Kotlin in Objective-C structures, and share them between threads, the Kotlin states definitely need to be frozen. Kotlin/Native's runtime will generally warn you about issues, but it's possible to cause concurrency problems in native code that are very, very difficult to track down. It is also very easy to create memory leaks.</p>
<p id="b20dd8fa">Since in the KMM application you are also targeting the JVM, you'll need alternate ways to implement anything you use platform native code for. This will obviously take more work and may lead to platform inconsistencies.</p>
<p id="1e25b6da"><em id="f1e39bef" class="">This material was prepared by <a href="https://touchlab.co/" id="b33d5c0f" data-external="true" rel="noopener noreferrer">Touchlab</a> for publication by JetBrains.</em></p></section><div class="last-modified"> Last modified: 05 October 2021</div>

<div class="navigation-links _bottom"> <a class="navigation-links__prev" href="kmm-concurrency-overview">Concurrency overview</a> <a class="navigation-links__next" href="kmm-concurrency-and-coroutines">Concurrency and coroutines</a> </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://kotlinlang.org/docs/kmm-concurrent-mutability.html" class="_attribution-link" target="_blank">https://kotlinlang.org/docs/kmm-concurrent-mutability.html</a>
  </p>
</div>
