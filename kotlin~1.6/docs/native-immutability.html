<h1 data-toc="native-immutability" id="native-immutability.md">Immutability in Kotlin/Native</h1>
<p id="ff708c8">Kotlin/Native implements strict mutability checks, ensuring the important invariant that the object is either immutable or accessible from the single thread at that moment in time (<code class="code ">mutable XOR global</code>).</p>
<p id="91645933">Immutability is a runtime property in Kotlin/Native, and can be applied to an arbitrary object subgraph using the <code class="code ">kotlin.native.concurrent.freeze</code> function. It makes all the objects reachable from the given one immutable, such a transition is a one-way operation (i.e., objects cannot be unfrozen later). Some naturally immutable objects such as <code class="code ">kotlin.String</code>, <code class="code ">kotlin.Int</code>, and other primitive types, along with <code class="code ">AtomicInt</code> and <code class="code ">AtomicReference</code> are frozen by default. If a mutating operation is applied to a frozen object, an <code class="code ">InvalidMutabilityException</code> is thrown.</p>
<p id="42bc2bbd">To achieve <code class="code ">mutable XOR global</code> invariant, all globally visible state (currently, <code class="code ">object</code> singletons and enums) are automatically frozen. If object freezing is not desired, a <code class="code ">kotlin.native.ThreadLocal</code> annotation can be used, which will make the object state thread local, and so, mutable (but the changed state is not visible to other threads).</p>
<p id="bcabe367">Top level/global variables of non-primitive types are by default accessible in the main thread (i.e., the thread which initialized <em id="4193447" class="">Kotlin/Native</em> runtime first) only. Access from another thread will lead to an <code class="code ">IncorrectDereferenceException</code> being thrown. To make such variables accessible in other threads, you can use either the <code class="code ">@ThreadLocal</code> annotation, and mark the value thread local or <code class="code ">@SharedImmutable</code>, which will make the value frozen and accessible from other threads.</p>
<p id="7b2082b6">Class <code class="code ">AtomicReference</code> can be used to publish the changed frozen state to other threads, and so build patterns like shared caches.</p>
<div class="last-modified"> Last modified: 11 February 2021</div>

<div class="navigation-links _bottom"> <a class="navigation-links__prev" href="native-concurrency">Concurrency in Kotlin/Native</a> <a class="navigation-links__next" href="native-libraries">Kotlin/Native libraries</a> </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://kotlinlang.org/docs/native-immutability.html" class="_attribution-link" target="_blank">https://kotlinlang.org/docs/native-immutability.html</a>
  </p>
</div>
