<h1 data-toc="kmm-configure-sqldelight-for-data-storage" id="kmm-configure-sqldelight-for-data-storage.md">Configure SQLDelight for data storage</h1>
<p id="9f9b4187">In the world of mobile development, databases are often used for local data storage on client devices. One of the options for working with databases in Kotlin Mobile Multiplatform (<em id="300e4004" class="">KMM</em>) projects is the <a href="https://cashapp.github.io/sqldelight/" id="d240f07c" data-external="true" rel="noopener noreferrer">SQLDelight</a> library. It generates type-safe Kotlin APIs from SQL statements for various relational databases. SQLDelight also provides a multiplatform implementation of the SQLite driver. For a description of SQLDelight features and other details, see the <a href="https://cashapp.github.io/sqldelight/" id="8045c40b" data-external="true" rel="noopener noreferrer">SQLDelight documentation</a>.</p>
<p id="80d72834">In this article, we’ll show how to start using databases in your KMM project with SQLDelight:</p>
<ul class="list _ul" id="bc8812e1">
<li class="list__item" id="94318571"><p>connect SQLDelight to your project</p></li>
<li class="list__item" id="e09a86c5"><p>create a database driver</p></li>
<li class="list__item" id="b353926b"><p>perform database queries using the API generated by SQLDelight</p></li>
</ul>
<section class="chapter"><h2 id="connect-and-configure-sqldelight" data-toc="kmm-configure-sqldelight-for-data-storage#connect-and-configure-sqldelight">Connect and configure SQLDelight</h2>
<section class="chapter"><h3 id="gradle-plugin" data-toc="kmm-configure-sqldelight-for-data-storage#gradle-plugin">Gradle plugin</h3>
<p id="29fb83a9">To connect the SQLDelight plugin to a project, apply the SQLDelight Gradle plugin in your project’s build script (root <code class="code ">build.gradle</code> or <code class="code ">build.gradle.kts</code>): First, add the plugin's <code class="code ">classpath</code> to the build system:</p>
<div class="tabs" id="fb7f1a3a" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="80d4c1d4" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">buildscript { repositories { google() mavenCentral() } dependencies { classpath("com.squareup.sqldelight:gradle-plugin:$sql_delight_version") } } </pre></div>
<div class="tabs__content" data-gtm="tab" id="80cab2bc" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">buildscript { repositories { google() mavenCentral() } dependencies { classpath "com.squareup.sqldelight:gradle-plugin:$sql_delight_version" } } </pre></div>
</div>
<p id="95240f66">Instead of <code class="code ">$sql_delight_version</code>, use the version you need for your project.</p>
<p id="a4360289">Then apply the SQLDelight Gradle plugin by adding this line at the beginning of the build script (<code class="code ">build.gradle</code> or <code class="code ">build.gradle.kts</code>) in your shared multiplatform module:</p>
<div class="tabs" id="e6da191f" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="88cb5491" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">plugins { id("com.squareup.sqldelight") } </pre></div>
<div class="tabs__content" data-gtm="tab" id="8607339d" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">apply plugin: 'com.squareup.sqldelight' </pre></div>
</div></section><section class="chapter"><h3 id="database-drivers" data-toc="kmm-configure-sqldelight-for-data-storage#database-drivers">Database drivers</h3>
<section class="chapter"><h4 id="common-source-set" data-toc="kmm-configure-sqldelight-for-data-storage#common-source-set">Common source set</h4>
<p id="934b8d9b">To work with database drivers in the common code, add the following dependency to the <code class="code ">commonMain</code> source set:</p>
<div class="tabs" id="329d0b4e" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="b04a644" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">val commonMain by getting { dependencies { implementation("com.squareup.sqldelight:runtime:$sql_delight_version") } } </pre></div>
<div class="tabs__content" data-gtm="tab" id="ff646eec" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">commonMain { dependencies { implementation "com.squareup.sqldelight:runtime:$sql_delight_version" } } </pre></div>
</div></section><section class="chapter"><h4 id="android-source-sets" data-toc="kmm-configure-sqldelight-for-data-storage#android-source-sets">Android source sets</h4>
<p id="dbaf8921">To connect the SQLite database driver for Android, add the following to the <code class="code ">dependencies</code> block of the corresponding source set in the module's <code class="code ">build.gradle</code> or <code class="code ">build.gradle.kts</code>:</p>
<div class="tabs" id="b18033ab" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="5db92f3d" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">val androidMain by getting { dependencies { implementation("com.squareup.sqldelight:android-driver:$sql_delight_version") } } </pre></div>
<div class="tabs__content" data-gtm="tab" id="f2f61a4c" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">androidMain { dependencies { implementation "com.squareup.sqldelight:android-driver:$sql_delight_version" } } </pre></div>
</div></section><section class="chapter"><h4 id="ios-source-sets" data-toc="kmm-configure-sqldelight-for-data-storage#ios-source-sets">iOS source sets</h4>
<p id="30c7aa02">To connect the SQLite driver for iOS and other native platforms, add the following dependency:</p>
<div class="tabs" id="63872476" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="1f901496" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">val iosMain by getting { dependencies { implementation("com.squareup.sqldelight:native-driver:$sql_delight_version") } } </pre></div>
<div class="tabs__content" data-gtm="tab" id="efeed435" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">iosMain { dependencies { implementation "com.squareup.sqldelight:native-driver:$sql_delight_version" } } </pre></div>
</div></section></section><section class="chapter"><h3 id="configuration" data-toc="kmm-configure-sqldelight-for-data-storage#configuration">Configuration</h3>
<p id="1b6782e6">To configure the SQLDelight API generator, use the <code class="code ">sqldelight</code> top-level block of the build script. For example, to create a database named <code class="code ">AppDatabase</code> and specify the package name <code class="code ">com.example.db</code> for the generated Kotlin classes, use this configuration block:</p>
<div class="tabs" id="b0e1858" data-group="build-script">
<div class="tabs__content" data-gtm="tab" id="ca046304" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code-block" data-lang="kotlin" data-title="Kotlin" data-language="kotlin">sqldelight { database("AppDatabase") { packageName = "com.example.db" } } </pre></div>
<div class="tabs__content" data-gtm="tab" id="724e1730" data-sync-tabs="groovy" data-title="Groovy"><pre class="code-block" data-lang="groovy" data-title="Groovy" data-language="groovy">sqldelight { AppDatabase { packageName = "com.example.db" } } </pre></div>
</div>
<p id="899e6132">This SQLDelight configuration will be used for all the code examples listed below.</p>
<p id="b7e2f234">To learn what you can configure in SQLDelight and how to do it, see the <a href="https://cashapp.github.io/sqldelight/multiplatform_sqlite/gradle/" id="ddaedc5" data-external="true" rel="noopener noreferrer">SQLDelight documentation</a>.</p></section></section><section class="chapter"><h2 id="create-an-sqlite-driver" data-toc="kmm-configure-sqldelight-for-data-storage#create-an-sqlite-driver">Create an SQLite driver</h2>
<p id="729874d5">SQLDelight provides multiple platform-specific implementations of the SQLite driver, so you should create it for each platform separately. In the common code, you can refer to these drivers using the common <code class="code ">SqlDriver</code> interface.</p>
<p id="7176b30">You can create an abstract factory using <code class="code ">expect</code>/<code class="code ">actual</code> mechanism:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">expect class DatabaseDriverFactory { fun createDriver(): SqlDriver } </pre>
<p id="64fec0a9">Then provide actual implementations for this expected class:</p>
<section class="chapter"><h3 id="android-driver" data-toc="kmm-configure-sqldelight-for-data-storage#android-driver">Android driver</h3>
<p id="fdd04a5b">On Android, the SQLite driver is implemented by the <code class="code ">AndroidSqliteDriver</code> class. When you create its instance, pass the database information and the link to context to the constructor. For example, this code creates an SQLite driver for a database named <code class="code ">AppDatabase</code>:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">actual class DatabaseDriverFactory(private val context: Context) { actual fun createDriver(): SqlDriver { return AndroidSqliteDriver(AppDatabase.Schema, context, "test.db") } } </pre></section><section class="chapter"><h3 id="ios-driver" data-toc="kmm-configure-sqldelight-for-data-storage#ios-driver">iOS driver</h3>
<p id="e99e2e3c">On iOS, the SQLite driver implementation is the <code class="code ">NativeSqliteDriver</code> class:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">actual class DatabaseDriverFactory { actual fun createDriver(): SqlDriver { return NativeSqliteDriver(AppDatabase.Schema, "test.db") } } </pre>
<p id="304f5f31">Now you can create the <code class="code ">DatabaseDriverFactory</code> instance in your applications' code and pass it to the common module. Then create an <code class="code ">AppDatabase</code> instance to perform database operations:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">val database = AppDatabase(databaseDriverFactory.createDriver()) </pre>
<p id="12197e45">See the <a href="https://play.kotlinlang.org/hands-on/Networking%20and%20Data%20Storage%20with%20Kotlin%20Multiplatfrom%20Mobile/01_Introduction" id="2e17890c" data-external="true" rel="noopener noreferrer">Networking &amp; Data Storage Hands-on</a> for the full example.</p></section></section><section class="chapter"><h2 id="table-operations" data-toc="kmm-configure-sqldelight-for-data-storage#table-operations">Table operations</h2>
<p id="4dd137e1">The SQLDelight generator works as follows: you create a file with the <code class="code ">.sq</code> extension in which you provide all the required SQL queries to the database. The SQLDelight plugin generates the Kotlin code for execution of these queries. This way, SQLDelight automatically implements the interaction of your app with the database. This eliminates the need for manual implementation of entity classes and code that maps Kotlin classes onto a relational database model.</p>
<p id="96f7729a">The syntax of the SQLDelight generator lets you implement all the basic SQLite commands, including cascading, indexes, triggers, and others.</p>
<p id="d3293841">Let's look at how to declare and use basic database operations.</p>
<section class="chapter"><h3 id="create" data-toc="kmm-configure-sqldelight-for-data-storage#create">Create</h3>
<p id="563956c0">Typically, queries for creating all the necessary database tables are listed at the beginning of the <code class="code ">.sq</code> file. To create a table, use the SQL command <code class="code ">CREATE TABLE</code>. For example, this query creates a table with two fields:</p>
<pre class="code-block" data-lang="sql" data-language="sql">CREATE TABLE Language ( id INTEGER NOT NULL PRIMARY KEY, name TEXT NOT NULL ); </pre>
<p id="be8b2d65">For this query, SQLDelight generates the <code class="code ">Language</code> Kotlin interface with the specified fields. It will be used in functions that implement operations with the <code class="code ">Language</code> table.</p></section><section class="chapter"><h3 id="delete" data-toc="kmm-configure-sqldelight-for-data-storage#delete">Delete</h3>
<p id="a13bce8a">SQL's <code class="code ">DELETE</code> operator is used to delete rows from database tables. For example, to delete all records from the table, declare the following query in the <code class="code ">.sq</code> file:</p>
<pre class="code-block" data-lang="sql" data-language="sql">deleteAllLanguages: DELETE FROM Language; </pre>
<p id="e4edb7d2">The label <code class="code ">deleteAllLanguages:</code> in the first line declares the name for the Kotlin function that will execute this query.</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun deleteAllLanguages() </pre>
<p id="59cbb37c">To execute the <code class="code ">deleteAllLanguages</code> query from your code, write the following:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">val database = AppDatabase(sqlDriver) val appDatabaseQueries: AppDatabaseQueries = database.appDatabaseQueries fun deleteAllLanguages() { appDatabaseQueries.deleteAllLanguages() } </pre>
<p id="a4a842f6">You can use the <code class="code ">WHERE</code> operator to delete certain rows from a table, for example:</p>
<pre class="code-block" data-lang="sql" data-language="sql">deleteLanguageById: DELETE FROM Language WHERE id = ?; </pre>
<p id="19dfae62">SQLDelight will generate a Kotlin function with an argument:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun deleteLanguageById(id: Long) </pre>
<p id="412afdb8">To delete a specific database record with the <code class="code ">deleteLanguageById()</code> function, call it on the <code class="code ">AppDatabaseQueries</code> object and pass the <code class="code ">id</code> of the record to be deleted:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun deleteLanguageById(id: Long) { appDatabaseQueries.deleteLanguageById(id) } </pre></section><section class="chapter"><h3 id="insert" data-toc="kmm-configure-sqldelight-for-data-storage#insert">Insert</h3>
<p id="45f0dfa9">To add a data record into a table, use the SQL command <code class="code ">INSERT</code>. A query for inserting entries into the <code class="code ">Language</code> table may look like this:</p>
<pre class="code-block" data-lang="sql" data-language="sql">insertLanguage: INSERT INTO Language(id, name) VALUES(?, ?); </pre>
<p id="e57f35d0"><code class="code ">insertLanguage:</code> here defines the name of the corresponding Kotlin function that SQLDelight generates:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun insertLanguage(id: Long?, name: String) </pre>
<p id="ac7f5e0e">The function takes two arguments that match the table fields specified in the query.</p>
<p id="13ac650b">This is how you insert a new record into the table in your app’s code:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">data class SystemLanguage( val id: Long, val name: String ) val database = AppDatabase(sqlDriver) val appDatabaseQueries: AppDatabaseQueries = database.appDatabaseQueries fun insertLanguage(systemLanguage: SystemLanguage) { appDatabaseQueries.insertLanguage(systemLanguage.id, systemLanguage.name) } </pre></section><section class="chapter"><h3 id="update" data-toc="kmm-configure-sqldelight-for-data-storage#update">Update</h3>
<p id="e5a7af59">The SQL command <code class="code ">UPDATE</code> changes the values of given fields of specific rows within tables. For example, this query changes the name of the record with the provided identifier:</p>
<pre class="code-block" data-lang="sql" data-language="sql">updateLanguageName: UPDATE Language SET name = ? WHERE id = ?; </pre>
<p id="dc26f29c"><code class="code ">updateLanguageName:</code> here defines the name of the corresponding Kotlin function that SQLDelight generates:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun updateLanguageName(name: String, id: Long) </pre>
<p id="8b70050b">The function takes two arguments matching the query parameters.</p>
<p id="e3e1986b">This is how you update a record in the table in your app’s code:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">data class SystemLanguage( val id: Long, val name: String ) val database = AppDatabase(sqlDriver) val appDatabaseQueries: AppDatabaseQueries = database.appDatabaseQueries fun updateLanguageName(id: Long, newName: String) { appDatabaseQueries.updateLanguageName(newName, id) } </pre></section><section class="chapter"><h3 id="select" data-toc="kmm-configure-sqldelight-for-data-storage#select">Select</h3>
<p id="ba7221d9">To select records from tables, use the <code class="code ">SELECT</code> operator. For example, if you want to select all the records from a table, add the following query in the <code class="code ">.sq</code> file:</p>
<pre class="code-block" data-lang="sql" data-language="sql">selectAllLanguages: SELECT * FROM Language; </pre>
<p id="f96182a9">For this SQL query, SQlDelight will create the following functions:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun selectAllLanguages(): Query&lt;Language&gt; fun &lt;T : Any&gt; selectAllLanguages(mapper: (id: Long, name: String) -&gt; T): Query&lt;T&gt; </pre>
<p id="d72cecca">As you can see, the first argument in the second <code class="code ">selectAllLanguages</code> function is the <code class="code ">mapper</code> lambda that converts data from the selection into objects of an arbitrary type <code class="code ">T</code>. For example, if you need to transform the query results into entities required for the app's business logic, write the following code:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">val database = AppDatabase(sqlDriver) val appDatabaseQueries: AppDatabaseQueries = database.appDatabaseQueries data class SystemLanguage( val id: Long, val name: String ) fun selectAllLanguages(): List&lt;SystemLanguage&gt; { return appDatabaseQueries.selectAllLanguages { id: Long, name: String -&gt; SystemLanguage(id, name) }.executeAsList() } </pre>
<p id="775c28d1">Most queries include selection conditions.If you want to display a record with a specific identifier, add the following request in the <code class="code ">.sq</code> file:</p>
<pre class="code-block" data-lang="sql" data-language="sql">selectLanguageById: SELECT * FROM Language WHERE id = ?; </pre>
<p id="28cb97f7">For this query, SQLDelight will create the following functions:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun selectLanguageById(id: Long): Query&lt;Language&gt; fun &lt;T : Any&gt; selectLanguageById(id: Long, mapper: (id: Long, name: String) -&gt; T): Query&lt;T&gt; </pre>
<p id="49a8769">Similar to the above example, you can create a function that will query the database and convert the result to an object of the required data class:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun selectById(languageId: Long): SystemLanguage { return appDatabaseQueries.selectLanguageById(languageId) { id: Long, name: String -&gt; SystemLanguage(id, name) }.executeAsOne() } </pre></section></section><section class="chapter"><h2 id="transactions" data-toc="kmm-configure-sqldelight-for-data-storage#transactions">Transactions</h2>
<p id="e6cea61f">SQLDelight allows multiple SQL queries to be executed in a single transaction. For this purpose, the generated Kotlin interface with queries provides the <code class="code ">transaction</code> function for creating transactions.</p>
<p id="4b311cb5">To execute a database transaction with multiple queries, call the <code class="code ">transaction</code> function and pass the lambda with these queries. For example, the function for adding all elements of a list in a single transaction looks like this:</p>
<pre class="code-block" data-lang="kotlin" data-language="kotlin">fun insertAllLanguages(languages: List&lt;SystemLanguage&gt;) { database.appDatabaseQueries.transaction { languages.forEach { language -&gt; database.appDatabaseQueries.insertLanguage(language.id, language.name) } } } </pre></section><section class="chapter"><h2 id="sqldelight-plugin-for-android-studio" data-toc="kmm-configure-sqldelight-for-data-storage#sqldelight-plugin-for-android-studio">SQLDelight plugin for Android Studio</h2>
<p id="5be548f3">To simplify working with <code class="code ">.sq</code> generator files, SQLDelight provides a plugin for Android Studio. This plugin adds syntax highlighting, code completion, usage search, refactoring, displays compile-time errors, and much more.</p>
<p id="707456c9">To install the plugin in Android Studio, open <b id="e9650880" class="">Preferences | Plugins | Marketplace</b> and enter <b id="8fef0ec7" class="">SQLDelight</b> in the search bar.</p>
<p id="c3dfa931">For more information about the plugin, see the <a href="https://cashapp.github.io/sqldelight/multiplatform_sqlite/intellij_plugin/" id="4490a9f2" data-external="true" rel="noopener noreferrer">SQLDelight documentation</a>.</p>
<p id="fca6fc5c"><em id="d9987798" class="">We'd like to thank the <a href="http://icerockdev.com/" id="28599e29" data-external="true" rel="noopener noreferrer">IceRock team</a> for helping us write this article.</em></p></section><div class="last-modified"> Last modified: 05 October 2021</div>

<div class="navigation-links _bottom"> <a class="navigation-links__prev" href="kmm-add-dependencies">Add dependencies to KMM modules</a> <a class="navigation-links__next" href="kmm-use-ktor-for-networking">Use Ktor for networking</a> </div><div class="_attribution">
  <p class="_attribution-p">
    <a href="https://kotlinlang.org/docs/kmm-configure-sqldelight-for-data-storage.html" class="_attribution-link" target="_blank">https://kotlinlang.org/docs/kmm-configure-sqldelight-for-data-storage.html</a>
  </p>
</div>
