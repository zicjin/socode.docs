 <div class="theme-default-content content__default">
<h1 id="routing-and-code-splitting"> Routing and Code-Splitting</h1> <h2 id="routing-with-vue-router"> Routing with <code>vue-router</code>
</h2> <p>You may have noticed that our server code uses a <code>*</code> handler which accepts arbitrary URLs. This allows us to pass the visited URL into our Vue app, and reuse the same routing config for both client and server!</p> <p>It is recommended to use the official <a href="https://github.com/vuejs/vue-router-next" target="_blank" rel="noopener noreferrer">vue-router<span> <span class="sr-only">(opens new window)</span></span></a> library for this purpose. Let's first create a file where we create the router. Note that similar to application instance, we also need a fresh router instance for each request, so the file exports a <code>createRouter</code> function:</p> <div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// router.js
import { createRouter } from 'vue-router'
import MyUser from './components/MyUser.vue'

const routes = [{ path: '/user', component: MyUser }]

export default function (history) {
  return createRouter({
    history,
    routes
  })
}</pre> </div>
<p>And update our client and server entries:</p> <div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// entry-client.js
import { createSSRApp } from 'vue'
import { createWebHistory } from 'vue-router'
import createRouter from './router.js'
import App from './App.vue'

// ...

const app = createSSRApp(App)

const router = createRouter(createWebHistory())

app.use(router)

// ...</pre> </div>
<div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// entry-server.js
import { createSSRApp } from 'vue'
// server router uses a different history from the client one
import { createMemoryHistory } from 'vue-router'
import createRouter from './router.js'
import App from './App.vue'

export default function () {
  const app = createSSRApp(App)
  const router = createRouter(createMemoryHistory())

  app.use(router)

  return {
    app,
    router
  }
}</pre> </div>
<h2 id="code-splitting"> Code-Splitting</h2> <p>Code-splitting, or lazy-loading part of your app, helps reduce the size of assets that need to be downloaded by the browser for the initial render, and can greatly improve TTI (time-to-interactive) for apps with large bundles. The key is "loading just what is needed" for the initial screen.</p> <p>Vue Router provides <a href="https://next.router.vuejs.org/guide/advanced/lazy-loading.html" target="_blank" rel="noopener noreferrer">lazy-loading support<span> <span class="sr-only">(opens new window)</span></span></a>, allowing <a href="https://webpack.js.org/guides/code-splitting-async/" target="_blank" rel="noopener noreferrer">webpack to code-split at that point<span> <span class="sr-only">(opens new window)</span></span></a>. All you need to do is:</p> <div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// change this...
import MyUser from './components/MyUser.vue'
const routes = [{ path: '/user', component: MyUser }]

// to this:
const routes = [
  { path: '/user', component: () =&gt; import('./components/MyUser.vue') }
]</pre> </div>
<p>On both client and server we need to wait for the router to resolve async route components ahead of time in order to properly invoke in-component hooks. For this we will be using the <a href="https://next.router.vuejs.org/api/#isready" target="_blank" rel="noopener noreferrer">router.isReady<span> <span class="sr-only">(opens new window)</span></span></a> method. Let's update our client entry:</p> <div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// entry-client.js
import { createSSRApp } from 'vue'
import { createWebHistory } from 'vue-router'
import createRouter from './router.js'
import App from './App.vue'

const app = createSSRApp(App)

const router = createRouter(createWebHistory())

app.use(router)

router.isReady().then(() =&gt; {
  app.mount('#app')
})</pre> </div>
<p>We also need to update our <code>server.js</code> script:</p> <div class="language-js line-numbers-mode">
<pre class="language-js" data-language="javascript">// server.js
const path = require('path')

const appPath = path.join(__dirname, './dist', 'server', manifest['app.js'])
const createApp = require(appPath).default

server.get('*', async (req, res) =&gt; {
  const { app, router } = createApp()

  await router.push(req.url)
  await router.isReady()

  const appContent = await renderToString(app)

  fs.readFile(path.join(__dirname, '/dist/client/index.html'), (err, html) =&gt; {
    if (err) {
      throw err
    }

    html = html
      .toString()
      .replace('&lt;div id="app"&gt;', `&lt;div id="app"&gt;${appContent}`)
    res.setHeader('Content-Type', 'text/html')
    res.send(html)
  })
})</pre> </div>
</div>   <div class="_attribution">
  <p class="_attribution-p">
    <a href="https://v3.vuejs.org/guide/ssr/routing.html" class="_attribution-link" target="_blank">https://v3.vuejs.org/guide/ssr/routing.html</a>
  </p>
</div>
